<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>N-Grams and Markov Chains | Daniel Shiffman</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="css/main.css">
    
    
    <script src="js/jquery.js"></script>
    <script src="js/main.js"></script>
    
</head>


  <body>

    


      <link rel="stylesheet" type="text/css" href="css/prism.css">
<link rel="stylesheet" type="text/css" href="css/highlight.css">
<link rel="stylesheet" type="text/css" href="css/a2z.css">
<script src="js/blog.js"></script>
<script src="js/prism.js"></script>

<section class="left-container out a2z">
  <h1>Programming from A to Z</h1>
  <p><br/>

    <a href="index.html" class="body-link primary">about</a> 
    <a href="../A2Z-F16/README.md" class="body-link primary">syllabus</a>
    <a href="../A2Z-F16" class="body-link primary">All example source code</a>

  </p>
  <span class="line-charm first"></span>
  <div class="content-wrapper article a2z">
    <head>
<script language="javascript" type="text/javascript" src="js/p5.js"></script>
<script language="javascript" type="text/javascript" src="js/p5.dom.js"></script>
<script language="javascript" type="text/javascript" src="js/markov.js"></script>
</head>

<h2 id="n-grams-and-markov-chains">N-Grams and Markov Chains</h2>

<iframe width="525" height="300" src="https://www.youtube.com/embed/v4kL0OHuxXs?list=PLRqwX-V7Uu6ah9Oqs_BFQIbGIn1XynsVT" frameborder="0" allowfullscreen=""></iframe>

<h3 id="examples">Examples</h3>
<ul>
  <li><a href="https://shiffman.github.io/A2Z-F16/week7-markov/01_markov_bychar_short/">Markov chain generation by character (short)</a> — <a href="../A2Z-F16/week7-markov/01_markov_bychar_short">source code</a></li>
  <li><a href="https://shiffman.github.io/A2Z-F16/week7-markov/02_markov_bychar_long/">Markov chain generation by character (long)</a> — <a href="../A2Z-F16/week7-markov/02_markov_bychar_long">source code</a></li>
  <li><a href="https://shiffman.github.io/A2Z-F16/week7-markov/03_markov_byword/">Markov chain generation by word</a> — <a href="../A2Z-F16/week7-markov/03_markov_byword">source code</a></li>
  <li><a href="https://shiffman.github.io/A2Z-F16/week7-markov/04_markov_pos/">Markov chain generation by part of speech (using RiTa.js)</a> — <a href="../A2Z-F16/week7-markov/04_markov_pos">source code</a></li>
  <li><a href="https://shiffman.github.io/A2Z-F16/week7-markov/05_markov_mixer/">Markov chain two sources text</a> — <a href="../A2Z-F16/week7-markov/05_markov_mixer">source code</a></li>
  <li><a href="https://shiffman.github.io/A2Z-F16/week7-markov/06_markov_google_sheet/">Markov chain pulling data from google sheet</a> — <a href="../A2Z-F16/week7-markov/06_markov_google_sheet">source code</a></li>
  <li><a href="https://shiffman.github.io/A2Z-F16/week7-markov/07_Thesis_Project_Generator/">Markov chain pulling data from API 1 (itp thesis)</a> — <a href="../A2Z-F16/week7-markov/07_Thesis_Project_Generator">source code</a></li>
  <li><a href="https://shiffman.github.io/A2Z-F16/week7-markov/08_markov_with_api/">Markov chain pulling data from API 2 (reddit)</a> — <a href="../A2Z-F16/week7-markov/07_markov_with_api">source code</a></li>
  <li><a href="https://shiffman.github.io/A2Z-F16/week7-markov/09_markov_RiTa/">RiTa markov generator</a> — <a href="../A2Z-F16/week7-markov/09_markov_RiTa">source code</a></li>
  <li><a href="../A2Z-F16/week7-markov/10_node_markov">Markov Generation in Node</a></li>
</ul>

<h3 id="markov-projects">Markov projects</h3>
<ul>
  <li><a href="http://static.decontextualize.com/toys/next_semester">ITP Course Generator by Allison Parrish</a></li>
  <li><a href="http://www.chrisharrison.net/index.php/Visualizations/WebTrigrams">WebTrigrams by Chris Harrison</a></li>
  <li><a href="http://tinysubversions.com/gengen/">GenGen by Darius Kazemi</a></li>
  <li><a href="http://kingjamesprogramming.tumblr.com/">King James Programming</a></li>
  <li><a href="http://www.beardofbees.com/gnoetry.html">Gnoetry</a></li>
</ul>

<h3 id="related-references">Related references</h3>
<ul>
  <li><a href="http://setosa.io/blog/2014/07/26/markov-chains/">Animated Markov Chain explanation</a></li>
  <li><a href="http://www.decontextualize.com/teaching/rwet/n-grams-and-markov-chains/">N-Grams and Markov Chains by Allison Parrish</a></li>
  <li><a href="http://www.decontextualize.com/teaching/rwet/recursion-and-context-free-grammars/">Context-Free Grammars by Allison Parrish</a></li>
  <li><a href="http://www.rednoise.org/pdal/index.php?n=Main.N-Grams">N-Grams and Markov Chains by Daniel Howe</a></li>
  <li><a href="https://books.google.com/ngrams">Google N-Gram Viewer</a>, <a href="http://googleresearch.blogspot.com/2006/08/all-our-n-gram-are-belong-to-you.html">google blog post about n-grams</a></li>
  <li><a href="http://www.cs.princeton.edu/courses/archive/spr05/cos126/assignments/markov.html">Markov Models of Natural Language</a></li>
</ul>

<h3 id="exercise-ideas">Exercise ideas</h3>
<ul>
  <li>Create page that generates its content by feeding an existing text into the Markov chain algorithm.  What effect does the value of n (the “order” of the n-gram) have on the result?  <a href="http://static.decontextualize.com/toys/next_semester">Allison Parish’s ITP Course generator</a> is an excellent example.</li>
  <li>Visualize N-gram frequencies.  See <a href="http://www.chrisharrison.net/index.php/Visualizations/WebTrigrams">WebTrigrams by Chris Harrison</a> for an example.</li>
  <li>What happens if you mash-up two texts? For example, feed Shakespeare plays and ITP physical computing blog post content into the generator.  Can you modify the MarkovGenerator object to weight the input text (i.e. make shakespeare N-grams have higher probabilities?)  <a href="http://www.beardofbees.com/gnoetry.html">The Gnoetry Project</a> is a useful reference.</li>
  <li>Rework any of the example programs to use something other than text (or, at least, text that represents language) as its basic unit. For example: musical notes, songs in playlists, pixels in an image, etc.</li>
</ul>

<h3 id="n-grams-and-markov-chains-1">N-Grams and Markov Chains</h3>

<iframe width="300" height="175" src="https://www.youtube.com/embed/eGFJ8vugIWA?list=PLRqwX-V7Uu6ah9Oqs_BFQIbGIn1XynsVT" frameborder="0" allowfullscreen=""></iframe>
<iframe width="300" height="175" src="https://www.youtube.com/embed/9r8CmofnbAQ?list=PLRqwX-V7Uu6ah9Oqs_BFQIbGIn1XynsVT" frameborder="0" allowfullscreen=""></iframe>

<p>The <a href="http://en.wikipedia.org/wiki/Infinite_monkey_theorem">infinite monkey theorem</a> suggests that a monkey randomly typing at a keyboard for an infinite amount of time would eventually type the complete works of William Shakespeare.  <a href="http://natureofcode.com/book/chapter-9-the-evolution-of-code/#chapter09_section2">Working out the math to this problem</a> reveals just how insanely long this would actually take.  Even for a monkey to randomly type “to be or not to be” requires eons upon eons of time.  We can demonstrate the idea with JavaScript by generating random Strings.</p>

<p id="randomit"></p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// All of our possible characters</span>
<span class="kd">var</span> <span class="nx">possible</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOP .</span><span class="dl">'</span><span class="p">;</span>
<span class="c1">// The random String</span>
<span class="kd">var</span> <span class="nx">tobe</span> <span class="o">=</span> <span class="dl">''</span><span class="p">;</span>
<span class="c1">// Pick 18 random characters</span>
<span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">18</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
 <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">possible</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">floor</span><span class="p">(</span><span class="nx">random</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">possible</span><span class="p">.</span><span class="nx">length</span><span class="p">)));</span>
 <span class="nx">tobe</span> <span class="o">+=</span> <span class="nx">r</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">tobe</span><span class="p">);</span></code></pre></figure>

<p>Have you seen “to be or not to be” yet?  Probably not.  After all, a true monkey types totally at random, meaning there is an equal probability that any key will be pressed at any given time.  The chances are incredibly slim we’ll get an exact sequence.  But  what if we could generate our own custom probability map for a keyboard (or a sequence of word tokens)?  What kind of results could we achieve?  Let’s consider the following scenario.  What if we picked letters according to their <a href="http://en.wikipedia.org/wiki/Letter_frequency#Relative_frequencies_of_letters_in_the_English_language">actual frequency in the English language</a>?  Here’s a chart to get us started.</p>

<p style="font-size:8pt;"><a href="http://commons.wikimedia.org/wiki/File:English_letter_frequency_(alphabetic).svg#mediaviewer/File:English_letter_frequency_(alphabetic).svg"><img src="http://upload.wikimedia.org/wikipedia/commons/thumb/d/d5/English_letter_frequency_%28alphabetic%29.svg/400px-English_letter_frequency_%28alphabetic%29.svg.png" style="width:75%" alt="English letter frequency (alphabetic).svg" /></a><br /><a href="http://commons.wikimedia.org/wiki/File:English_letter_frequency_(alphabetic).svg#mediaviewer/File:English_letter_frequency_(alphabetic).svg">English letter frequency (alphabetic)</a> by <a href="https://commons.wikimedia.org/wiki/User:Nandhp" title="User:Nandhp">Nandhp</a> Licensed under Public domain via <a href="https://commons.wikimedia.org/wiki/">Wikimedia Commons</a>.</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">Letter Probability
------ -----------
a      8.167%
b      1.492%
c      2.782%
d      4.253%</code></pre></figure>

<p>How might we pick ‘a’ 8% of the time and ‘d’ 4% of the time?  Another way of stating this question might be: “How would be pick ‘a’ twice as often as ‘d’”?  While there are a variety of solutions to this sort of problem a simple one that we will employ in our examples is the following.  Imagine we had an array.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// An array of two choices</span>
<span class="kd">var</span> <span class="nx">possibilities</span> <span class="o">=</span> <span class="p">[</span><span class="dl">'</span><span class="s1">a</span><span class="dl">'</span><span class="p">,</span><span class="dl">'</span><span class="s1">d</span><span class="dl">'</span><span class="p">];</span></code></pre></figure>

<p>We could then pick one element from that array randomly as follows:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// A random integer from 0 to the end of the array</span>
<span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">floor</span><span class="p">(</span><span class="nx">random</span><span class="p">(</span><span class="nx">possibilities</span><span class="p">.</span><span class="nx">length</span><span class="p">));</span>
<span class="c1">// Get the element in that index</span>
<span class="kd">var</span> <span class="nx">pick</span> <span class="o">=</span> <span class="nx">possibilities</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span></code></pre></figure>

<p>Each element in the case of an array with two spots has a 50% chance of being picked.  But what if created the array as follows instead?</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// Two choices, but one appears twice</span>
<span class="kd">var</span> <span class="nx">possibilities</span> <span class="o">=</span> <span class="p">[</span><span class="dl">'</span><span class="s1">a</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">a</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">d</span><span class="dl">'</span><span class="p">];</span></code></pre></figure>

<p>Now when picking a random element, there is a two out of three chance of picking ‘a’.  In fact, ‘a’ is twice as likely to be picked than ‘d’.
Using <a href="https://shiffman.net/a2z/markov/letterfreq.json">all the letter frequencies found in this JSON file</a>, we could rewrite our random generator to build an array of letters, adding each letter to the array a number of times according to its frequency.</p>

<p id="randomfreq"></p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// All the possible letters</span>
<span class="kd">var</span> <span class="nx">letters</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">abcdefghijklmnopqrstuvwxyz</span><span class="dl">'</span><span class="p">;</span>
<span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">letters</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Let's assume we've loaded a JSON object</span>
    <span class="c1">// that has the probabilities for each one</span>
    <span class="kd">var</span> <span class="nx">prob</span> <span class="o">=</span> <span class="nx">json</span><span class="p">[</span><span class="nx">letters</span><span class="p">[</span><span class="nx">i</span><span class="p">]];</span>
    <span class="c1">// Arbitrarily multiplying the probability by 1,000</span>
    <span class="c1">// If the probability is 1.067% then it would be</span>
    <span class="c1">// placed in the array 1,067 times.</span>
    <span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="nx">floor</span><span class="p">(</span><span class="nx">prob</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">n</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">possibilities</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">letters</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>While we’ve probably increased the likelihood of randomly typing “to be or not to be” only slightly, we can nevertheless see how the quality of the results have changed.  e’s appear a great deal more than z’s and so on and so forth.</p>

<p>Next, let’s take this idea of custom letter probabilities another step forward and examine the frequencies of letters neighboring other letters commonly in English.  For example, how often does ‘h’ occur after ‘t’ versus ‘a’ or ‘r’ and so on and so forth?</p>

<p>This is exactly the approach of N-grams.  An n-gram is a contiguous sequence of N elements.  In the case of text, this might be N letters or N words or N phonemes or N syllables.  For an example, here’s a function that returns all word N-grams for a given String (using a regex to split the text up into tokens):</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">nGrams</span><span class="p">(</span><span class="nx">sentence</span><span class="p">,</span> <span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Split sentence up into words</span>
  <span class="kd">var</span> <span class="nx">words</span> <span class="o">=</span> <span class="nx">sentence</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="sr">/</span><span class="se">\W</span><span class="sr">+/</span><span class="p">);</span>
  <span class="c1">// Total number of n-grams we will have</span>
  <span class="kd">var</span> <span class="nx">total</span> <span class="o">=</span> <span class="nx">words</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">n</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">grams</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="c1">// Loop through and create all sequences</span>
  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;=</span> <span class="nx">total</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">seq</span> <span class="o">=</span> <span class="dl">''</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">j</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span> <span class="nx">j</span> <span class="o">&lt;</span> <span class="nx">i</span> <span class="o">+</span> <span class="nx">n</span><span class="p">;</span> <span class="nx">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">seq</span> <span class="o">+=</span> <span class="nx">words</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="o">+</span> <span class="dl">'</span><span class="s1"> </span><span class="dl">'</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// Add to array</span>
    <span class="nx">grams</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">seq</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nx">grams</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<p>Try it out below.</p>

<textarea id="ngramarea" cols="100" rows="10">Enter some text here. It was a dark and stormy night.  The quick brown fox jumped over the lazy dog.</textarea>
<p><br />
order: <select id="order">
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
      <option value="5">5</option>
      <option value="6">6</option>
    </select>
<button id="ngrambutton">show me ngrams</button></p>

<pre><code id="ngramsresult"></code></pre>

<p>Looking at all the N-grams of a given text provides a strategy for generating text.  Let’s go back to the phrase “to_be_or_not_to_be” (using an underscore instead of space for clarity).   Let’s start with the simplest possible scenario and look at all N-grams where N=1 (which is admittedly a bit silly, but will be a useful demonstration.)</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">t o _ b e _ o r _ n o t _ t o _ b e</code></pre></figure>

<p>Now, let’s look at all the possible characters that appear after t:</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">t -&gt; o
t -&gt; _
t -&gt; o</code></pre></figure>

<p>From the above we can calculate that in this (very small) piece of text, an ‘o’ follows a ‘t’ 67% of the time and a space 33%.  Now let’s look at ‘o’, where we next see a space 50% of the time, ‘r’ 25%, and ‘t’ 25%.</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">o -&gt; _
o -&gt; r
o -&gt; t
o -&gt; _</code></pre></figure>

<p>We could express this result as a JavaScript object:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// All ngrams and next characters</span>
<span class="kd">var</span> <span class="nx">ngrams</span> <span class="o">=</span> <span class="p">{</span>
  <span class="dl">'</span><span class="s1">t</span><span class="dl">'</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">o</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">_</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">o</span><span class="dl">'</span><span class="p">],</span>
  <span class="dl">'</span><span class="s1">o</span><span class="dl">'</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">_</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">r</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">t</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">_</span><span class="dl">'</span><span class="p">]</span>
<span class="p">};</span></code></pre></figure>

<p>Now, imagine we next decided to generate new text based on these probabilities.  We might start with ‘t’:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">txt</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">t</span><span class="dl">'</span><span class="p">;</span></code></pre></figure>

<p>And then pick a new character based on the array associated in the <code class="language-plaintext highlighter-rouge">ngrams</code> object.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">txt</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">t</span><span class="dl">'</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">possible</span> <span class="o">=</span> <span class="nx">ngrams</span><span class="p">[</span><span class="dl">'</span><span class="s1">t</span><span class="dl">'</span><span class="p">];</span>
<span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">floor</span><span class="p">(</span><span class="nx">random</span><span class="p">(</span><span class="nx">possible</span><span class="p">.</span><span class="nx">length</span><span class="p">));</span>
<span class="kd">var</span> <span class="nx">next</span> <span class="o">=</span> <span class="nx">possible</span><span class="p">[</span><span class="nx">r</span><span class="p">];</span>

<span class="nx">txt</span> <span class="o">=</span> <span class="nx">txt</span> <span class="o">+</span> <span class="nx">next</span><span class="p">;</span></code></pre></figure>

<p>Now repeat for the next N-gram.  And so and and so forth.  Here are some sample outcomes (and the full code for producing these):</p>

<p id="ngramtest"></p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// Our simple ngrams model</span>
<span class="kd">var</span> <span class="nx">ngrams</span> <span class="o">=</span> <span class="p">{</span>
  <span class="dl">'</span><span class="s1">t</span><span class="dl">'</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">o</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">_</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">o</span><span class="dl">'</span><span class="p">],</span>
  <span class="dl">'</span><span class="s1">o</span><span class="dl">'</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">_</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">r</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">t</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">_</span><span class="dl">'</span><span class="p">]</span>
<span class="p">};</span>

<span class="c1">// Starting text</span>
<span class="kd">var</span> <span class="nx">txt</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">t</span><span class="dl">'</span><span class="p">;</span>
<span class="c1">// Let's do the following ten times</span>
<span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">possible</span> <span class="o">=</span> <span class="nx">ngrams</span><span class="p">[</span><span class="nx">txt</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">i</span><span class="p">)];</span>
  <span class="c1">// If there is nothing in the ngrams object for this character</span>
  <span class="c1">// it's a "terminal" character and we stop</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">possible</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">// Otherwise pick a random number</span>
  <span class="kd">var</span> <span class="nx">r</span> <span class="o">=</span> <span class="nx">floor</span><span class="p">(</span><span class="nx">random</span><span class="p">(</span><span class="nx">possible</span><span class="p">.</span><span class="nx">length</span><span class="p">));</span>
  <span class="c1">// And we've got the next chararacter</span>
  <span class="kd">var</span> <span class="nx">next</span> <span class="o">=</span> <span class="nx">possible</span><span class="p">[</span><span class="nx">r</span><span class="p">];</span>
<span class="p">}</span></code></pre></figure>

<p>This technique is known as a Markov Chain.  A <a href="http://en.wikipedia.org/wiki/Markov_chain">Markov Chain</a> can be described as a sequence of random “states” where each new state is conditional only on the previous state.   An example of a Markov Chain is <a href="http://www.bewersdorff-online.de/amonopoly/">monopoly</a>.   The next state of the monopoly board depends on the current state and the roll of the dice.  It doesn’t matter how we got to that current state, only what it is at the moment.  A game like blackjack, for example, is different in that the deal of the cards is dependent on the history of many previous deals (assuming a single-deck not continuously shuffled.)</p>

<p>Using an N-gram model, can use a markov chain to generate text where each new word or character is dependent on the previous word (or character) or sequence of words (or characters).   For example. given the phrase “I have to” we might say the next word is 50% likely to be “go”, 30% likely to be “run” and 20% likely to be “pee.”  We can construct these word sequence probabilities based on a large corpus of source texts.  Here, for example, is the full set of ngrams of order 2 and their possible outcomes in the phrase: “to be or not to be, that is the question.”</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">ngrams</span> <span class="o">=</span> <span class="p">{</span>
   <span class="dl">"</span><span class="s2">to</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span> <span class="dl">"</span><span class="s2"> </span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2"> </span><span class="dl">"</span> <span class="p">],</span>
   <span class="dl">"</span><span class="s2">o </span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span> <span class="dl">"</span><span class="s2">b</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">b</span><span class="dl">"</span> <span class="p">],</span>
   <span class="dl">"</span><span class="s2"> b</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span> <span class="dl">"</span><span class="s2">e</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">e</span><span class="dl">"</span> <span class="p">],</span>
   <span class="dl">"</span><span class="s2">be</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span> <span class="dl">"</span><span class="s2"> </span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">,</span><span class="dl">"</span> <span class="p">],</span>
   <span class="dl">"</span><span class="s2">e </span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span> <span class="dl">"</span><span class="s2">o</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">q</span><span class="dl">"</span> <span class="p">],</span>
   <span class="dl">"</span><span class="s2"> o</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span> <span class="dl">"</span><span class="s2">r</span><span class="dl">"</span> <span class="p">],</span>
   <span class="dl">"</span><span class="s2">or</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span> <span class="dl">"</span><span class="s2"> </span><span class="dl">"</span> <span class="p">],</span>
   <span class="dl">"</span><span class="s2">r </span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span> <span class="dl">"</span><span class="s2">n</span><span class="dl">"</span> <span class="p">],</span>
   <span class="dl">"</span><span class="s2"> n</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span> <span class="dl">"</span><span class="s2">o</span><span class="dl">"</span> <span class="p">],</span>
   <span class="dl">"</span><span class="s2">no</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span> <span class="dl">"</span><span class="s2">t</span><span class="dl">"</span> <span class="p">],</span>
   <span class="dl">"</span><span class="s2">ot</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span> <span class="dl">"</span><span class="s2"> </span><span class="dl">"</span> <span class="p">],</span>
   <span class="dl">"</span><span class="s2">t </span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span> <span class="dl">"</span><span class="s2">t</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">i</span><span class="dl">"</span> <span class="p">],</span>
   <span class="dl">"</span><span class="s2"> t</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span> <span class="dl">"</span><span class="s2">o</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">h</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">h</span><span class="dl">"</span> <span class="p">],</span>
   <span class="dl">"</span><span class="s2">e,</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span> <span class="dl">"</span><span class="s2"> </span><span class="dl">"</span> <span class="p">],</span>
   <span class="dl">"</span><span class="s2">, </span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span> <span class="dl">"</span><span class="s2">t</span><span class="dl">"</span> <span class="p">],</span>
   <span class="dl">"</span><span class="s2">th</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span> <span class="dl">"</span><span class="s2">a</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">e</span><span class="dl">"</span> <span class="p">],</span>
   <span class="dl">"</span><span class="s2">ha</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span> <span class="dl">"</span><span class="s2">t</span><span class="dl">"</span> <span class="p">],</span>
   <span class="dl">"</span><span class="s2">at</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span> <span class="dl">"</span><span class="s2"> </span><span class="dl">"</span> <span class="p">],</span>
   <span class="dl">"</span><span class="s2"> i</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span> <span class="dl">"</span><span class="s2">s</span><span class="dl">"</span> <span class="p">],</span>
   <span class="dl">"</span><span class="s2">is</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span> <span class="dl">"</span><span class="s2"> </span><span class="dl">"</span> <span class="p">],</span>
   <span class="dl">"</span><span class="s2">s </span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span> <span class="dl">"</span><span class="s2">t</span><span class="dl">"</span> <span class="p">],</span>
   <span class="dl">"</span><span class="s2">he</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span> <span class="dl">"</span><span class="s2"> </span><span class="dl">"</span> <span class="p">],</span>
   <span class="dl">"</span><span class="s2"> q</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span> <span class="dl">"</span><span class="s2">u</span><span class="dl">"</span> <span class="p">],</span>
   <span class="dl">"</span><span class="s2">qu</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span> <span class="dl">"</span><span class="s2">e</span><span class="dl">"</span> <span class="p">],</span>
   <span class="dl">"</span><span class="s2">ue</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span> <span class="dl">"</span><span class="s2">s</span><span class="dl">"</span> <span class="p">],</span>
   <span class="dl">"</span><span class="s2">es</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span> <span class="dl">"</span><span class="s2">t</span><span class="dl">"</span> <span class="p">],</span>
   <span class="dl">"</span><span class="s2">st</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span> <span class="dl">"</span><span class="s2">i</span><span class="dl">"</span> <span class="p">],</span>
   <span class="dl">"</span><span class="s2">ti</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span> <span class="dl">"</span><span class="s2">o</span><span class="dl">"</span> <span class="p">],</span>
   <span class="dl">"</span><span class="s2">io</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span> <span class="dl">"</span><span class="s2">n</span><span class="dl">"</span> <span class="p">],</span>
   <span class="dl">"</span><span class="s2">on</span><span class="dl">"</span><span class="p">:</span> <span class="p">[</span> <span class="dl">"</span><span class="s2">.</span><span class="dl">"</span> <span class="p">]</span>
<span class="p">};</span></code></pre></figure>

<p>The process to generate the above <code class="language-plaintext highlighter-rouge">ngrams</code> object is quite similar to the <a href="http://shiffman.net/teaching/a2z/analysis/">concordance</a> we previously developed.  Only this time, instead of pairing each token with a count, we are pairing each N-gram with an array of possible next characters.  Let’s look at how this is built.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">var</span> <span class="nx">ngrams</span> <span class="o">=</span> <span class="p">{};</span>
<span class="kd">var</span> <span class="nx">text</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">to be or not to be, that is the question</span><span class="dl">'</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">n</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="c1">// Look at all characters of the String</span>
<span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">text</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">n</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Look at an ngram</span>
  <span class="kd">var</span> <span class="nx">gram</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">i</span> <span class="o">+</span> <span class="nx">n</span><span class="p">);</span>
  <span class="c1">// Look at the next charaacter</span>
  <span class="kd">var</span> <span class="nx">next</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="nx">n</span><span class="p">);</span>
  <span class="c1">// Is this a new one, make an empty array</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">ngrams</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">gram</span><span class="p">))</span> <span class="p">{</span>
    <span class="nx">ngrams</span><span class="p">[</span><span class="nx">gram</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="p">}</span>
  <span class="c1">// Add the next character as a possible outcome</span>
  <span class="nx">ngrams</span><span class="p">[</span><span class="nx">gram</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">next</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>A small difference from the concordance you might notice above is the use of <code class="language-plaintext highlighter-rouge">hasOwnProperty()</code> which is a universal object method in JavaScript that allows you to test if a variable is a property of the object or not.  Last week, we said <code class="language-plaintext highlighter-rouge">if (ngrams[gram] === undefined)</code>.  Both are valid strategies.</p>

<p>Once we’ve got the <code class="language-plaintext highlighter-rouge">ngrams</code> object with all possibities mapped out we can start to generate text.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// Start with an arbitrary ngram</span>
<span class="kd">var</span> <span class="nx">current</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">to</span><span class="dl">'</span><span class="p">;</span>
<span class="c1">// The final text</span>
<span class="kd">var</span> <span class="nx">output</span> <span class="o">=</span> <span class="nx">current</span><span class="p">;</span>

<span class="c1">// Generate a new character some number of times</span>
<span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// If this is a valid ngram</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">ngrams</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">current</span><span class="p">))</span> <span class="p">{</span>
    <span class="c1">// What are all the possible next tokens</span>
    <span class="kd">var</span> <span class="nx">possible</span> <span class="o">=</span> <span class="nx">ngrams</span><span class="p">[</span><span class="nx">current</span><span class="p">];</span>
    <span class="c1">// Pick one randomly</span>
    <span class="kd">var</span> <span class="nx">next</span> <span class="o">=</span> <span class="nx">choice</span><span class="p">(</span><span class="nx">possible</span><span class="p">);</span>
    <span class="c1">// Add to the output</span>
    <span class="nx">output</span> <span class="o">+=</span> <span class="nx">next</span><span class="p">;</span>
    <span class="c1">// Get the last N entries of the output; we'll use this to look up</span>
    <span class="c1">// an ngram in the next iteration of the loop</span>
    <span class="nx">current</span> <span class="o">=</span> <span class="nx">output</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">output</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="nx">n</span><span class="p">,</span> <span class="nx">output</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>You might notice the <code class="language-plaintext highlighter-rouge">choice()</code> function above.  Just about all of our examples require the ability to pick a random element from an array over and over.  To simplify this process, I’m emulating the <a href="https://docs.python.org/2/library/random.html?highlight=choice#random.choice">python choice()</a> function.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kd">function</span> <span class="nx">choice</span><span class="p">(</span><span class="nx">somelist</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="nx">floor</span><span class="p">(</span><span class="nx">random</span><span class="p">(</span><span class="nx">somelist</span><span class="p">.</span><span class="nx">length</span><span class="p">));</span>
  <span class="k">return</span> <span class="nx">somelist</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
<span class="p">}</span></code></pre></figure>

<p>In the examples, you’ll find <a href="https://github.com/shiffman/Programming-from-A-to-Z-F14/blob/master/week4_generate/01_markov/01_markov_bychar_short/markov.js">all of the above packaged into a MarkovGenerator object</a>.  Special thanks to <a href="https://github.com/aparrish/rwet-examples">Allison Parish’s excellent RWET examples</a> which this is modeled after.</p>

<iframe width="525" height="300" src="https://www.youtube.com/embed/aq9Wf7F5e84?list=PLRqwX-V7Uu6ah9Oqs_BFQIbGIn1XynsVT" frameborder="0" allowfullscreen=""></iframe>

  </div>
</section>
<button class="mobile-quick-links" aria-controls="quicklinks-section" aria-haspopup="true" id="quicklinks-btn">VIEW QUICK LINKS</button>
<aside class="right-container quick-links out" id="quicklinks-section">
  <div class="quick-link">
    <a href="index.html" class="secondary">About the course</a>
  </div>
  <h3>Tutorials</h3>
  <div class="quick-link">
    <a href="intro.html" class="secondary">Introduction - p5.js, JavaScript, and Strings</a>
  </div>
  <div class="quick-link">
    <a href="regex.html" class="secondary">Regular Expressions</a>
  </div>
  <div class="quick-link">
    <a href="closures.html" class="secondary">Closures</a>
  </div>
  <div class="quick-link">
    <a href="data-apis.html" class="secondary">Libraries, Data, and APIs</a>
  </div>
  <div class="quick-link">
    <a href="server-node.html" class="secondary">Server-side programming with node.js</a>
  </div>
  <div class="quick-link">
    <a href="twitter-bots.html" class="secondary">Twitter API and bots with node.js</a>
  </div>
  <div class="quick-link">
    <a href="bot-ec2.html" class="secondary">Deploy Bot to Amazon EC2</a>
  </div>
  <div class="quick-link">
    <a href="bot-heroku.html" class="secondary">Deploy Bot to Heroku</a>
  </div>
  <div class="quick-link">
    <a href="text-analysis.html" class="secondary">Text Analysis</a>
  </div>
  <div class="quick-link">
    <a href="markov.html" class="secondary">N-Grams and Markov Chains</a>
  </div>
  <div class="quick-link">
    <a href="cfg.html" class="secondary">Context-Free Grammar</a>
  </div>
  <div class="quick-link">
    <a href="node-api.html" class="secondary">Creating an API in Node</a>
  </div>
  <div class="quick-link">
    <a href="firebase.html" class="secondary">Database as Service: Firebase</a>
  </div>
  <div class="quick-link">
    <a href="chrome-ext.html" class="secondary">Chrome Extensions</a>
  </div>
</aside>


    <footer class="left-container about out">
    <div class="content-wrapper article">
        <p>Source code for this website can be found on <a href="https://github.com/shiffman/shiffman.net/" target="_blank">Github</a>.</p>
    </div>
</footer>


<script>

  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-94163-1', 'auto');
  ga('send', 'pageview');

</script>

  </body>

</html>
