<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>The Nature of Code</title>
	<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
	<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
	<script type="text/javascript" src="javascripts/codeprocessing.js"></script>
	<script type="text/javascript" src="processingjs/processing.js"></script>
  <script type="text/javascript" src="processingjs/lazyloading.js"></script>
  <script type="text/javascript" src="javascripts/sketchControls.js"></script>
  <script type="text/javascript" src="javascripts/jquery.fixed.js"></script>

  <script type="text/javascript" charset="utf-8">
    $(document).ready(function(){
      $('#toc-list').fixed({'top':'8'});
      $('#nav-bar-wrap').fixed({'top':'8'});

      $('span.c1').each(function(){ addStylesToCodeLines($(this)); });
      // $('code').each(function(){ inlineComments($(this)); });
      $('div.source-code').each(function(){ setRawCodeHeight($(this)); });
      $('a.toggle').click(function(){ toggleCodeDisplay($(this)); return false; });
    });
  </script>
	<link rel="stylesheet" href="stylesheets/fonts.css" type="text/css">
	<link rel="stylesheet" href="stylesheets/html.css" type="text/css">
	<link rel="stylesheet" href="stylesheets/code-html.css">

<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-34673170-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

<script>

    window.onload= function() {
      offsetUps = document.getElementsByClassName('offset-up');
      for(var i=0; i < offsetUps.length; i++) {
        var element = offsetUps[i];
        var comment = element.getElementsByClassName('code-comment')[0];
        var height = comment.offsetHeight;
        comment.style.top = '-' + (height) +  'px';
      }
    };
</script>

</head>
<body>

  <div id="navigator">
    <div id="navigator-inner">
      <div id='nav-bar-wrap'>
        <div id="mask"></div>
        <div id="nav-bar">
          <h1><a href="../index.html">THE <strong>NATURE</strong> OF CODE</a></h1>
          <h2>by Daniel Shiffman</h2>
          <a id="purchase-link" href="../index.html">Buy this book in print</a> <a id="purchase-link" href="../index.html">Buy this book as PDF</a>
        </div>
      </div>
      <div id="toc-holder">
        <div id="toc-list">
          <ul>
            <li><a href="../book.html">Welcome</a></li>
            <li><a href="acknowledgments.html">Acknowledgments</a></li>
            <li><a href="dedication.html">Dedication</a></li>
            <li><a href="preface.html">Preface</a></li>
            <li><a href="introduction.html">Introduction</a></li>
            <li><a href="chapter-1-vectors.html">1.  Vectors</a></li>
            <li><a href="chapter-2-forces.html">2.  Forces</a></li>
            <li><a href="chapter-3-oscillation.html">3.  Oscillation</a></li>
            <li><a href="chapter-4-particle-systems.html">4.  Particle Systems</a></li>
            <li><a href="chapter-5-physics-libraries.html">5.  Physics Libraries</a></li>
            <li><a href="chapter-6-autonomous-agents.html">6.  Autonomous Agents</a></li>
            <li><a href="chapter-7-cellular-automata.html">7.  Cellular Automata</a></li>
            <li><a href="chapter-8-fractals.html">8.  Fractals</a></li>
            <li><a href="chapter-9-the-evolution-of-code.html">9.  The Evolution of Code</a></li>
            <li><a href="chapter-10-neural-networks.html">10.  Neural Networks</a></li>
            <li><a href="further-reading.html">Further Reading</a></li>
            <li><a href="index.html">Index</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <div id="top">
    <div id="header">
      <h1><a href="../index.html">The <strong>Nature</strong> of Code</a></h1>
      <h2>Daniel Shiffman</h2>
    </div>
  </div>

  <div id="middle">

  	<div id="container">
  		<a id="_chapter_6_autonomous_agents" style="display: block;"></a><h2 id="chapter-6-autonomous-agents">Chapter 6.  Autonomous Agents</h2>
<blockquote >
  “This is an exercise in fictional science, or science fiction, if you like that better.”
  
    <span class="attribution">
— Valentino Braitenberg
</span>
  
</blockquote><p><a id="autonomous-agents-829e1ad0-253f-0130-bc82-7cd1c3f718ad" style="display: block;"></a><a id="natural-phenomenaautonomous-agents-829e2c40-253f-0130-bc83-7cd1c3f718ad" style="display: block;"></a></p>
<p>Believe it or not, there is a purpose.  Well, at least there’s a purpose to the first five chapters of this book.  We could stop right here; after all, we’ve looked at several different ways of modeling motion and simulating physics.  Angry Birds, here we come!</p>
<p>Still, let’s think for a moment.  Why are we here?   The <em>nature</em> of code, right?   What have we been designing so far?   Inanimate objects.  Lifeless shapes sitting on our screens that flop around when affected by forces in their environment.   What if we could breathe life into those shapes? What if those shapes could live by their own rules?  Can shapes have hopes and dreams and fears?   This is what we are here in this chapter to do—develop <em>autonomous agents</em>.</p>
<section><a id="chapter06_section1" style="display: block;"></a><h3 id="61-forces-from-within">6.1  Forces from Within</h3><p><a id="forcesautonomous-agents-and-829e5fb0-253f-0130-bc84-7cd1c3f718ad" style="display: block;"></a></p>
<p>The term <strong><em>autonomous agent</em></strong> generally refers to an entity that makes its own choices about how to act in its environment without any influence from a leader or global plan.  For us, “acting” will mean moving.   This addition is a significant conceptual leap.  Instead of a box sitting on a boundary waiting to be pushed by another falling box, we are now going to design a box that has the ability and “desire” to leap out of the way of that other falling box, if it so chooses.   While the concept of forces that come from within is a major shift in our design thinking, our code base will barely change, as these desires and actions are simply that—<em>forces</em>.</p>
<p>Here are three key components of autonomous agents that we’ll want to keep in mind as we build our examples.</p>
<p><a id="autonomous-agentskey-components-of-829e8720-253f-0130-bc85-7cd1c3f718ad" style="display: block;"></a></p>
<div class="list">
	
	<ul>
		
			<li><p><strong>An autonomous agent has a <em>limited</em> ability to perceive environment.</strong>   It makes sense that a living, breathing being should have an awareness of its environment.  What does this mean for us, however?   As we look at examples in this chapter, we will point out programming techniques for allowing objects to store references to other objects and therefore “perceive” their environment.    It’s also crucial that we consider the word <em>limited</em> here.  Are we designing an all-knowing rectangle that flies around a Processing window, aware of everything else in that window?  Or are we creating a shape that can only examine any other object within fifteen pixels of itself?   Of course, there is no right answer to this question; it all depends.  We’ll explore some possibilities as we move forward.  For a simulation to feel more “natural,” however, limitations are a good thing.  An insect, for example, may only be aware of the sights and smells that immediately surround it.   For a real-world creature, we could study the exact science of these limitations.   Luckily for us, we can just make stuff up and try it out.
</p>
</li>
		
			<li><p><strong>An autonomous agent processes the information from its environment and calculates an action.</strong>    This will be the easy part for us, as the action is a force.  The environment might tell the agent that there’s a big scary-looking shark swimming right at it, and the action will be a powerful force in the opposite direction.
</p>
</li>
		
			<li><p><strong>An autonomous agent has no leader.</strong>  This third principle is something we care a little less about.  After all, if you are designing a system where it makes sense to have a leader barking commands at various entities, then that’s what you’ll want to implement.  Nevertheless, many of these examples will have no leader for an important reason.   As we get to the end of this chapter and examine group behaviors, we will look at designing collections of autonomous agents that exhibit the properties of complex systems— intelligent and structured group dynamics that emerge not from a leader, but from the local interactions of the elements themselves.
</p>
</li>
		
	</ul>
</div><p><a id="boids-model-829ec500-253f-0130-bc86-7cd1c3f718ad" style="display: block;"></a><a id="reynolds-craig-829ed810-253f-0130-bc87-7cd1c3f718ad" style="display: block;"></a></p>
<p>In the late 1980s, computer scientist <a href="http://www.red3d.com/cwr/">Craig Reynolds</a> developed algorithmic steering behaviors for animated characters. These behaviors allowed individual elements to navigate their digital environments in a “lifelike” manner with strategies for fleeing, wandering, arriving, pursuing, evading, etc. Used in the case of a single autonomous agent, these behaviors are fairly simple to understand and implement. In addition, by building a system of multiple characters that steer themselves according to simple, locally based rules, surprising levels of complexity emerge.  The most famous example is Reynolds’s “boids” model for “flocking/swarming” behavior.</p>
</section><section><a id="chapter06_section2" style="display: block;"></a><h3 id="62-vehicles-and-steering">6.2  Vehicles and Steering</h3><p><a id="turtles-termites-and-traffic-jams-resnick-829f0260-253f-0130-bc88-7cd1c3f718ad" style="display: block;"></a><a id="resnick-mitchel-829f1750-253f-0130-bc89-7cd1c3f718ad" style="display: block;"></a></p>
<p>Now that we understand the core concepts behind autonomous agents, we can begin writing the code.  There are many places where  we could start. Artificial simulations of ant and termite colonies are fantastic demonstrations of systems of autonomous agents. (For more on this topic, I encourage you to read <em>Turtles, Termites, and Traffic Jams</em> by Mitchel Resnick.)  However, we want to begin by examining agent behaviors that build on the work we’ve done in the first five chapters of this book: modeling motion with vectors and driving motion with forces.  And so it’s time to rename our <span class="klass">Mover</span> class that became our <span class="klass">Particle</span> class once again.  This time we are going to call it <span class="klass">Vehicle</span>.</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>class Vehicle {

  PVector location;
  PVector velocity;
  PVector acceleration;

  // What else do we need to add?</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'><span class="kd">class</span> <span class="nc">Vehicle</span> <span class="o">{</span></span>
<span class='one-line'> </span>
<span class='one-line'>  <span class="n">PVector</span> <span class="n">location</span><span class="o">;</span></span>
<span class='one-line'>  <span class="n">PVector</span> <span class="n">velocity</span><span class="o">;</span></span>
<span class='one-line'>  <span class="n">PVector</span> <span class="n">acceleration</span><span class="o">;</span></span>
<span class='one-line'> </span>
<span class='one-line'>  <span class="c1">// What else do we need to add?</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p><a id="steering-behaviors-for-autonomous-characters-reynolds-829f4b10-253f-0130-bc8a-7cd1c3f718ad" style="display: block;"></a></p>
<p>In his 1999 paper “Steering Behaviors for Autonomous Characters,” Reynolds uses the word “vehicle” to describe his autonomous agents, so we will follow suit.</p>
<p><a id="vehicles-experiments-in-synthetic-psychology-braitenberg-829f5de0-253f-0130-bc8b-7cd1c3f718ad" style="display: block;"></a><a id="braitenberg-valentino-829f7040-253f-0130-bc8c-7cd1c3f718ad" style="display: block;"></a></p>
<div class="note">
  <h4 id="why-vehicle">Why Vehicle?</h4><p>In 1986, Italian neuroscientist and cyberneticist Valentino Braitenberg described a series of hypothetical vehicles with simple internal structures in his book <em>Vehicles: Experiments in Synthetic Psychology</em>.  Braitenberg argues that his extraordinarily simple mechanical vehicles manifest behaviors such as fear, aggression, love, foresight, and optimism.  Reynolds took his inspiration from Braitenberg, and we’ll take ours from Reynolds.</p>

</div><p>Reynolds describes the motion of <em>idealized</em> vehicles (idealized because we are not concerned with the actual engineering of such vehicles, but simply assume that they exist and will respond to our rules) as a series of three layers—<strong>Action Selection</strong>, <strong>Steering</strong>, and <strong>Locomotion</strong>.</p>
<p><a id="action-selection-829fa830-253f-0130-bc8d-7cd1c3f718ad" style="display: block;"></a><a id="autonomous-agentsaction-selection-829fb810-253f-0130-bc8e-7cd1c3f718ad" style="display: block;"></a><a id="autonomous-agentssteering-829fc9e0-253f-0130-bc8f-7cd1c3f718ad" style="display: block;"></a><a id="steering-force-829fdc20-253f-0130-bc90-7cd1c3f718ad" style="display: block;"></a></p>
<div class="list">
	
	<ol class="arabic">
		
			<li><p><strong><em>Action Selection.</em></strong>   A vehicle has a goal (or goals) and can select an action (or a combination of actions) based on that goal.  This is essentially where we left off with autonomous agents.  The vehicle takes a look at its environment and calculates an action based on a desire: “I see a zombie marching towards me. Since I don’t want my brains to be eaten, I’m going to flee from the zombie.”   The goal is to keep one’s brains and the action is to flee.   Reynolds’s paper describes many goals and associated actions such as: seek a target, avoid an obstacle, and follow a path.  In a moment, we’ll start building these examples out with Processing code.
</p>
</li>
		
			<li><p><strong><em>Steering.</em></strong>  Once an action has been selected, the vehicle has to calculate its next move.  For us, the next move will be a force; more specifically, a steering force.  Luckily, Reynolds has developed a simple steering force formula that we’ll use throughout the examples in this chapter: <strong><em>steering force = desired velocity - current velocity</em></strong>.  We’ll get into the details of this formula and why it works so effectively in the next section.
</p>
</li>
		
			<li><p><strong><em>Locomotion.</em></strong>  For the most part, we’re going to ignore this third layer.   In the case of fleeing zombies, the locomotion could be described as “left foot, right foot, left foot, right foot, as fast as you can.”   In our Processing world, however, a rectangle or circle or triangle’s actual movement across a window is irrelevant given that it’s all an illusion in the first place.  Nevertheless, this isn’t to say that you should ignore locomotion entirely.   You will find great value in thinking about the locomotive design of your vehicle and how you choose to animate it.   The examples in this chapter will remain visually bare, and a good exercise would be to elaborate on the animation style —could you add spinning wheels or oscillating paddles or shuffling legs?
</p>
</li>
		
	</ol>
</div><p><a id="autonomous-agentslocomotion-82a02260-253f-0130-bc91-7cd1c3f718ad" style="display: block;"></a><a id="locomotion-82a03760-253f-0130-bc92-7cd1c3f718ad" style="display: block;"></a></p>
<p>Ultimately, the most important layer for you to consider is #1—<em>Action Selection</em>.  What are the elements of your system and what are their goals?  In this chapter, we are going to look at a series of steering behaviors (i.e. actions): seek, flee, follow a path, follow a flow field, flock with your neighbors, etc.   It’s important to realize, however, that the point of understanding how to write the code for these behaviors is not because you should use them in all of your projects.  Rather, these are a set of building blocks, a foundation from which you can design and develop vehicles with creative goals and new and exciting behaviors.   And even though we will think literally in this chapter (follow that pixel!), you should allow yourself to think more abstractly (like Braitenberg). What would it mean for your vehicle to have “love” or “fear” as its goal, its driving force?    Finally (and we’ll address this later in the chapter), you won’t get very far by developing simulations with only one action.  Yes, our first example will be “seek a target.”  But for you to be creative—to make these steering behaviors <em>your own</em>—it will all come down to mixing and matching multiple actions within the same vehicle.  So view these examples not as singular behaviors to be emulated, but as pieces of a larger puzzle that you will eventually assemble.</p>
</section><section><a id="chapter06_section3" style="display: block;"></a><h3 id="63-the-steering-force">6.3  The Steering Force</h3><p><a id="forcessteering-82a05d90-253f-0130-bc93-7cd1c3f718ad" style="display: block;"></a></p>
<p>We can entertain ourselves by discussing the theoretical principles behind autonomous agents and steering as much as we like, but we can’t get anywhere without first understanding the concept of a steering force. Consider the following scenario.  A vehicle moving with velocity desires to seek a target.</p>
<a id="chapter06_figure1" style="display: block;"></a><div class="image-container half-width-right" >
	
	<img src="imgs/chapter06/ch06_01.png" alt="Nature of Code Image" />
	
	<p class="caption">Figure 6.1</p>
</div>
<p>Its goal and subsequent action is to seek the target in Figure 6.1.  If you think back to Chapter 2, you might begin by making the target an attractor and apply a gravitational force that pulls the vehicle to the target.  This would be a perfectly reasonable solution, but conceptually it’s not what we’re looking for here.   We don’t want to simply calculate a force that pushes the vehicle towards its target; rather, we are asking the vehicle to make an intelligent decision to steer towards the target based on its perception of its state and environment (i.e. how fast and in what direction is it currently moving).   The vehicle should look at how it desires to move (a vector pointing to the target), compare that goal with how quickly it is currently moving (its velocity), and apply a force accordingly.</p>
<p><strong><em>steering force = desired velocity - current velocity</em></strong></p>
<p>Or as we might write in Processing:</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>PVector steer = PVector.sub(desired,velocity);</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'><span class="n">PVector</span> <span class="n">steer</span> <span class="o">=</span> <span class="n">PVector</span><span class="o">.</span><span class="na">sub</span><span class="o">(</span><span class="n">desired</span><span class="o">,</span><span class="n">velocity</span><span class="o">);</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p><a id="desired-velocity-82a08a90-253f-0130-bc94-7cd1c3f718ad" style="display: block;"></a><a id="steering-forcedesired-velocity-82a0a220-253f-0130-bc95-7cd1c3f718ad" style="display: block;"></a></p>
<p>In the above formula, velocity is no problem.  After all, we’ve got a variable for that.   However, we don’t have the <em>desired velocity</em>; this is something we have to calculate.  Let’s take a look at Figure 6.2.   If we’ve defined the vehicle’s goal as “seeking the target,” then its desired velocity is a vector that points from its current location to the target location.</p>
<a id="chapter06_figure2" style="display: block;"></a><div class="image-container " >
	
	<img src="imgs/chapter06/ch06_02.png" alt="Nature of Code Image" />
	
	<p class="caption">Figure 6.2</p>
</div>
<p>Assuming a <span class="klass">PVector</span> target, we then have:</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>PVector desired = PVector.sub(target,location);</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'><span class="n">PVector</span> <span class="n">desired</span> <span class="o">=</span> <span class="n">PVector</span><span class="o">.</span><span class="na">sub</span><span class="o">(</span><span class="n">target</span><span class="o">,</span><span class="n">location</span><span class="o">);</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>But this isn’t particularly realistic.  What if we have a very high-resolution window and the target is thousands of pixels away?  Sure, the vehicle might desire to teleport itself instantly to the target location with a massive velocity, but this won’t make for an effective animation.  What we really want to say is:</p>
<p><em>The vehicle desires to move towards the target at maximum speed.</em></p>
<p>In other words, the vector should point from location to target and with a magnitude equal to maximum speed (i.e. the fastest the vehicle can go).   So first, we need to make sure we add a variable to our <span class="klass">Vehicle</span> class that stores maximum speed.</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>class Vehicle {
  PVector location;
  PVector velocity;
  PVector acceleration;
  // Maximum speed
  float maxspeed;</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'><span class="kd">class</span> <span class="nc">Vehicle</span> <span class="o">{</span></span>
<span class='one-line'>  <span class="n">PVector</span> <span class="n">location</span><span class="o">;</span></span>
<span class='one-line'>  <span class="n">PVector</span> <span class="n">velocity</span><span class="o">;</span></span>
<span class='one-line'>  <span class="n">PVector</span> <span class="n">acceleration</span><span class="o">;</span></span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>Maximum speed</div><code><pre><span class='one-line'>  <span class="kt">float</span> <span class="n">maxspeed</span><span class="o">;</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>Then, in our desired velocity calculation, we scale according to maximum speed.</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>PVector desired = PVector.sub(target,location);
desired.normalize();
desired.mult(maxspeed);</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'><span class="n">PVector</span> <span class="n">desired</span> <span class="o">=</span> <span class="n">PVector</span><span class="o">.</span><span class="na">sub</span><span class="o">(</span><span class="n">target</span><span class="o">,</span><span class="n">location</span><span class="o">);</span></span>
<span class='one-line'><span class="n">desired</span><span class="o">.</span><span class="na">normalize</span><span class="o">();</span></span>
<span class='one-line'><span class="n">desired</span><span class="o">.</span><span class="na">mult</span><span class="o">(</span><span class="n">maxspeed</span><span class="o">);</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><a id="chapter06_figure3" style="display: block;"></a><div class="image-container " >
	
	<img src="imgs/chapter06/ch06_03.png" alt="Nature of Code Image" />
	
	<p class="caption">Figure 6.3</p>
</div>
<p>Putting this all together, we can write a function called <span class="function">seek()</span> that receives a <span class="klass">PVector</span> target and calculates a steering force towards that target.</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>  void seek(PVector target) {
    PVector desired = PVector.sub(target,location);
    desired.normalize();
    // Calculating the desired velocity
    // to target at max speed
    desired.mult(maxspeed);

    // Reynolds’s formula for steering force
    PVector steer = PVector.sub(desired,velocity);
    // Using our physics model and applying the force
    // to the object’s acceleration
    applyForce(steer);
  }</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'>  <span class="kt">void</span> <span class="nf">seek</span><span class="o">(</span><span class="n">PVector</span> <span class="n">target</span><span class="o">)</span> <span class="o">{</span></span>
<span class='one-line'>    <span class="n">PVector</span> <span class="n">desired</span> <span class="o">=</span> <span class="n">PVector</span><span class="o">.</span><span class="na">sub</span><span class="o">(</span><span class="n">target</span><span class="o">,</span><span class="n">location</span><span class="o">);</span></span>
<span class='one-line'>    <span class="n">desired</span><span class="o">.</span><span class="na">normalize</span><span class="o">();</span></span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>Calculating the desired velocity
to target at max speed</div><code><pre><span class='one-line'>    <span class="n">desired</span><span class="o">.</span><span class="na">mult</span><span class="o">(</span><span class="n">maxspeed</span><span class="o">);</span></span>
<span class='one-line'> </span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>Reynolds’s formula for steering force</div><code><pre><span class='one-line'>    <span class="n">PVector</span> <span class="n">steer</span> <span class="o">=</span> <span class="n">PVector</span><span class="o">.</span><span class="na">sub</span><span class="o">(</span><span class="n">desired</span><span class="o">,</span><span class="n">velocity</span><span class="o">);</span></span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>Using our physics model and applying the force
to the object’s acceleration</div><code><pre><span class='one-line'>    <span class="n">applyForce</span><span class="o">(</span><span class="n">steer</span><span class="o">);</span></span>
<span class='one-line'>  <span class="o">}</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>Note how in the above function we finish by passing the steering force into <span class="function">applyForce()</span>.  This assumes that we are basing this example on the foundation we built in <a href="chapter-6-autonomous-agents.html#chapter02_section2">Chapter 2</a>.  However, you could just as easily use the steering force with Box2D’s <span class="function">applyForce()</span> function or toxiclibs’ <span class="function">addForce()</span> function.</p>
<p>So why does this all work so well?  Let’s see what the steering force looks like relative to the vehicle and target locations.</p>
<a id="chapter06_figure4" style="display: block;"></a><div class="image-container " >
	
	<img src="imgs/chapter06/ch06_04.png" alt="Nature of Code Image" />
	
	<p class="caption">Figure 6.4</p>
</div>
<p>Again, notice how this is not at all the same force as gravitational attraction.  Remember one of our principles of autonomous agents: An autonomous agent has a <em>limited</em> ability to perceive its environment.  Here is that ability, subtly embedded into Reynolds’s steering formula.  If the vehicle weren’t moving at all (zero velocity), desired minus velocity would be equal to desired.  But this is not the case.  The vehicle is aware of its own velocity and its steering force compensates accordingly.   This creates a more active simulation, as the way in which the vehicle moves towards the targets depends on the way it is moving in the first place.</p>
<p><a id="steering-forcemagnitude-of-82a14130-253f-0130-bc96-7cd1c3f718ad" style="display: block;"></a></p>
<p>In all of this excitement, however, we’ve missed one last step.  What sort of vehicle is this?  Is it a super sleek race car with amazing handling?  Or a giant Mack truck that needs a lot of advance notice to turn?   A graceful panda, or a lumbering elephant?  Our example code, as it stands, has no feature to account for this variability in steering ability.   Steering ability can be controlled by limiting the magnitude of the steering force.  Let’s call that limit the “maximum force” (or <span class="var">maxforce</span> for short).  And so finally, we have:</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>class Vehicle {
  PVector location;
  PVector velocity;
  PVector acceleration;
  // Maximum speed
  float maxspeed;
  // Now we also have maximum force.
  float maxforce;</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'><span class="kd">class</span> <span class="nc">Vehicle</span> <span class="o">{</span></span>
<span class='one-line'>  <span class="n">PVector</span> <span class="n">location</span><span class="o">;</span></span>
<span class='one-line'>  <span class="n">PVector</span> <span class="n">velocity</span><span class="o">;</span></span>
<span class='one-line'>  <span class="n">PVector</span> <span class="n">acceleration</span><span class="o">;</span></span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>Maximum speed</div><code><pre><span class='one-line'>  <span class="kt">float</span> <span class="n">maxspeed</span><span class="o">;</span></span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>Now we also have maximum force.</div><code><pre><span class='one-line'>  <span class="kt">float</span> <span class="n">maxforce</span><span class="o">;</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>followed by:</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>  void seek(PVector target) {
    PVector desired = PVector.sub(target,location);
    desired.normalize();
    desired.mult(maxspeed);
    PVector steer = PVector.sub(desired,velocity);

    // Limit the magnitude of the steering force.
    steer.limit(maxforce);

    applyForce(steer);
  }</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'>  <span class="kt">void</span> <span class="nf">seek</span><span class="o">(</span><span class="n">PVector</span> <span class="n">target</span><span class="o">)</span> <span class="o">{</span></span>
<span class='one-line'>    <span class="n">PVector</span> <span class="n">desired</span> <span class="o">=</span> <span class="n">PVector</span><span class="o">.</span><span class="na">sub</span><span class="o">(</span><span class="n">target</span><span class="o">,</span><span class="n">location</span><span class="o">);</span></span>
<span class='one-line'>    <span class="n">desired</span><span class="o">.</span><span class="na">normalize</span><span class="o">();</span></span>
<span class='one-line'>    <span class="n">desired</span><span class="o">.</span><span class="na">mult</span><span class="o">(</span><span class="n">maxspeed</span><span class="o">);</span></span>
<span class='one-line'>    <span class="n">PVector</span> <span class="n">steer</span> <span class="o">=</span> <span class="n">PVector</span><span class="o">.</span><span class="na">sub</span><span class="o">(</span><span class="n">desired</span><span class="o">,</span><span class="n">velocity</span><span class="o">);</span></span>
<span class='one-line'> </span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>Limit the magnitude of the steering force.</div><code><pre><span class='one-line'>    <span class="n">steer</span><span class="o">.</span><span class="na">limit</span><span class="o">(</span><span class="n">maxforce</span><span class="o">);</span></span>
<span class='one-line'> </span>
<span class='one-line'>    <span class="n">applyForce</span><span class="o">(</span><span class="n">steer</span><span class="o">);</span></span>
<span class='one-line'>  <span class="o">}</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>Limiting the steering force brings up an important point.  We must always remember that it’s not actually our goal to get the vehicle to the target as fast as possible.  If that were the case, we would just say “location equals target” and there the vehicle would be.  Our goal, as Reynolds puts it, is to move the vehicle in a “lifelike and improvisational manner.”  We’re trying to make it appear as if the vehicle is steering its way to the target, and so it’s up to us to play with the forces and variables of the system to simulate a given behavior.  For example, a large maximum steering force would result in a very different path than a small one.  One is not inherently better or worse than the other; it depends on your desired effect.  (And of course, these values need not be fixed and could change based on other conditions.  Perhaps a vehicle has health: the higher the health, the better it can steer.)</p>
<a id="chapter06_figure5" style="display: block;"></a><div class="image-container " >
	
	<img src="imgs/chapter06/ch06_05.png" alt="Nature of Code Image" />
	
	<p class="caption">Figure 6.5</p>
</div>
<p>Here is the full <span class="klass">Vehicle</span> class, incorporating the rest of the elements from the Chapter 2 <span class="klass">Mover</span> object.</p>
<div class="image-container screenshot" >
	
	<canvas data-processing-sources="../NOC%20examples%20-%20processing/chp06/NOC_6_01_Seek/NOC_6_01_Seek.pde ../NOC%20examples%20-%20processing/chp06/NOC_6_01_Seek/Vehicle.pde" class="screenshot">
		<p>Your browser does not support the canvas tag.</p>
	</canvas>
  <div class="sketch-controls">
    <button class="reset">RESET</button>
    <button class="pause">PAUSE</button>
  </div>
	
	
</div>
<p><a id="chapter06_example1" style="display: block;"></a><span class="example">Example 6.1: Seeking a target</span></p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>class Vehicle {

  PVector location;
  PVector velocity;
  PVector acceleration;
  // Additional variable for size
  float r;
  float maxforce;
  float maxspeed;

  Vehicle(float x, float y) {
    acceleration = new PVector(0,0);
    velocity = new PVector(0,0);
    location = new PVector(x,y);
    r = 3.0;
    //[full] Arbitrary values for maxspeed and
    // force; try varying these!
    maxspeed = 4;
    maxforce = 0.1;
    //[end]
  }

  // Our standard “Euler integration” motion model
  void update() {
    velocity.add(acceleration);
    velocity.limit(maxspeed);
    location.add(velocity);
    acceleration.mult(0);
  }

  // Newton’s second law; we could divide by mass if we wanted.
  void applyForce(PVector force) {
    acceleration.add(force);
  }

  // Our seek steering force algorithm
  void seek(PVector target) {
    PVector desired = PVector.sub(target,location);
    desired.normalize();
    desired.mult(maxspeed);
    PVector steer = PVector.sub(desired,velocity);
    steer.limit(maxforce);
    applyForce(steer);
  }

  void display() {
    // Vehicle is a triangle pointing in
    // the direction of velocity; since it is drawn
    // pointing up, we rotate it an additional 90 degrees.
    float theta = velocity.heading() + PI/2;
    fill(175);
    stroke(0);
    pushMatrix();
    translate(location.x,location.y);
    rotate(theta);
    beginShape();
    vertex(0, -r*2);
    vertex(-r, r*2);
    vertex(r, r*2);
    endShape(CLOSE);
    popMatrix();
  }</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'><span class="kd">class</span> <span class="nc">Vehicle</span> <span class="o">{</span></span>
<span class='one-line'> </span>
<span class='one-line'>  <span class="n">PVector</span> <span class="n">location</span><span class="o">;</span></span>
<span class='one-line'>  <span class="n">PVector</span> <span class="n">velocity</span><span class="o">;</span></span>
<span class='one-line'>  <span class="n">PVector</span> <span class="n">acceleration</span><span class="o">;</span></span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>Additional variable for size</div><code><pre><span class='one-line'>  <span class="kt">float</span> <span class="n">r</span><span class="o">;</span></span>
<span class='one-line'>  <span class="kt">float</span> <span class="n">maxforce</span><span class="o">;</span></span>
<span class='one-line'>  <span class="kt">float</span> <span class="n">maxspeed</span><span class="o">;</span></span>
<span class='one-line'> </span>
<span class='one-line'>  <span class="n">Vehicle</span><span class="o">(</span><span class="kt">float</span> <span class="n">x</span><span class="o">,</span> <span class="kt">float</span> <span class="n">y</span><span class="o">)</span> <span class="o">{</span></span>
<span class='one-line'>    <span class="n">acceleration</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PVector</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">);</span></span>
<span class='one-line'>    <span class="n">velocity</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PVector</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">);</span></span>
<span class='one-line'>    <span class="n">location</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PVector</span><span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="n">y</span><span class="o">);</span></span>
<span class='one-line'>    <span class="n">r</span> <span class="o">=</span> <span class="mf">3.0</span><span class="o">;</span></span></pre></code></div>

  <div class='code-comment-pair stretch'><div class='code-comment stretch'> Arbitrary values for maxspeed and
force; try varying these!</div><code><pre><span class='one-line'>    <span class="n">maxspeed</span> <span class="o">=</span> <span class="mi">4</span><span class="o">;</span></span>
<span class='one-line'>    <span class="n">maxforce</span> <span class="o">=</span> <span class="mf">0.1</span><span class="o">;</span></span></pre></code><div style='position:relative;clear:both;display:block;height:1px;width:100%;'></div></div>

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'>  <span class="o">}</span></span>
<span class='one-line'> </span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>Our standard “Euler integration” motion model</div><code><pre><span class='one-line'>  <span class="kt">void</span> <span class="nf">update</span><span class="o">()</span> <span class="o">{</span></span>
<span class='one-line'>    <span class="n">velocity</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">acceleration</span><span class="o">);</span></span>
<span class='one-line'>    <span class="n">velocity</span><span class="o">.</span><span class="na">limit</span><span class="o">(</span><span class="n">maxspeed</span><span class="o">);</span></span>
<span class='one-line'>    <span class="n">location</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">velocity</span><span class="o">);</span></span>
<span class='one-line'>    <span class="n">acceleration</span><span class="o">.</span><span class="na">mult</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span></span>
<span class='one-line'>  <span class="o">}</span></span>
<span class='one-line'> </span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>Newton’s second law; we could divide by mass if we wanted.</div><code><pre><span class='one-line'>  <span class="kt">void</span> <span class="nf">applyForce</span><span class="o">(</span><span class="n">PVector</span> <span class="n">force</span><span class="o">)</span> <span class="o">{</span></span>
<span class='one-line'>    <span class="n">acceleration</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">force</span><span class="o">);</span></span>
<span class='one-line'>  <span class="o">}</span></span>
<span class='one-line'> </span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>Our seek steering force algorithm</div><code><pre><span class='one-line'>  <span class="kt">void</span> <span class="nf">seek</span><span class="o">(</span><span class="n">PVector</span> <span class="n">target</span><span class="o">)</span> <span class="o">{</span></span>
<span class='one-line'>    <span class="n">PVector</span> <span class="n">desired</span> <span class="o">=</span> <span class="n">PVector</span><span class="o">.</span><span class="na">sub</span><span class="o">(</span><span class="n">target</span><span class="o">,</span><span class="n">location</span><span class="o">);</span></span>
<span class='one-line'>    <span class="n">desired</span><span class="o">.</span><span class="na">normalize</span><span class="o">();</span></span>
<span class='one-line'>    <span class="n">desired</span><span class="o">.</span><span class="na">mult</span><span class="o">(</span><span class="n">maxspeed</span><span class="o">);</span></span>
<span class='one-line'>    <span class="n">PVector</span> <span class="n">steer</span> <span class="o">=</span> <span class="n">PVector</span><span class="o">.</span><span class="na">sub</span><span class="o">(</span><span class="n">desired</span><span class="o">,</span><span class="n">velocity</span><span class="o">);</span></span>
<span class='one-line'>    <span class="n">steer</span><span class="o">.</span><span class="na">limit</span><span class="o">(</span><span class="n">maxforce</span><span class="o">);</span></span>
<span class='one-line'>    <span class="n">applyForce</span><span class="o">(</span><span class="n">steer</span><span class="o">);</span></span>
<span class='one-line'>  <span class="o">}</span></span>
<span class='one-line'> </span>
<span class='one-line'>  <span class="kt">void</span> <span class="nf">display</span><span class="o">()</span> <span class="o">{</span></span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>Vehicle is a triangle pointing in
the direction of velocity; since it is drawn
pointing up, we rotate it an additional 90 degrees.</div><code><pre><span class='one-line'>    <span class="kt">float</span> <span class="n">theta</span> <span class="o">=</span> <span class="n">velocity</span><span class="o">.</span><span class="na">heading</span><span class="o">()</span> <span class="o">+</span> <span class="n">PI</span><span class="o">/</span><span class="mi">2</span><span class="o">;</span></span>
<span class='one-line'>    <span class="n">fill</span><span class="o">(</span><span class="mi">175</span><span class="o">);</span></span>
<span class='one-line'>    <span class="n">stroke</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span></span>
<span class='one-line'>    <span class="n">pushMatrix</span><span class="o">();</span></span>
<span class='one-line'>    <span class="n">translate</span><span class="o">(</span><span class="n">location</span><span class="o">.</span><span class="na">x</span><span class="o">,</span><span class="n">location</span><span class="o">.</span><span class="na">y</span><span class="o">);</span></span>
<span class='one-line'>    <span class="n">rotate</span><span class="o">(</span><span class="n">theta</span><span class="o">);</span></span>
<span class='one-line'>    <span class="n">beginShape</span><span class="o">();</span></span>
<span class='one-line'>    <span class="n">vertex</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="o">-</span><span class="n">r</span><span class="o">*</span><span class="mi">2</span><span class="o">);</span></span>
<span class='one-line'>    <span class="n">vertex</span><span class="o">(-</span><span class="n">r</span><span class="o">,</span> <span class="n">r</span><span class="o">*</span><span class="mi">2</span><span class="o">);</span></span>
<span class='one-line'>    <span class="n">vertex</span><span class="o">(</span><span class="n">r</span><span class="o">,</span> <span class="n">r</span><span class="o">*</span><span class="mi">2</span><span class="o">);</span></span>
<span class='one-line'>    <span class="n">endShape</span><span class="o">(</span><span class="n">CLOSE</span><span class="o">);</span></span>
<span class='one-line'>    <span class="n">popMatrix</span><span class="o">();</span></span>
<span class='one-line'>  <span class="o">}</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><div class="example">
  <a id="chapter06_exercise1" style="display: block;"></a><h4 id="exercise-61">Exercise 6.1</h4><p>Implement a “fleeing” steering behavior (desired vector is inverse of “seek”).</p>

</div><div class="example">
  <a id="chapter06_exercise2" style="display: block;"></a><h4 id="exercise-62">Exercise 6.2</h4><p>Implement seeking a moving target, often referred to as “pursuit.”  In this case, your desired vector won’t point towards the object’s current location, but rather its “future” location as extrapolated from its current velocity.   We’ll see this ability for a vehicle to “predict the future” in later examples.</p>

</div><div class="example">
  <a id="chapter06_exercise3" style="display: block;"></a><h4 id="exercise-63">Exercise 6.3</h4><p>Create a sketch where a vehicle’s maximum force and maximum speed do not remain constant, but rather vary according to environmental factors.</p>

</div></section><section><a id="chapter06_section4" style="display: block;"></a><h3 id="64-arriving-behavior">6.4  Arriving Behavior</h3><p><a id="arriving-behavior-82a1c920-253f-0130-bc97-7cd1c3f718ad" style="display: block;"></a><a id="autonomous-agentsarriving-behavior-82a1e280-253f-0130-bc98-7cd1c3f718ad" style="display: block;"></a></p>
<p>After working for a bit with the seeking behavior, you probably are asking yourself,  “What if I want my vehicle to slow down as it approaches the target?”   Before we can even begin to answer this question, we should look at the reasons behind why the seek behavior causes the vehicle to fly past the target so that it has to turn around and go back.  Let’s consider the brain of a seeking vehicle.  What is it thinking?</p>
<p>Frame 1: I want to go as fast as possible towards the target!<br />
Frame 2: I want to go as fast as possible towards the target!<br />
Frame 3: I want to go as fast as possible towards the target!<br />
Frame 4: I want to go as fast as possible towards the target!<br />
Frame 5: I want to go as fast as possible towards the target!<br />
etc.</p>
<p>The vehicle is so gosh darn excited about getting to the target that it doesn’t bother to make any intelligent decisions about its speed relative to the target’s proximity.  Whether it’s far away or very close, it always wants to go as fast as possible.</p>
<a id="chapter06_figure6" style="display: block;"></a><div class="image-container " >
	
	<img src="imgs/chapter06/ch06_06.png" alt="Nature of Code Image" />
	
	<p class="caption">Figure 6.6</p>
</div>
<p>In some cases, this is the desired behavior (if a missile is flying at a target, it should always travel at maximum speed.)  However, in many other cases (a car pulling into a parking spot, a bee landing on a flower), the vehicle’s thought process needs to consider its speed relative to the distance from its target.  For example:</p>
<p>Frame 1: I’m very far away. I want to go as fast as possible towards the target!<br />
Frame 2: I’m very far away. I want to go as fast as possible towards the target!<br />
Frame 3: I’m somewhat far away. I want to go as fast as possible towards the target!<br />
Frame 4: I’m getting close. I want to go more slowly towards the target!<br />
Frame 5: I’m almost there. I want to go very slowly towards the target!<br />
Frame 6: I’m there. I want to stop!</p>
<a id="chapter06_figure7" style="display: block;"></a><div class="image-container " >
	
	<img src="imgs/chapter06/ch06_07.png" alt="Nature of Code Image" />
	
	<p class="caption">Figure 6.7</p>
</div>
<p>How can we implement this “arriving” behavior in code?  Let’s return to our <span class="function">seek()</span> function and find the line of code where we set the magnitude of the desired velocity.</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>   PVector desired = PVector.sub(target,location);
   desired.normalize();
   desired.mult(maxspeed);</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'>   <span class="n">PVector</span> <span class="n">desired</span> <span class="o">=</span> <span class="n">PVector</span><span class="o">.</span><span class="na">sub</span><span class="o">(</span><span class="n">target</span><span class="o">,</span><span class="n">location</span><span class="o">);</span></span>
<span class='one-line'>   <span class="n">desired</span><span class="o">.</span><span class="na">normalize</span><span class="o">();</span></span>
<span class='one-line'>   <span class="n">desired</span><span class="o">.</span><span class="na">mult</span><span class="o">(</span><span class="n">maxspeed</span><span class="o">);</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>In Example 6.1, the magnitude of the desired vector is always “maximum” speed.</p>
<a id="chapter06_figure8" style="display: block;"></a><div class="image-container " >
	
	<img src="imgs/chapter06/ch06_08.png" alt="Nature of Code Image" />
	
	<p class="caption">Figure 6.8</p>
</div>
<p>What if we instead said the desired velocity is equal to half the distance?</p>
<a id="chapter06_figure9" style="display: block;"></a><div class="image-container " >
	
	<img src="imgs/chapter06/ch06_09.png" alt="Nature of Code Image" />
	
	<p class="caption">Figure 6.9</p>
</div>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>   PVector desired = PVector.sub(target,location);
   desired.div(2);</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'>   <span class="n">PVector</span> <span class="n">desired</span> <span class="o">=</span> <span class="n">PVector</span><span class="o">.</span><span class="na">sub</span><span class="o">(</span><span class="n">target</span><span class="o">,</span><span class="n">location</span><span class="o">);</span></span>
<span class='one-line'>   <span class="n">desired</span><span class="o">.</span><span class="na">div</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>While this nicely demonstrates our goal of a desired speed tied to our distance from the target, it’s not particularly reasonable.  After all, 10 pixels away is rather close and a desired speed of 5 is rather large.   Something like a desired velocity with a magnitude of 5% of the distance would work much better.</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>  PVector desired = PVector.sub(target,location);
  desired.mult(0.05);</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'>  <span class="n">PVector</span> <span class="n">desired</span> <span class="o">=</span> <span class="n">PVector</span><span class="o">.</span><span class="na">sub</span><span class="o">(</span><span class="n">target</span><span class="o">,</span><span class="n">location</span><span class="o">);</span></span>
<span class='one-line'>  <span class="n">desired</span><span class="o">.</span><span class="na">mult</span><span class="o">(</span><span class="mf">0.05</span><span class="o">);</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>Reynolds describes a more sophisticated approach.  Let’s imagine a circle around the target with a given radius.  If the vehicle is within that circle, it slows down—at the edge of the circle, its desired speed is maximum speed, and at the target itself, its desired speed is 0.</p>
<a id="chapter06_figure10" style="display: block;"></a><div class="image-container " >
	
	<img src="imgs/chapter06/ch06_10.png" alt="Nature of Code Image" />
	
	<p class="caption">Figure 6.10</p>
</div>
<p>In other words, if the distance from the target is less than r, the desired speed is between 0 and maximum speed mapped according to that distance.</p>
<div class="image-container screenshot" >
	
	<canvas data-processing-sources="../NOC%20examples%20-%20processing/chp06/NOC_6_02_Arrive/NOC_6_02_Arrive.pde ../NOC%20examples%20-%20processing/chp06/NOC_6_02_Arrive/Vehicle.pde" class="screenshot">
		<p>Your browser does not support the canvas tag.</p>
	</canvas>
  <div class="sketch-controls">
    <button class="reset">RESET</button>
    <button class="pause">PAUSE</button>
  </div>
	
	
</div>
<p><a id="chapter06_example2" style="display: block;"></a><span class="example">Example 6.2: Arrive steering behavior</span></p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>  void arrive(PVector target) {
    PVector desired = PVector.sub(target,location);

    // The distance is the magnitude of
    // the vector pointing from
    // location to target.
    float d = desired.mag();
    desired.normalize();
    // If we are closer than 100 pixels...
    if (d < 100) {
      //[full] ...set the magnitude
      // according to how close we are.
      float m = map(d,0,100,0,maxspeed);
      desired.mult(m);
      //[end]
    } else {
      // Otherwise, proceed at maximum speed.
      desired.mult(maxspeed);
    }

    // The usual steering = desired - velocity
    PVector steer = PVector.sub(desired,velocity);
    steer.limit(maxforce);
    applyForce(steer);
  }</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'>  <span class="kt">void</span> <span class="nf">arrive</span><span class="o">(</span><span class="n">PVector</span> <span class="n">target</span><span class="o">)</span> <span class="o">{</span></span>
<span class='one-line'>    <span class="n">PVector</span> <span class="n">desired</span> <span class="o">=</span> <span class="n">PVector</span><span class="o">.</span><span class="na">sub</span><span class="o">(</span><span class="n">target</span><span class="o">,</span><span class="n">location</span><span class="o">);</span></span>
<span class='one-line'> </span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>The distance is the magnitude of
the vector pointing from
location to target.</div><code><pre><span class='one-line'>    <span class="kt">float</span> <span class="n">d</span> <span class="o">=</span> <span class="n">desired</span><span class="o">.</span><span class="na">mag</span><span class="o">();</span></span>
<span class='one-line'>    <span class="n">desired</span><span class="o">.</span><span class="na">normalize</span><span class="o">();</span></span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>If we are closer than 100 pixels...</div><code><pre><span class='one-line'>    <span class="k">if</span> <span class="o">(</span><span class="n">d</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="o">)</span> <span class="o">{</span></span></pre></code></div>

  <div class='code-comment-pair stretch'><div class='code-comment stretch'> ...set the magnitude
according to how close we are.</div><code><pre><span class='one-line'>      <span class="kt">float</span> <span class="n">m</span> <span class="o">=</span> <span class="n">map</span><span class="o">(</span><span class="n">d</span><span class="o">,</span><span class="mi">0</span><span class="o">,</span><span class="mi">100</span><span class="o">,</span><span class="mi">0</span><span class="o">,</span><span class="n">maxspeed</span><span class="o">);</span></span>
<span class='one-line'>      <span class="n">desired</span><span class="o">.</span><span class="na">mult</span><span class="o">(</span><span class="n">m</span><span class="o">);</span></span></pre></code><div style='position:relative;clear:both;display:block;height:1px;width:100%;'></div></div>

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'>    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span></span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>Otherwise, proceed at maximum speed.</div><code><pre><span class='one-line'>      <span class="n">desired</span><span class="o">.</span><span class="na">mult</span><span class="o">(</span><span class="n">maxspeed</span><span class="o">);</span></span>
<span class='one-line'>    <span class="o">}</span></span>
<span class='one-line'> </span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>The usual steering = desired - velocity</div><code><pre><span class='one-line'>    <span class="n">PVector</span> <span class="n">steer</span> <span class="o">=</span> <span class="n">PVector</span><span class="o">.</span><span class="na">sub</span><span class="o">(</span><span class="n">desired</span><span class="o">,</span><span class="n">velocity</span><span class="o">);</span></span>
<span class='one-line'>    <span class="n">steer</span><span class="o">.</span><span class="na">limit</span><span class="o">(</span><span class="n">maxforce</span><span class="o">);</span></span>
<span class='one-line'>    <span class="n">applyForce</span><span class="o">(</span><span class="n">steer</span><span class="o">);</span></span>
<span class='one-line'>  <span class="o">}</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>The arrive behavior is a great demonstration of the magic of “desired minus velocity.”   Let’s examine this model again relative to how we calculated forces in earlier chapters.   In the “gravitational attraction” examples, the force always pointed directly from the object to the target (the exact direction of the desired velocity), whether the force was strong or weak.</p>
<p><a id="arriving-behaviorsteering-force-and-82a4e1e0-253f-0130-bc99-7cd1c3f718ad" style="display: block;"></a><a id="steering-forcearriving-behavior-and-82a4f430-253f-0130-bc9a-7cd1c3f718ad" style="display: block;"></a></p>
<p>The steering function, however, says: “I have the ability to perceive the environment.”  The force isn’t based on just the desired velocity, but on the desired velocity relative to the current velocity.  Only things that are alive can know their current velocity.  A box falling off a table doesn’t know it’s falling.  A cheetah chasing its prey, however, knows it is chasing.</p>
<p>The steering force, therefore, is essentially a manifestation of the current velocity’s <strong><em>error</em></strong>:  "I’m supposed to be going this fast in this direction, but I’m actually going this fast in another direction.   My error is the difference between where I want to go and where I am currently going."  Taking that error and applying it as a steering force results in more dynamic, lifelike simulations.   With gravitational attraction, you would never have a force pointing away from the target, no matter how close. But with arriving via steering, if you are moving too fast towards the target, the error would actually tell you to slow down!</p>
<a id="chapter06_figure11" style="display: block;"></a><div class="image-container " >
	
	<img src="imgs/chapter06/ch06_11.png" alt="Nature of Code Image" />
	
	<p class="caption">Figure 6.11</p>
</div>
</section><section><a id="chapter06_section5" style="display: block;"></a><h3 id="65-your-own-desires-desired-velocity">6.5 Your Own Desires: Desired Velocity</h3><p><a id="autonomous-agentsdesired-velocity-82a523d0-253f-0130-bc9b-7cd1c3f718ad" style="display: block;"></a><a id="desired-velocity-82a53500-253f-0130-bc9c-7cd1c3f718ad" style="display: block;"></a><a id="velocitydesired-for-autonomous-agents-82a545d0-253f-0130-bc9d-7cd1c3f718ad" style="display: block;"></a></p>
<p>The first two examples we’ve covered—seek and arrive—boil down to calculating a single vector for each behavior: the <em>desired</em> velocity.  And in fact, every single one of Reynolds’s steering behaviors follows this same pattern.  In this chapter, we’re going to walk through several more of Reynolds’s behaviors—flow field, path-following, flocking.  First, however, I want to emphasize again that these are <em>examples</em>—demonstrations of common steering behaviors that are useful in procedural animation.   They are not the be-all and end-all of what <em>you</em> can do.  As long as you can come up with a vector that describes a vehicle’s <em>desired</em> velocity, then you have created your own steering behavior.</p>
<p>Let’s see how Reynolds defines the desired velocity for his wandering behavior.</p>
<p><a id="wandering-behavior-reynolds-82a57510-253f-0130-bc9e-7cd1c3f718ad" style="display: block;"></a></p>
<blockquote >
“Wandering is a type of random steering which has some long term order: the steering direction on one frame is related to the steering direction on the next frame. This produces more interesting motion than, for example, simply generating a random steering direction each frame.”
<span class="attribution">
<a href="http://www.red3d.com/cwr/steer/Wander.html">—Craig Reynolds</a>
</span>
</blockquote><a id="chapter06_figure12" style="display: block;"></a><div class="image-container half-width-right" >
	
	<img src="imgs/chapter06/ch06_12.png" alt="Nature of Code Image" />
	
	<p class="caption">Figure 6.12</p>
</div>
<p><a id="steering-behaviorswandering-82a58f50-253f-0130-bc9f-7cd1c3f718ad" style="display: block;"></a></p>
<p>For Reynolds, the goal of wandering is not simply random motion, but rather a sense of moving in one direction for a little while, wandering off to the next for a little bit, and so on and so forth.  So how does Reynolds calculate a desired vector to achieve such an effect?</p>
<p>Figure 6.12 illustrates how the vehicle predicts its future location as a fixed distance in front of it (in the direction of its velocity), draws a circle with radius <span class="var">r</span> at that location, and picks a random point along the circumference of the circle.  That random point moves randomly around the circle in each frame of animation.   And that random point is the vehicle’s target, its desired vector pointing in that direction.</p>
<p>Sounds a bit absurd, right?  Or, at the very least, rather arbitrary.   In fact, this is a very clever and thoughtful solution—it uses randomness to drive a vehicle’s steering, but constrains that randomness along the path of a circle to keep the vehicle’s movement from appearing jittery, and, well, random.</p>
<p>But the seemingly random and arbitrary nature of this solution should drive home the point I’m trying to make—these are made-up behaviors inspired by real-life motion.  You can just as easily concoct some elaborate scenario to compute a desired velocity yourself.  And you should.</p>
<div class="example">
  <a id="chapter06_exercise4" style="display: block;"></a><h4 id="exercise-64">Exercise 6.4</h4><p>Write the code for Reynolds’s wandering behavior.  Use polar coordinates to calculate the vehicle’s target along a circular path.</p>
<div class="image-container screenshot" >
	
	<canvas data-processing-sources="../NOC%20examples%20-%20processing/chp06/Exercise_6_04_Wander/Exercise_6_04_Wander.pde ../NOC%20examples%20-%20processing/chp06/Exercise_6_04_Wander/Vehicle.pde" class="screenshot">
		<p>Your browser does not support the canvas tag.</p>
	</canvas>
  <div class="sketch-controls">
    <button class="reset">RESET</button>
    <button class="pause">PAUSE</button>
  </div>
	
	
</div>

</div><p>Let’s say we want to create a steering behavior called “stay within walls.”  We’ll define the desired velocity as:</p>
<p><strong><em>If a vehicle comes within a distance</em></strong> d <strong><em>of a wall, it desires to move at maximum speed in the opposite direction of the wall.</em></strong></p>
<a id="chapter06_figure13" style="display: block;"></a><div class="image-container " >
	
	<img src="imgs/chapter06/ch06_13.png" alt="Nature of Code Image" />
	
	<p class="caption">Figure 6.13</p>
</div>
<p>If we define the walls of the space as the edges of a Processing window and the distance <span class="var">d</span> as 25, the code is rather simple.</p>
<div class="image-container screenshot" >
	
	<canvas data-processing-sources="../NOC%20examples%20-%20processing/chp06/NOC_6_03_StayWithinWalls/NOC_6_03_StayWithinWalls.pde ../NOC%20examples%20-%20processing/chp06/NOC_6_03_StayWithinWalls/Vehicle.pde" class="screenshot">
		<p>Your browser does not support the canvas tag.</p>
	</canvas>
  <div class="sketch-controls">
    <button class="reset">RESET</button>
    <button class="pause">PAUSE</button>
  </div>
	
	
</div>
<p><a id="chapter06_example3" style="display: block;"></a><span class="example">Example 6.3: “Stay within walls” steering behavior</span></p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>if (location. x > 25) {
  //[offset-down] Make a desired vector that retains the y direction of
  // the vehicle but points the x direction directly away from
  // the window’s left edge.
  PVector desired = new PVector(maxspeed,velocity.y);
  PVector steer = PVector.sub(desired, velocity);
  steer.limit(maxforce);
  applyForce(steer);
}</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'><span class="k">if</span> <span class="o">(</span><span class="n">location</span><span class="o">.</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">25</span><span class="o">)</span> <span class="o">{</span></span></pre></code></div>

  <div class='code-comment-pair offset-down'><div class='code-comment '> Make a desired vector that retains the y direction of
the vehicle but points the x direction directly away from
the window’s left edge.</div><code><pre><span class='one-line'>  <span class="n">PVector</span> <span class="n">desired</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PVector</span><span class="o">(</span><span class="n">maxspeed</span><span class="o">,</span><span class="n">velocity</span><span class="o">.</span><span class="na">y</span><span class="o">);</span></span>
<span class='one-line'>  <span class="n">PVector</span> <span class="n">steer</span> <span class="o">=</span> <span class="n">PVector</span><span class="o">.</span><span class="na">sub</span><span class="o">(</span><span class="n">desired</span><span class="o">,</span> <span class="n">velocity</span><span class="o">);</span></span>
<span class='one-line'>  <span class="n">steer</span><span class="o">.</span><span class="na">limit</span><span class="o">(</span><span class="n">maxforce</span><span class="o">);</span></span>
<span class='one-line'>  <span class="n">applyForce</span><span class="o">(</span><span class="n">steer</span><span class="o">);</span></span>
<span class='one-line'><span class="o">}</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><div class="example">
  <a id="chapter06_exercise5" style="display: block;"></a><h4 id="exercise-65">Exercise 6.5</h4><p>Come up with your own arbitrary scheme for calculating a desired velocity.</p>

</div></section><section><a id="chapter06_section6" style="display: block;"></a><h3 id="66-flow-fields">6.6  Flow Fields</h3><p><a id="autonomous-agentsflow-field-following-82a60fc0-253f-0130-bca0-7cd1c3f718ad" style="display: block;"></a><a id="flow-field-following-82a621c0-253f-0130-bca1-7cd1c3f718ad" style="display: block;"></a><a id="steering-behaviorsflow-field-following-82a63a00-253f-0130-bca2-7cd1c3f718ad" style="display: block;"></a></p>
<p>Now back to the task at hand.  Let’s examine a couple more of Reynolds’s steering behaviors.  First, <strong><em>flow field following</em></strong>.  What is a flow field?   Think of your Processing window as a grid.  In each cell of the grid lives an arrow pointing in some direction—you know, a vector.   As a vehicle moves around the screen, it asks, “Hey, what arrow is beneath me?  That’s my desired velocity!”</p>
<a id="chapter06_figure14" style="display: block;"></a><div class="image-container " >
	
	<img src="imgs/chapter06/ch06_14.png" alt="Nature of Code Image" />
	
	<p class="caption">Figure 6.14</p>
</div>
<p>Reynolds’s flow field following example has the vehicle predicting its future location and following the vector at that spot, but for simplicity’s sake, we’ll have the vehicle simply look to the vector at its current location.</p>
<p><a id="arrays-2d-82a66290-253f-0130-bca3-7cd1c3f718ad" style="display: block;"></a></p>
<p>Before we can write the additional code for our <span class="klass">Vehicle</span> class, we’ll need to build a class that describes the flow field itself, the grid of vectors.   A two-dimensional array is a convenient data structure in which to store a grid of information. If you are not familiar with 2D arrays, I suggest reviewing this online Processing tutorial: <a href="http://processing.org/learning/2darray/">2D array</a>.   The 2D array is convenient because we reference each element with two indices, which we can think of as columns and rows.</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>class FlowField {

  // Declaring a 2D array of PVectors
  PVector[][] field;
  // How many columns and how many rows in the grid?
  int cols, rows;
  // Resolution of grid relative to window
  // width and height in pixels
  int resolution;</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'><span class="kd">class</span> <span class="nc">FlowField</span> <span class="o">{</span></span>
<span class='one-line'> </span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>Declaring a 2D array of PVectors</div><code><pre><span class='one-line'>  <span class="n">PVector</span><span class="o">[][]</span> <span class="n">field</span><span class="o">;</span></span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>How many columns and how many rows in the grid?</div><code><pre><span class='one-line'>  <span class="kt">int</span> <span class="n">cols</span><span class="o">,</span> <span class="n">rows</span><span class="o">;</span></span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>Resolution of grid relative to window
width and height in pixels</div><code><pre><span class='one-line'>  <span class="kt">int</span> <span class="n">resolution</span><span class="o">;</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p><a id="flow-field-followingresolution-and-82a68a40-253f-0130-bca4-7cd1c3f718ad" style="display: block;"></a><a id="resolution-flow-field-following-and-82a69da0-253f-0130-bca5-7cd1c3f718ad" style="display: block;"></a></p>
<p>Notice how we are defining a third variable called <span class="var">resolution</span> above.   What is this variable?  Let’s say we have a Processing window that is 200 pixels wide by 200 pixels high.  We could make a flow field that has a <span class="klass">PVector</span> object for every single pixel, or 40,000 <span class="klass">PVector</span>s (200 * 200).  This isn’t terribly unreasonable, but in our case, it’s overkill.  We don’t need a <span class="klass">PVector</span> for every single pixel; we can achieve the same effect by having, say, one every ten pixels (20 * 20 = 400).   We use this resolution to define the number of columns and rows based on the size of the window divided by resolution:</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>  FlowField() {
    resolution = 10;
    // Total columns equals width divided by resolution.
    cols = width/resolution;
    // Total rows equals height divided by resolution.
    rows = height/resolution;
    field = new PVector[cols][rows];
  }</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'>  <span class="n">FlowField</span><span class="o">()</span> <span class="o">{</span></span>
<span class='one-line'>    <span class="n">resolution</span> <span class="o">=</span> <span class="mi">10</span><span class="o">;</span></span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>Total columns equals width divided by resolution.</div><code><pre><span class='one-line'>    <span class="n">cols</span> <span class="o">=</span> <span class="n">width</span><span class="o">/</span><span class="n">resolution</span><span class="o">;</span></span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>Total rows equals height divided by resolution.</div><code><pre><span class='one-line'>    <span class="n">rows</span> <span class="o">=</span> <span class="n">height</span><span class="o">/</span><span class="n">resolution</span><span class="o">;</span></span>
<span class='one-line'>    <span class="n">field</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PVector</span><span class="o">[</span><span class="n">cols</span><span class="o">][</span><span class="n">rows</span><span class="o">];</span></span>
<span class='one-line'>  <span class="o">}</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p><a id="vectorsflow-fields-computing-for-82a6d430-253f-0130-bca6-7cd1c3f718ad" style="display: block;"></a></p>
<p>Now that we’ve set up the flow field’s data structures, it’s time to compute the vectors in the flow field itself.  How do we do that? However we feel like it!  Perhaps we want to have every vector in the flow field pointing to the right.</p>
<a id="chapter06_figure15" style="display: block;"></a><div class="image-container " >
	
	<img src="imgs/chapter06/ch06_15.png" alt="Nature of Code Image" />
	
	<p class="caption">Figure 6.15</p>
</div>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>//[full] Using a nested loop to hit every column
// and every row of the flow field
for (int i = 0; i < cols; i++) {
  for (int j = 0; j < rows; j++) {
  //[end]
    // Arbitrary decision to make each vector point to the right
    field[i][j] = new PVector(1,0);
  }
}</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair stretch'><div class='code-comment stretch'> Using a nested loop to hit every column
and every row of the flow field</div><code><pre><span class='one-line'><span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cols</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span></span>
<span class='one-line'>  <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">rows</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span></span></pre></code><div style='position:relative;clear:both;display:block;height:1px;width:100%;'></div></div>

  <div class='code-comment-pair '><div class='code-comment '>
Arbitrary decision to make each vector point to the right</div><code><pre><span class='one-line'>    <span class="n">field</span><span class="o">[</span><span class="n">i</span><span class="o">][</span><span class="n">j</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PVector</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">0</span><span class="o">);</span></span>
<span class='one-line'>  <span class="o">}</span></span>
<span class='one-line'><span class="o">}</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>Or perhaps we want the vectors to point in random directions.</p>
<a id="chapter06_figure16" style="display: block;"></a><div class="image-container " >
	
	<img src="imgs/chapter06/ch06_16.png" alt="Nature of Code Image" />
	
	<p class="caption">Figure 6.16</p>
</div>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>for (int i = 0; i < cols; i++) {
  for (int j = 0; j < rows; j++) {

    // A random PVector
    field[i][j] = PVector.2D();
  }
}</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'><span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cols</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span></span>
<span class='one-line'>  <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">rows</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span></span>
<span class='one-line'> </span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>A random PVector</div><code><pre><span class='one-line'>    <span class="n">field</span><span class="o">[</span><span class="n">i</span><span class="o">][</span><span class="n">j</span><span class="o">]</span> <span class="o">=</span> <span class="n">PVector</span><span class="o">.</span><span class="mi">2</span><span class="n">D</span><span class="o">();</span></span>
<span class='one-line'>  <span class="o">}</span></span>
<span class='one-line'><span class="o">}</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>What if we use 2D Perlin noise (mapped to an angle)?</p>
<p><a id="perlin-noiseflow-field-following-and-82a70290-253f-0130-bca7-7cd1c3f718ad" style="display: block;"></a></p>
<a id="chapter06_figure17" style="display: block;"></a><div class="image-container " >
	
	<img src="imgs/chapter06/ch06_17.png" alt="Nature of Code Image" />
	
	<p class="caption">Figure 6.17</p>
</div>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>float xoff = 0;
for (int i = 0; i < cols; i++) {
  float yoff = 0;
  for (int j = 0; j < rows; j++) {
    //[offset-up] Noise
    float theta = map(noise(xoff,yoff),0,1,0,TWO_PI);
    field[i][j] = new PVector(cos(theta),sin(theta));
    yoff += 0.1;
  }
  xoff += 0.1;
}</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'><span class="kt">float</span> <span class="n">xoff</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span></span>
<span class='one-line'><span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cols</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span></span>
<span class='one-line'>  <span class="kt">float</span> <span class="n">yoff</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span></span>
<span class='one-line'>  <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">rows</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span></span></pre></code></div>

  <div class='code-comment-pair offset-up'><div class='code-comment '> Noise</div><code><pre><span class='one-line'>    <span class="kt">float</span> <span class="n">theta</span> <span class="o">=</span> <span class="n">map</span><span class="o">(</span><span class="n">noise</span><span class="o">(</span><span class="n">xoff</span><span class="o">,</span><span class="n">yoff</span><span class="o">),</span><span class="mi">0</span><span class="o">,</span><span class="mi">1</span><span class="o">,</span><span class="mi">0</span><span class="o">,</span><span class="n">TWO_PI</span><span class="o">);</span></span>
<span class='one-line'>    <span class="n">field</span><span class="o">[</span><span class="n">i</span><span class="o">][</span><span class="n">j</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PVector</span><span class="o">(</span><span class="n">cos</span><span class="o">(</span><span class="n">theta</span><span class="o">),</span><span class="n">sin</span><span class="o">(</span><span class="n">theta</span><span class="o">));</span></span>
<span class='one-line'>    <span class="n">yoff</span> <span class="o">+=</span> <span class="mf">0.1</span><span class="o">;</span></span>
<span class='one-line'>  <span class="o">}</span></span>
<span class='one-line'>  <span class="n">xoff</span> <span class="o">+=</span> <span class="mf">0.1</span><span class="o">;</span></span>
<span class='one-line'><span class="o">}</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>Now we’re getting somewhere.   Flow fields can be used for simulating various effects, such as an irregular gust of wind or the meandering path of a river.  Calculating the direction of your vectors using Perlin noise is one way to achieve such an effect.  Of course, there’s no “correct” way to calculate the vectors of a flow field; it’s really up to you to decide what you’re looking to simulate.</p>
<div class="example">
  <a id="chapter06_exercise6" style="display: block;"></a><h4 id="exercise-66">Exercise 6.6</h4><p>Write the code to calculate a <span class="klass">PVector</span> at every location in the flow field that points towards the center of a window.</p>
<div class="image-container " >
	
	<img src="imgs/chapter06/ch06_exc6.png" alt="Nature of Code Image" />
	
	
</div>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>PVector v = new PVector(____________,____________);
v.______________();
field[i][j] = v;</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'><span class="n">PVector</span> <span class="n">v</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PVector</span><span class="o">(</span><span class="n">____________</span><span class="o">,</span><span class="n">____________</span><span class="o">);</span></span>
<span class='one-line'><span class="n">v</span><span class="o">.</span><span class="na">______________</span><span class="o">();</span></span>
<span class='one-line'><span class="n">field</span><span class="o">[</span><span class="n">i</span><span class="o">][</span><span class="n">j</span><span class="o">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">;</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div>
</div><p>Now that we have a two-dimensional array storing all of the flow field vectors, we need a way for a vehicle to look up its desired vector in the flow field.    Let’s say we have a vehicle that lives at a <span class="klass">PVector</span>: its location.  We first need to divide by the resolution of the grid.  For example, if the resolution is 10 and the vehicle is at <em>(100,50)</em>, we need to look up column 10 and row 5.</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>int column = int(location.x/resolution);
int row = int(location.y/resolution);</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'><span class="kt">int</span> <span class="n">column</span> <span class="o">=</span> <span class="kt">int</span><span class="o">(</span><span class="n">location</span><span class="o">.</span><span class="na">x</span><span class="o">/</span><span class="n">resolution</span><span class="o">);</span></span>
<span class='one-line'><span class="kt">int</span> <span class="n">row</span> <span class="o">=</span> <span class="kt">int</span><span class="o">(</span><span class="n">location</span><span class="o">.</span><span class="na">y</span><span class="o">/</span><span class="n">resolution</span><span class="o">);</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p><a id="constrain-function-processing-82a76500-253f-0130-bca8-7cd1c3f718ad" style="display: block;"></a></p>
<p>Because a vehicle could theoretically wander off the Processing window, it’s also useful for us to employ the <span class="function">constrain()</span> function to make sure we don’t look outside of the flow field array.  Here is a function we’ll call <span class="function">lookup()</span> that goes in the <span class="klass">FlowField</span> class—it receives a <span class="klass">PVector</span> (presumably the location of our vehicle) and returns the corresponding flow field <span class="klass">PVector</span> for that location.</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>  PVector lookup(PVector lookup) {
    //[full]
    // Using constrain()

    int column = int(constrain(lookup.x/resolution,0,cols-1));
    int row = int(constrain(lookup.y/resolution,0,rows-1));
    //[end]
    // Note the use of get() to ensure
    // we return a copy of the PVector.
    return field[column][row].get();
  }</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'>  <span class="n">PVector</span> <span class="nf">lookup</span><span class="o">(</span><span class="n">PVector</span> <span class="n">lookup</span><span class="o">)</span> <span class="o">{</span></span></pre></code></div>

  <div class='code-comment-pair stretch'><div class='code-comment stretch'>
Using constrain()</div><code><pre><span class='one-line'> </span>
<span class='one-line'>    <span class="kt">int</span> <span class="n">column</span> <span class="o">=</span> <span class="kt">int</span><span class="o">(</span><span class="n">constrain</span><span class="o">(</span><span class="n">lookup</span><span class="o">.</span><span class="na">x</span><span class="o">/</span><span class="n">resolution</span><span class="o">,</span><span class="mi">0</span><span class="o">,</span><span class="n">cols</span><span class="o">-</span><span class="mi">1</span><span class="o">));</span></span>
<span class='one-line'>    <span class="kt">int</span> <span class="n">row</span> <span class="o">=</span> <span class="kt">int</span><span class="o">(</span><span class="n">constrain</span><span class="o">(</span><span class="n">lookup</span><span class="o">.</span><span class="na">y</span><span class="o">/</span><span class="n">resolution</span><span class="o">,</span><span class="mi">0</span><span class="o">,</span><span class="n">rows</span><span class="o">-</span><span class="mi">1</span><span class="o">));</span></span></pre></code><div style='position:relative;clear:both;display:block;height:1px;width:100%;'></div></div>

  <div class='code-comment-pair '><div class='code-comment '>
Note the use of get() to ensure
we return a copy of the PVector.</div><code><pre><span class='one-line'>    <span class="k">return</span> <span class="n">field</span><span class="o">[</span><span class="n">column</span><span class="o">][</span><span class="n">row</span><span class="o">].</span><span class="na">get</span><span class="o">();</span></span>
<span class='one-line'>  <span class="o">}</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>Before we move on to the <span class="klass">Vehicle</span> class, let’s take a look at the <span class="klass">FlowField</span> class all together.</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>class FlowField {

  // A flow field is a two-dimensional array of PVectors.
  PVector[][] field;
  int cols, rows;
  int resolution;

  FlowField(int r) {
    resolution = r;
    //[full] Determine the number of columns and rows.
    cols = width/resolution;
    rows = height/resolution;
    //[end]
    field = new PVector[cols][rows];
    init();
  }

  void init() {
    float xoff = 0;
    for (int i = 0; i < cols; i++) {
      float yoff = 0;
      for (int j = 0; j < rows; j++) {
        //[offset-up] In this example, we use Perlin noise to seed the vectors.
        float theta = map(noise(xoff,yoff),0,1,0,TWO_PI);
        //[offset-down] Polar to Cartesian coordinate transformation to get x and y components of the vector
        field[i][j] = new PVector(cos(theta),sin(theta));
        yoff += 0.1;
      }
      xoff += 0.1;
    }
  }

  //[full] A function to return a PVector based on a location
  PVector lookup(PVector lookup) {

    int column = int(constrain(lookup.x/resolution,0,cols-1));
    int row = int(constrain(lookup.y/resolution,0,rows-1));
    return field[column][row].get();
  }
  //[end]
}</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'><span class="kd">class</span> <span class="nc">FlowField</span> <span class="o">{</span></span>
<span class='one-line'> </span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>A flow field is a two-dimensional array of PVectors.</div><code><pre><span class='one-line'>  <span class="n">PVector</span><span class="o">[][]</span> <span class="n">field</span><span class="o">;</span></span>
<span class='one-line'>  <span class="kt">int</span> <span class="n">cols</span><span class="o">,</span> <span class="n">rows</span><span class="o">;</span></span>
<span class='one-line'>  <span class="kt">int</span> <span class="n">resolution</span><span class="o">;</span></span>
<span class='one-line'> </span>
<span class='one-line'>  <span class="n">FlowField</span><span class="o">(</span><span class="kt">int</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span></span>
<span class='one-line'>    <span class="n">resolution</span> <span class="o">=</span> <span class="n">r</span><span class="o">;</span></span></pre></code></div>

  <div class='code-comment-pair stretch'><div class='code-comment stretch'> Determine the number of columns and rows.</div><code><pre><span class='one-line'>    <span class="n">cols</span> <span class="o">=</span> <span class="n">width</span><span class="o">/</span><span class="n">resolution</span><span class="o">;</span></span>
<span class='one-line'>    <span class="n">rows</span> <span class="o">=</span> <span class="n">height</span><span class="o">/</span><span class="n">resolution</span><span class="o">;</span></span></pre></code><div style='position:relative;clear:both;display:block;height:1px;width:100%;'></div></div>

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'>    <span class="n">field</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PVector</span><span class="o">[</span><span class="n">cols</span><span class="o">][</span><span class="n">rows</span><span class="o">];</span></span>
<span class='one-line'>    <span class="n">init</span><span class="o">();</span></span>
<span class='one-line'>  <span class="o">}</span></span>
<span class='one-line'> </span>
<span class='one-line'>  <span class="kt">void</span> <span class="nf">init</span><span class="o">()</span> <span class="o">{</span></span>
<span class='one-line'>    <span class="kt">float</span> <span class="n">xoff</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span></span>
<span class='one-line'>    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cols</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span></span>
<span class='one-line'>      <span class="kt">float</span> <span class="n">yoff</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span></span>
<span class='one-line'>      <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">rows</span><span class="o">;</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span></span></pre></code></div>

  <div class='code-comment-pair offset-up'><div class='code-comment '> In this example, we use Perlin noise to seed the vectors.</div><code><pre><span class='one-line'>        <span class="kt">float</span> <span class="n">theta</span> <span class="o">=</span> <span class="n">map</span><span class="o">(</span><span class="n">noise</span><span class="o">(</span><span class="n">xoff</span><span class="o">,</span><span class="n">yoff</span><span class="o">),</span><span class="mi">0</span><span class="o">,</span><span class="mi">1</span><span class="o">,</span><span class="mi">0</span><span class="o">,</span><span class="n">TWO_PI</span><span class="o">);</span></span></pre></code></div>

  <div class='code-comment-pair offset-down'><div class='code-comment '> Polar to Cartesian coordinate transformation to get x and y components of the vector</div><code><pre><span class='one-line'>        <span class="n">field</span><span class="o">[</span><span class="n">i</span><span class="o">][</span><span class="n">j</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PVector</span><span class="o">(</span><span class="n">cos</span><span class="o">(</span><span class="n">theta</span><span class="o">),</span><span class="n">sin</span><span class="o">(</span><span class="n">theta</span><span class="o">));</span></span>
<span class='one-line'>        <span class="n">yoff</span> <span class="o">+=</span> <span class="mf">0.1</span><span class="o">;</span></span>
<span class='one-line'>      <span class="o">}</span></span>
<span class='one-line'>      <span class="n">xoff</span> <span class="o">+=</span> <span class="mf">0.1</span><span class="o">;</span></span>
<span class='one-line'>    <span class="o">}</span></span>
<span class='one-line'>  <span class="o">}</span></span>
<span class='one-line'> </span></pre></code></div>

  <div class='code-comment-pair stretch'><div class='code-comment stretch'> A function to return a PVector based on a location</div><code><pre><span class='one-line'>  <span class="n">PVector</span> <span class="nf">lookup</span><span class="o">(</span><span class="n">PVector</span> <span class="n">lookup</span><span class="o">)</span> <span class="o">{</span></span>
<span class='one-line'> </span>
<span class='one-line'>    <span class="kt">int</span> <span class="n">column</span> <span class="o">=</span> <span class="kt">int</span><span class="o">(</span><span class="n">constrain</span><span class="o">(</span><span class="n">lookup</span><span class="o">.</span><span class="na">x</span><span class="o">/</span><span class="n">resolution</span><span class="o">,</span><span class="mi">0</span><span class="o">,</span><span class="n">cols</span><span class="o">-</span><span class="mi">1</span><span class="o">));</span></span>
<span class='one-line'>    <span class="kt">int</span> <span class="n">row</span> <span class="o">=</span> <span class="kt">int</span><span class="o">(</span><span class="n">constrain</span><span class="o">(</span><span class="n">lookup</span><span class="o">.</span><span class="na">y</span><span class="o">/</span><span class="n">resolution</span><span class="o">,</span><span class="mi">0</span><span class="o">,</span><span class="n">rows</span><span class="o">-</span><span class="mi">1</span><span class="o">));</span></span>
<span class='one-line'>    <span class="k">return</span> <span class="n">field</span><span class="o">[</span><span class="n">column</span><span class="o">][</span><span class="n">row</span><span class="o">].</span><span class="na">get</span><span class="o">();</span></span>
<span class='one-line'>  <span class="o">}</span></span></pre></code><div style='position:relative;clear:both;display:block;height:1px;width:100%;'></div></div>

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'><span class="o">}</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>So let’s assume we have a <span class="klass">FlowField</span> object called “flow”.  Using the <span class="function">lookup()</span> function above, our vehicle can then retrieve a desired vector from the flow field and use Reynolds’s rules (steering = desired - velocity) to calculate a steering force.</p>
<div class="image-container screenshot" >
	
	<canvas data-processing-sources="../NOC%20examples%20-%20processing/chp06/NOC_6_04_Flowfield/NOC_6_04_Flowfield.pde ../NOC%20examples%20-%20processing/chp06/NOC_6_04_Flowfield/Flowfield.pde ../NOC%20examples%20-%20processing/chp06/NOC_6_04_Flowfield/Vehicle.pde" class="screenshot">
		<p>Your browser does not support the canvas tag.</p>
	</canvas>
  <div class="sketch-controls">
    <button class="reset">RESET</button>
    <button class="pause">PAUSE</button>
  </div>
	
	
</div>
<p><a id="chapter06_example4" style="display: block;"></a><span class="example">Example 6.4: Flow field following</span></p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>class Vehicle {

  void follow(FlowField flow) {
    // What is the vector at that spot in the flow field?
    PVector desired = flow.lookup(location);
    desired.mult(maxspeed);

    // Steering is desired minus velocity
    PVector steer = PVector.sub(desired, velocity);
    steer.limit(maxforce);
    applyForce(steer);
  }</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'><span class="kd">class</span> <span class="nc">Vehicle</span> <span class="o">{</span></span>
<span class='one-line'> </span>
<span class='one-line'>  <span class="kt">void</span> <span class="nf">follow</span><span class="o">(</span><span class="n">FlowField</span> <span class="n">flow</span><span class="o">)</span> <span class="o">{</span></span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>What is the vector at that spot in the flow field?</div><code><pre><span class='one-line'>    <span class="n">PVector</span> <span class="n">desired</span> <span class="o">=</span> <span class="n">flow</span><span class="o">.</span><span class="na">lookup</span><span class="o">(</span><span class="n">location</span><span class="o">);</span></span>
<span class='one-line'>    <span class="n">desired</span><span class="o">.</span><span class="na">mult</span><span class="o">(</span><span class="n">maxspeed</span><span class="o">);</span></span>
<span class='one-line'> </span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>Steering is desired minus velocity</div><code><pre><span class='one-line'>    <span class="n">PVector</span> <span class="n">steer</span> <span class="o">=</span> <span class="n">PVector</span><span class="o">.</span><span class="na">sub</span><span class="o">(</span><span class="n">desired</span><span class="o">,</span> <span class="n">velocity</span><span class="o">);</span></span>
<span class='one-line'>    <span class="n">steer</span><span class="o">.</span><span class="na">limit</span><span class="o">(</span><span class="n">maxforce</span><span class="o">);</span></span>
<span class='one-line'>    <span class="n">applyForce</span><span class="o">(</span><span class="n">steer</span><span class="o">);</span></span>
<span class='one-line'>  <span class="o">}</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><div class="example">
  <a id="chapter06_exercise7" style="display: block;"></a><h4 id="exercise-67">Exercise 6.7</h4><p>Adapt the flow field example so that the <span class="klass">PVector</span>s change over time. (Hint: try using the third dimension of Perlin noise!)</p>

</div><div class="example">
  <a id="chapter06_exercise8" style="display: block;"></a><h4 id="exercise-68">Exercise 6.8</h4><p>Can you seed a flow field from a <span class="klass">PImage</span>?  For example, try having the <span class="klass">PVector</span>s point from dark to light colors (or vice versa).</p>

</div></section><section><a id="chapter06_section7" style="display: block;"></a><h3 id="67-the-dot-product">6.7  The Dot Product</h3><p><a id="autonomous-agentsdot-product-82a83cb0-253f-0130-bca9-7cd1c3f718ad" style="display: block;"></a><a id="dot-product-pvector-82a853e0-253f-0130-bcaa-7cd1c3f718ad" style="display: block;"></a><a id="vectorsdot-product-82a86770-253f-0130-bcab-7cd1c3f718ad" style="display: block;"></a></p>
<p>In a moment, we’re going to work through the algorithm (along with accompanying mathematics) and code for another of Craig Reynolds’s steering behaviors: <a href="http://www.red3d.com/cwr/steer/PathFollow.html">Path Following</a>.  Before we can do this, however, we have to spend some time learning about another piece of vector math that we skipped in Chapter 1—the dot product.  We haven’t needed it yet, but it’s likely going to prove quite useful for you (beyond just this path-following example), so we’ll go over it in detail now.</p>
<p>Remember all the basic vector math we covered in Chapter 1?  Add, subtract, multiply, and divide?</p>
<a id="chapter06_figure18" style="display: block;"></a><div class="image-container " >
	
	<img src="imgs/chapter06/ch06_18.png" alt="Nature of Code Image" />
	
	<p class="caption">Figure 6.18</p>
</div>
<p>Notice how in the above diagram, vector multiplication involves multiplying a vector by a scalar value.  This makes sense; when we want a vector to be twice as large (but facing the same direction), we multiply it by 2.  When we want it to be half the size, we multiply it by 0.5.</p>
<p><a id="dot-product-pvectordefined-82a89680-253f-0130-bcac-7cd1c3f718ad" style="display: block;"></a></p>
<p>However, there are two other <em>multiplication-like</em> operations with vectors that are useful in certain scenarios—the dot product and the cross product. For now we’re going to focus on the dot product, which is defined as follows.  Assume vectors <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mover><mrow><mi> A </mi></mrow><mrow><mo> → </mo></mrow></mover></mstyle></math> and <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mover><mrow><mi> B </mi></mrow><mrow><mo> → </mo></mrow></mover></mstyle></math>:</p>
<p><math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mover><mrow><mi> A </mi></mrow><mrow><mo> → </mo></mrow></mover></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> = </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mfenced><mrow><msub><mrow><mi> a </mi></mrow><mrow><mi> x </mi></mrow></msub><mo> , </mo><msub><mrow><mi> a </mi></mrow><mrow><mi> y </mi></mrow></msub></mrow></mfenced></mstyle></math><br />
<math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mover><mrow><mi> B </mi></mrow><mrow><mo> → </mo></mrow></mover></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> = </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mfenced><mrow><msub><mrow><mi> b </mi></mrow><mrow><mi> x </mi></mrow></msub><mo> , </mo><msub><mrow><mi> b </mi></mrow><mrow><mi> y </mi></mrow></msub></mrow></mfenced></mstyle></math></p>
<p>THE DOT PRODUCT: <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mover><mrow><mi> A </mi></mrow><mrow><mo> → </mo></mrow></mover></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> · </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mover><mrow><mi> B </mi></mrow><mrow><mo> → </mo></mrow></mover></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> = </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><msub><mrow><mi> a </mi></mrow><mrow><mi> x </mi></mrow></msub><mo> * </mo><msub><mrow><mi> b </mi></mrow><mrow><mi> x </mi></mrow></msub><mo> + </mo><msub><mrow><mi> a </mi></mrow><mrow><mi> y </mi></mrow></msub><mo> * </mo><msub><mrow><mi> b </mi></mrow><mrow><mi> y </mi></mrow></msub></mstyle></math></p>
<p>For example, if we have the following two vectors:</p>
<p><math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mover><mrow><mi> A </mi></mrow><mrow><mo> → </mo></mrow></mover></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> = </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mfenced><mrow><mo> - </mo><mn> 3 </mn><mo> , </mo><mn> 5 </mn></mrow></mfenced></mstyle></math><br />
<math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mover><mrow><mi> B </mi></mrow><mrow><mo> → </mo></mrow></mover></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> = </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mfenced><mrow><mn> 10 </mn><mo> , </mo><mn> 1 </mn></mrow></mfenced></mstyle></math></p>
<p><math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mover><mrow><mi> A </mi></mrow><mrow><mo> → </mo></mrow></mover></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> · </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mover><mrow><mi> B </mi></mrow><mrow><mo> → </mo></mrow></mover></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> = </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> - </mo><mn> 3 </mn><mo> * </mo><mn> 10 </mn><mo> + </mo><mn> 5 </mn><mo> * </mo><mn> 1 </mn><mo> = </mo><mo> - </mo><mn> 30 </mn><mo> + </mo><mn> 5 </mn><mo> = </mo><mn> 35 </mn></mstyle></math></p>
<p>Notice that the result of the dot product is a scalar value (a single number) and not a vector.</p>
<p>In Processing, this would translate to:</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>PVector a = new PVector(-3,5);
PVector b = new PVector(10,1);

// The PVector class includes a
// function to calculate the dot product.
float n = a.dot(b);</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'><span class="n">PVector</span> <span class="n">a</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PVector</span><span class="o">(-</span><span class="mi">3</span><span class="o">,</span><span class="mi">5</span><span class="o">);</span></span>
<span class='one-line'><span class="n">PVector</span> <span class="n">b</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PVector</span><span class="o">(</span><span class="mi">10</span><span class="o">,</span><span class="mi">1</span><span class="o">);</span></span>
<span class='one-line'> </span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>The PVector class includes a
function to calculate the dot product.</div><code><pre><span class='one-line'><span class="kt">float</span> <span class="n">n</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="na">dot</span><span class="o">(</span><span class="n">b</span><span class="o">);</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>And if we were to look in the guts of the <span class="klass">PVector</span> source, we’d find a pretty simple implementation of this function:</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>public float dot(PVector v) {
  return x*v.x + y*v.y + z*v.z;
}</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'><span class="kd">public</span> <span class="kt">float</span> <span class="nf">dot</span><span class="o">(</span><span class="n">PVector</span> <span class="n">v</span><span class="o">)</span> <span class="o">{</span></span>
<span class='one-line'>  <span class="k">return</span> <span class="n">x</span><span class="o">*</span><span class="n">v</span><span class="o">.</span><span class="na">x</span> <span class="o">+</span> <span class="n">y</span><span class="o">*</span><span class="n">v</span><span class="o">.</span><span class="na">y</span> <span class="o">+</span> <span class="n">z</span><span class="o">*</span><span class="n">v</span><span class="o">.</span><span class="na">z</span><span class="o">;</span></span>
<span class='one-line'><span class="o">}</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>This is simple enough, but why do we need the dot product, and when is it going to be useful for us in code?</p>
<p>One of the more common uses of the dot product is to find the angle between two vectors.   Another way in which the dot product can be expressed is:</p>
<p><math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mover><mrow><mi> A </mi></mrow><mrow><mo> → </mo></mrow></mover></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> · </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mover><mrow><mi> B </mi></mrow><mrow><mo> → </mo></mrow></mover></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> = </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> ∥ </mo><mover><mrow><mi> A </mi></mrow><mrow><mo> → </mo></mrow></mover><mo> ∥ </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> * </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> ∥ </mo><mover><mrow><mi> B </mi></mrow><mrow><mo> → </mo></mrow></mover><mo> ∥ </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> * </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mi> cos </mi><mfenced><mrow><mi> θ </mi></mrow></mfenced></mstyle></math></p>
<p><a id="dot-product-pvectortheta-82a8f2f0-253f-0130-bcad-7cd1c3f718ad" style="display: block;"></a><a id="theta-dot-product-and-82a90680-253f-0130-bcae-7cd1c3f718ad" style="display: block;"></a></p>
<p>In other words, A dot B is equal to the magnitude of A times magnitude of B times cosine of theta (with theta defined as <em>the angle between the two vectors A and B</em>).</p>
<p>The two formulas for dot product can be derived from one another with <a href="http://mathworld.wolfram.com/DotProduct.html">trigonometry</a>, but for our purposes we can be happy with operating on the assumption that:</p>
<p><math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mover><mrow><mi> A </mi></mrow><mrow><mo> → </mo></mrow></mover></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> · </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mover><mrow><mi> B </mi></mrow><mrow><mo> → </mo></mrow></mover></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> = </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> ∥ </mo><mover><mrow><mi> A </mi></mrow><mrow><mo> → </mo></mrow></mover><mo> ∥ </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> * </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> ∥ </mo><mover><mrow><mi> B </mi></mrow><mrow><mo> → </mo></mrow></mover><mo> ∥ </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> * </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mi> cos </mi><mfenced><mrow><mi> θ </mi></mrow></mfenced></mstyle></math><br />
<math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mover><mrow><mi> A </mi></mrow><mrow><mo> → </mo></mrow></mover></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> · </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mover><mrow><mi> B </mi></mrow><mrow><mo> → </mo></mrow></mover></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> = </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><msub><mrow><mi> a </mi></mrow><mrow><mi> x </mi></mrow></msub><mo> * </mo><msub><mrow><mi> b </mi></mrow><mrow><mi> x </mi></mrow></msub><mo> + </mo><msub><mrow><mi> a </mi></mrow><mrow><mi> y </mi></mrow></msub><mo> * </mo><msub><mrow><mi> b </mi></mrow><mrow><mi> y </mi></mrow></msub></mstyle></math></p>
<p>both hold true and therefore:</p>
<p><math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><msub><mrow><mi> a </mi></mrow><mrow><mi> x </mi></mrow></msub><mo> * </mo><msub><mrow><mi> b </mi></mrow><mrow><mi> x </mi></mrow></msub><mo> + </mo><msub><mrow><mi> a </mi></mrow><mrow><mi> y </mi></mrow></msub><mo> * </mo><msub><mrow><mi> b </mi></mrow><mrow><mi> y </mi></mrow></msub></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> = </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> ∥ </mo><mover><mrow><mi> A </mi></mrow><mrow><mo> → </mo></mrow></mover><mo> ∥ </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> * </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> ∥ </mo><mover><mrow><mi> B </mi></mrow><mrow><mo> → </mo></mrow></mover><mo> ∥ </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> * </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mi> cos </mi><mfenced><mrow><mi> θ </mi></mrow></mfenced></mstyle></math></p>
<a id="chapter06_figure19" style="display: block;"></a><div class="image-container half-width-right" >
	
	<img src="imgs/chapter06/ch06_19.png" alt="Nature of Code Image" />
	
	<p class="caption">Figure 6.19</p>
</div>
<p>Now, let’s start with the following problem. We have the vectors A and B:</p>
<p><math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mover><mrow><mi> A </mi></mrow><mrow><mo> → </mo></mrow></mover></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> = </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mfenced><mrow><mn> 10 </mn><mo> , </mo><mn> 2 </mn></mrow></mfenced></mstyle></math><br />
<math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mover><mrow><mi> B </mi></mrow><mrow><mo> → </mo></mrow></mover></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> = </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mfenced><mrow><mn> 4 </mn><mo> , </mo><mo> - </mo><mn> 3 </mn></mrow></mfenced></mstyle></math></p>
<p>We now have a situation in which we know everything except for theta.   We know the components of the vector and can calculate the magnitude of each vector.  We can therefore solve for cosine of theta:</p>
<p><math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mi> cos </mi><mfenced><mrow><mi> θ </mi></mrow></mfenced></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> = </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> ( </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mover><mrow><mi> A </mi></mrow><mrow><mo> → </mo></mrow></mover></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> · </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mover><mrow><mi> B </mi></mrow><mrow><mo> → </mo></mrow></mover></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> ) </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> / </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> ( </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> ∥ </mo><mover><mrow><mi> A </mi></mrow><mrow><mo> → </mo></mrow></mover><mo> ∥ </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> * </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> ∥ </mo><mover><mrow><mi> B </mi></mrow><mrow><mo> → </mo></mrow></mover><mo> ∥ </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> ) </mo></mstyle></math></p>
<p>To solve for theta, we can take the inverse cosine (often expressed as <em>cosine<sup>-1</sup></em> or <em>arccosine</em>).</p>
<p><math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mi> θ </mi></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> = </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><msup><mrow><mi> cos </mi></mrow><mrow><mo> - </mo><mn> 1 </mn></mrow></msup></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> ( </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> ( </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mover><mrow><mi> A </mi></mrow><mrow><mo> → </mo></mrow></mover></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> · </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mover><mrow><mi> B </mi></mrow><mrow><mo> → </mo></mrow></mover></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> ) </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> / </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> ( </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> ∥ </mo><mover><mrow><mi> A </mi></mrow><mrow><mo> → </mo></mrow></mover><mo> ∥ </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> * </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> ∥ </mo><mover><mrow><mi> B </mi></mrow><mrow><mo> → </mo></mrow></mover><mo> ∥ </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> ) </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> ) </mo></mstyle></math></p>
<p>Let’s now do the math with actual numbers:</p>
<p><math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> ∥ </mo><mover><mrow><mi> A </mi></mrow><mrow><mo> → </mo></mrow></mover><mo> ∥ </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> = </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mn> 10.2 </mn></mstyle></math><br />
<math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> ∥ </mo><mover><mrow><mi> B </mi></mrow><mrow><mo> → </mo></mrow></mover><mo> ∥ </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> = </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mn> 5 </mn></mstyle></math></p>
<p>Therefore:</p>
<p><math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mi> θ </mi></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> = </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><msup><mrow><mi> cos </mi></mrow><mrow><mo> - </mo><mn> 1 </mn></mrow></msup></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> ( </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> ( </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mn> 10 </mn></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> * </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mn> 4 </mn></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> + </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mn> 2 </mn></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> * </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mn> -3 </mn></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> ) </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> / </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> ( </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mn> 10.2 </mn></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> * </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mn> 5 </mn></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> ) </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> ) </mo></mstyle></math><br />
<math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mi> θ </mi></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> = </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><msup><mrow><mi> cos </mi></mrow><mrow><mo> - </mo><mn> 1 </mn></mrow></msup></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> ( </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mn> 34 </mn></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> / </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mn> 51 </mn></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> ) </mo></mstyle></math><br />
<math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mi> θ </mi></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> = </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> ∼ </mo><mn> 4 </mn><msup><mrow><mn> 8 </mn></mrow><mrow><mo> ∘ </mo></mrow></msup></mstyle></math></p>
<p>The Processing version of this would be:</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>PVector a = new PVector(10,2);
PVector b = new PVector(4,-3);
float theta = acos(a.dot(b) / (a.mag() * b.mag()));</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'><span class="n">PVector</span> <span class="n">a</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PVector</span><span class="o">(</span><span class="mi">10</span><span class="o">,</span><span class="mi">2</span><span class="o">);</span></span>
<span class='one-line'><span class="n">PVector</span> <span class="n">b</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PVector</span><span class="o">(</span><span class="mi">4</span><span class="o">,-</span><span class="mi">3</span><span class="o">);</span></span>
<span class='one-line'><span class="kt">float</span> <span class="n">theta</span> <span class="o">=</span> <span class="n">acos</span><span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">dot</span><span class="o">(</span><span class="n">b</span><span class="o">)</span> <span class="o">/</span> <span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">mag</span><span class="o">()</span> <span class="o">*</span> <span class="n">b</span><span class="o">.</span><span class="na">mag</span><span class="o">()));</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>And, again, if we were to dig into the guts of the Processing source code, we would see a function that implements this exact algorithm.</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>  static public float angleBetween(PVector v1, PVector v2) {
    float dot = v1.dot(v2);
    float theta = (float) Math.acos(dot / (v1.mag() * v2.mag()));
    return theta;
  }</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'>  <span class="kd">static</span> <span class="kd">public</span> <span class="kt">float</span> <span class="nf">angleBetween</span><span class="o">(</span><span class="n">PVector</span> <span class="n">v1</span><span class="o">,</span> <span class="n">PVector</span> <span class="n">v2</span><span class="o">)</span> <span class="o">{</span></span>
<span class='one-line'>    <span class="kt">float</span> <span class="n">dot</span> <span class="o">=</span> <span class="n">v1</span><span class="o">.</span><span class="na">dot</span><span class="o">(</span><span class="n">v2</span><span class="o">);</span></span>
<span class='one-line'>    <span class="kt">float</span> <span class="n">theta</span> <span class="o">=</span> <span class="o">(</span><span class="kt">float</span><span class="o">)</span> <span class="n">Math</span><span class="o">.</span><span class="na">acos</span><span class="o">(</span><span class="n">dot</span> <span class="o">/</span> <span class="o">(</span><span class="n">v1</span><span class="o">.</span><span class="na">mag</span><span class="o">()</span> <span class="o">*</span> <span class="n">v2</span><span class="o">.</span><span class="na">mag</span><span class="o">()));</span></span>
<span class='one-line'>    <span class="k">return</span> <span class="n">theta</span><span class="o">;</span></span>
<span class='one-line'>  <span class="o">}</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><div class="example">
  <a id="chapter06_exercise9" style="display: block;"></a><h4 id="exercise-69">Exercise 6.9</h4><div class="image-container half-width-right" >
	
	<img src="imgs/chapter06/ch06_exc9.png" alt="Nature of Code Image" />
	
	
</div>
<p>Create a sketch that displays the angle between two <span class="klass">PVector</span> objects.</p>
<div class="image-container " >
	
	<img src="imgs/blank.png" alt="Nature of Code Image" />
	
	
</div>

</div><p>A couple things to note here:</p>
<div class="list">
	
	<ol class="arabic">
		
			<li><p>
If two vectors (<math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mover><mrow><mi> A </mi></mrow><mrow><mo> → </mo></mrow></mover></mstyle></math> and <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mover><mrow><mi> B </mi></mrow><mrow><mo> → </mo></mrow></mover></mstyle></math>) are orthogonal (i.e. perpendicular), the dot product (<math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mover><mrow><mi> A </mi></mrow><mrow><mo> → </mo></mrow></mover></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> · </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mover><mrow><mi> B </mi></mrow><mrow><mo> → </mo></mrow></mover></mstyle></math>) is equal to 0.
</p>
</li>
		
			<li><p>
If two vectors are unit vectors, then the dot product is simply equal to cosine of the angle between them, i.e. <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mover><mrow><mi> A </mi></mrow><mrow><mo> → </mo></mrow></mover></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> · </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mover><mrow><mi> B </mi></mrow><mrow><mo> → </mo></mrow></mover></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> = </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mi> cos </mi><mfenced><mrow><mi> θ </mi></mrow></mfenced></mstyle></math> if <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mover><mrow><mi> A </mi></mrow><mrow><mo> → </mo></mrow></mover></mstyle></math> and <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mover><mrow><mi> B </mi></mrow><mrow><mo> → </mo></mrow></mover></mstyle></math> are of length 1.
</p>
</li>
		
	</ol>
</div></section><section><a id="chapter06_section8" style="display: block;"></a><h3 id="68-path-following">6.8  Path Following</h3><p><a id="autonomous-agentspath-following-82ac3280-253f-0130-bcaf-7cd1c3f718ad" style="display: block;"></a><a id="path-following-82ac4520-253f-0130-bcb0-7cd1c3f718ad" style="display: block;"></a><a id="path-followingpathfinding-vs-82ac5c40-253f-0130-bcb1-7cd1c3f718ad" style="display: block;"></a><a id="pathfinding-82ac6ee0-253f-0130-bcb2-7cd1c3f718ad" style="display: block;"></a><a id="reynolds-craigpath-following-algorithm-82ac7f80-253f-0130-bcb3-7cd1c3f718ad" style="display: block;"></a></p>
<p>Now that we’ve got a basic understanding of the dot product under our belt, we can return to a discussion of Craig Reynolds’s path-following algorithm.     Let’s quickly clarify something.  We are talking about path <em>following</em>, not path <em>finding</em>.  Pathfinding refers to a research topic (commonly studied in artificial intelligence) that involves solving for the shortest distance between two points, often in a maze.   With <strong><em>path following</em></strong>, the path already exists and we’re asking a vehicle to follow that path.</p>
<p>Before we work out the individual pieces, let’s take a look at the overall algorithm for path following, as defined by Reynolds.</p>
<a id="chapter06_figure20" style="display: block;"></a><div class="image-container " >
	
	<img src="imgs/chapter06/ch06_20.png" alt="Nature of Code Image" />
	
	<p class="caption">Figure 6.20</p>
</div>
<p><a id="path-82acb290-253f-0130-bcb4-7cd1c3f718ad" style="display: block;"></a></p>
<p>We’ll first define what we mean by a path.  There are many ways we could implement a path, but for us, a simple way will be to define a path as a series of connected points:</p>
<a id="chapter06_figure21" style="display: block;"></a><div class="image-container " >
	
	<img src="imgs/chapter06/ch06_21.png" alt="Nature of Code Image" />
	
	<p class="caption">Figure 6.21: Path</p>
</div>
<p>An even simpler path would be a line between two points.</p>
<a id="chapter06_figure22" style="display: block;"></a><div class="image-container " >
	
	<img src="imgs/chapter06/ch06_22.png" alt="Nature of Code Image" />
	
	<p class="caption">Figure 6.22: Simple path</p>
</div>
<p>We’re also going to consider a path to have a radius.  If we think of the path as a road, the radius determines the road’s width.  With a smaller radius, our vehicles will have to follow the path more closely; a wider radius will allow them to stray a bit more.</p>
<p>Putting this into a class, we have:</p>
<div class="image-container screenshot" >
	
	<img src="imgs/chapter06/ch06_ex5_a.png" alt="Nature of Code Image" />
	
	
</div>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>class Path {

  //[full] A path is only two points, start and end.
  PVector start;
  PVector end;
  //[end]

  // A path has a radius, i.e. how wide it is.
  float radius;

  Path() {
    // Picking some arbitrary values to initialize the path
    radius = 20;
    start = new PVector(0,height/3);
    end = new PVector(width,2*height/3);
  }

  void display() {  // Display the path.
    strokeWeight(radius*2);
    stroke(0,100);
    line(start.x,start.y,end.x,end.y);
    strokeWeight(1);
    stroke(0);
    line(start.x,start.y,end.x,end.y);
  }
}</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'><span class="kd">class</span> <span class="nc">Path</span> <span class="o">{</span></span>
<span class='one-line'> </span></pre></code></div>

  <div class='code-comment-pair stretch'><div class='code-comment stretch'> A path is only two points, start and end.</div><code><pre><span class='one-line'>  <span class="n">PVector</span> <span class="n">start</span><span class="o">;</span></span>
<span class='one-line'>  <span class="n">PVector</span> <span class="n">end</span><span class="o">;</span></span></pre></code><div style='position:relative;clear:both;display:block;height:1px;width:100%;'></div></div>

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'> </span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>A path has a radius, i.e. how wide it is.</div><code><pre><span class='one-line'>  <span class="kt">float</span> <span class="n">radius</span><span class="o">;</span></span>
<span class='one-line'> </span>
<span class='one-line'>  <span class="n">Path</span><span class="o">()</span> <span class="o">{</span></span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>Picking some arbitrary values to initialize the path</div><code><pre><span class='one-line'>    <span class="n">radius</span> <span class="o">=</span> <span class="mi">20</span><span class="o">;</span></span>
<span class='one-line'>    <span class="n">start</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PVector</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="n">height</span><span class="o">/</span><span class="mi">3</span><span class="o">);</span></span>
<span class='one-line'>    <span class="n">end</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PVector</span><span class="o">(</span><span class="n">width</span><span class="o">,</span><span class="mi">2</span><span class="o">*</span><span class="n">height</span><span class="o">/</span><span class="mi">3</span><span class="o">);</span></span>
<span class='one-line'>  <span class="o">}</span></span>
<span class='one-line'> </span>
<span class='one-line'>  <span class="kt">void</span> <span class="nf">display</span><span class="o">()</span> <span class="o">{</span>  <span class="c1">// Display the path.</span></span>
<span class='one-line'>    <span class="n">strokeWeight</span><span class="o">(</span><span class="n">radius</span><span class="o">*</span><span class="mi">2</span><span class="o">);</span></span>
<span class='one-line'>    <span class="n">stroke</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="mi">100</span><span class="o">);</span></span>
<span class='one-line'>    <span class="n">line</span><span class="o">(</span><span class="n">start</span><span class="o">.</span><span class="na">x</span><span class="o">,</span><span class="n">start</span><span class="o">.</span><span class="na">y</span><span class="o">,</span><span class="n">end</span><span class="o">.</span><span class="na">x</span><span class="o">,</span><span class="n">end</span><span class="o">.</span><span class="na">y</span><span class="o">);</span></span>
<span class='one-line'>    <span class="n">strokeWeight</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span></span>
<span class='one-line'>    <span class="n">stroke</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span></span>
<span class='one-line'>    <span class="n">line</span><span class="o">(</span><span class="n">start</span><span class="o">.</span><span class="na">x</span><span class="o">,</span><span class="n">start</span><span class="o">.</span><span class="na">y</span><span class="o">,</span><span class="n">end</span><span class="o">.</span><span class="na">x</span><span class="o">,</span><span class="n">end</span><span class="o">.</span><span class="na">y</span><span class="o">);</span></span>
<span class='one-line'>  <span class="o">}</span></span>
<span class='one-line'><span class="o">}</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>Now, let’s assume we have a vehicle (as depicted below) outside of the path’s radius, moving with a velocity.</p>
<a id="chapter06_figure23" style="display: block;"></a><div class="image-container " >
	
	<img src="imgs/chapter06/ch06_23.png" alt="Nature of Code Image" />
	
	<p class="caption">Figure 6.23</p>
</div>
<p>The first thing we want to do is predict, assuming a constant velocity, where that vehicle will be in the future.</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>// Start by making a copy of the velocity.
PVector predict = vel.get();

//[full] Normalize it and look 25 pixels
// ahead by scaling the vector up.
predict.normalize();
predict.mult(25);
//[end]

// Add vector to location to find the
// predicted location.
PVector predictLoc = PVector.add(loc, predict);</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair '><div class='code-comment '>Start by making a copy of the velocity.</div><code><pre><span class='one-line'><span class="n">PVector</span> <span class="n">predict</span> <span class="o">=</span> <span class="n">vel</span><span class="o">.</span><span class="na">get</span><span class="o">();</span></span>
<span class='one-line'> </span></pre></code></div>

  <div class='code-comment-pair stretch'><div class='code-comment stretch'> Normalize it and look 25 pixels
ahead by scaling the vector up.</div><code><pre><span class='one-line'><span class="n">predict</span><span class="o">.</span><span class="na">normalize</span><span class="o">();</span></span>
<span class='one-line'><span class="n">predict</span><span class="o">.</span><span class="na">mult</span><span class="o">(</span><span class="mi">25</span><span class="o">);</span></span></pre></code><div style='position:relative;clear:both;display:block;height:1px;width:100%;'></div></div>

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'> </span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>Add vector to location to find the
predicted location.</div><code><pre><span class='one-line'><span class="n">PVector</span> <span class="n">predictLoc</span> <span class="o">=</span> <span class="n">PVector</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">loc</span><span class="o">,</span> <span class="n">predict</span><span class="o">);</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p><a id="path-followingcurrent-distance-from-path-finding-82acf6f0-253f-0130-bcb5-7cd1c3f718ad" style="display: block;"></a></p>
<p>Once we have that location, it’s now our job to find out the vehicle’s current distance from the path of that predicted location.  If it’s very far away, well, then, we’ve strayed from the path and need to steer back towards it.  If it’s close, then we’re doing OK and are following the path nicely.</p>
<p>So, how do we find the distance between a point and a line?  This concept is key.  The distance between a point and a line is defined as the length of the normal between that point and line.  The normal is a vector that extends from that point and is perpendicular to the line.</p>
<a id="chapter06_figure24" style="display: block;"></a><div class="image-container " >
	
	<img src="imgs/chapter06/ch06_24.png" alt="Nature of Code Image" />
	
	<p class="caption">Figure 6.24</p>
</div>
<p>Let’s figure out what we do know.    We know we have a vector (call it <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mover><mrow><mi> A </mi></mrow><mrow><mo> → </mo></mrow></mover></mstyle></math>) that extends from the path’s starting point to the vehicle’s predicted location.</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>PVector a = PVector.sub(predictLoc,path.start);</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'><span class="n">PVector</span> <span class="n">a</span> <span class="o">=</span> <span class="n">PVector</span><span class="o">.</span><span class="na">sub</span><span class="o">(</span><span class="n">predictLoc</span><span class="o">,</span><span class="n">path</span><span class="o">.</span><span class="na">start</span><span class="o">);</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>We also know that we can define a vector (call it <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mover><mrow><mi> B </mi></mrow><mrow><mo> → </mo></mrow></mover></mstyle></math>) that points from the start of the path to the end.</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>PVector b = PVector.sub(path.end,path.start);</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'><span class="n">PVector</span> <span class="n">b</span> <span class="o">=</span> <span class="n">PVector</span><span class="o">.</span><span class="na">sub</span><span class="o">(</span><span class="n">path</span><span class="o">.</span><span class="na">end</span><span class="o">,</span><span class="n">path</span><span class="o">.</span><span class="na">start</span><span class="o">);</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>Now, with basic trigonometry, we know that the distance from the path’s start to the normal point is: <span class="formula">|A| * cos(theta)</span>.</p>
<a id="chapter06_figure25" style="display: block;"></a><div class="image-container " >
	
	<img src="imgs/chapter06/ch06_25.png" alt="Nature of Code Image" />
	
	<p class="caption">Figure 6.25</p>
</div>
<p>If we knew theta, we could easily define that normal point as follows:</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>// The distance from START to NORMAL
float d = a.mag()*cos(theta);
b.normalize();
// Scale PVector b to that distance.
b.mult(d);
// The normal point can be found by adding
// the scaled version of b to the path’s
// starting point.
PVector normalPoint = PVector.add(path.start,b);</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair '><div class='code-comment '>The distance from START to NORMAL</div><code><pre><span class='one-line'><span class="kt">float</span> <span class="n">d</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="na">mag</span><span class="o">()*</span><span class="n">cos</span><span class="o">(</span><span class="n">theta</span><span class="o">);</span></span>
<span class='one-line'><span class="n">b</span><span class="o">.</span><span class="na">normalize</span><span class="o">();</span></span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>Scale PVector b to that distance.</div><code><pre><span class='one-line'><span class="n">b</span><span class="o">.</span><span class="na">mult</span><span class="o">(</span><span class="n">d</span><span class="o">);</span></span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>The normal point can be found by adding
the scaled version of b to the path’s
starting point.</div><code><pre><span class='one-line'><span class="n">PVector</span> <span class="n">normalPoint</span> <span class="o">=</span> <span class="n">PVector</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">path</span><span class="o">.</span><span class="na">start</span><span class="o">,</span><span class="n">b</span><span class="o">);</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>And if the dot product has taught us anything, it’s that given two vectors, we can get theta, the angle between.</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>// What is theta?  The angle between A and B
float theta = PVector.angleBetween(a,b);
b.normalize();
b.mult(a.mag()*cos(theta));
PVector normalPoint = PVector.add(path.start,b);</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair '><div class='code-comment '>What is theta?  The angle between A and B</div><code><pre><span class='one-line'><span class="kt">float</span> <span class="n">theta</span> <span class="o">=</span> <span class="n">PVector</span><span class="o">.</span><span class="na">angleBetween</span><span class="o">(</span><span class="n">a</span><span class="o">,</span><span class="n">b</span><span class="o">);</span></span>
<span class='one-line'><span class="n">b</span><span class="o">.</span><span class="na">normalize</span><span class="o">();</span></span>
<span class='one-line'><span class="n">b</span><span class="o">.</span><span class="na">mult</span><span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">mag</span><span class="o">()*</span><span class="n">cos</span><span class="o">(</span><span class="n">theta</span><span class="o">));</span></span>
<span class='one-line'><span class="n">PVector</span> <span class="n">normalPoint</span> <span class="o">=</span> <span class="n">PVector</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">path</span><span class="o">.</span><span class="na">start</span><span class="o">,</span><span class="n">b</span><span class="o">);</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>While the above code will work, there’s one more simplification we can make.   If you’ll notice, the desired magnitude for vector <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mover><mrow><mi> B </mi></mrow><mrow><mo> → </mo></mrow></mover></mstyle></math> is:</p>
<p><span class="formula">a.mag()*cos(theta)</span></p>
<p>which is the code translation of:</p>
<p><math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> ∥ </mo><mover><mrow><mi> A </mi></mrow><mrow><mo> → </mo></mrow></mover><mo> ∥ </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> * </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mi> cos </mi><mfenced><mrow><mi> θ </mi></mrow></mfenced></mstyle></math></p>
<p>And if you recall:</p>
<p><math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mover><mrow><mi> A </mi></mrow><mrow><mo> → </mo></mrow></mover></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> · </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mover><mrow><mi> B </mi></mrow><mrow><mo> → </mo></mrow></mover></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> = </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> ∥ </mo><mover><mrow><mi> A </mi></mrow><mrow><mo> → </mo></mrow></mover><mo> ∥ </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> * </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> ∥ </mo><mover><mrow><mi> B </mi></mrow><mrow><mo> → </mo></mrow></mover><mo> ∥ </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> * </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mi> cos </mi><mfenced><mrow><mi> θ </mi></mrow></mfenced></mstyle></math></p>
<p>Now, what if vector <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mover><mrow><mi> B </mi></mrow><mrow><mo> → </mo></mrow></mover></mstyle></math> is a unit vector, i.e. length 1?  Then:</p>
<p><math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mover><mrow><mi> A </mi></mrow><mrow><mo> → </mo></mrow></mover></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> · </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mover><mrow><mi> B </mi></mrow><mrow><mo> → </mo></mrow></mover></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> = </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> ∥ </mo><mover><mrow><mi> A </mi></mrow><mrow><mo> → </mo></mrow></mover><mo> ∥ </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> * </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mn> 1 </mn></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> * </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mi> cos </mi><mfenced><mrow><mi> θ </mi></mrow></mfenced></mstyle></math></p>
<p>or</p>
<p><math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mover><mrow><mi> A </mi></mrow><mrow><mo> → </mo></mrow></mover></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> · </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mover><mrow><mi> B </mi></mrow><mrow><mo> → </mo></mrow></mover></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> = </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> ∥ </mo><mover><mrow><mi> A </mi></mrow><mrow><mo> → </mo></mrow></mover><mo> ∥ </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mo> * </mo></mstyle></math> <math xmlns="http://www.w3.org/1998/Math/MathML"><mstyle displaystyle="true"><mi> cos </mi><mfenced><mrow><mi> θ </mi></mrow></mfenced></mstyle></math></p>
<p>And what are we doing in our code?  Normalizing b!</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>b.normalize();</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'><span class="n">b</span><span class="o">.</span><span class="na">normalize</span><span class="o">();</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>Because of this fact, we can simplify our code as:</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>float theta = PVector.angleBetween(a,b); //[line-through]

b.normalize();
// We can use the dot product to scale b’s length.
b.mult(a.dot(b));

PVector normalPoint = PVector.add(path.start,b);</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'><span class="line-through"><span class="kt">float</span> <span class="n">theta</span> <span class="o">=</span> <span class="n">PVector</span><span class="o">.</span><span class="na">angleBetween</span><span class="o">(</span><span class="n">a</span><span class="o">,</span><span class="n">b</span><span class="o">);</span></span></span>
<span class='one-line'> </span>
<span class='one-line'><span class="n">b</span><span class="o">.</span><span class="na">normalize</span><span class="o">();</span></span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>We can use the dot product to scale b’s length.</div><code><pre><span class='one-line'><span class="n">b</span><span class="o">.</span><span class="na">mult</span><span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">dot</span><span class="o">(</span><span class="n">b</span><span class="o">));</span></span>
<span class='one-line'> </span>
<span class='one-line'><span class="n">PVector</span> <span class="n">normalPoint</span> <span class="o">=</span> <span class="n">PVector</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">path</span><span class="o">.</span><span class="na">start</span><span class="o">,</span><span class="n">b</span><span class="o">);</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p><a id="scalar-projection-82ad71e0-253f-0130-bcb6-7cd1c3f718ad" style="display: block;"></a></p>
<p>This process is commonly known as “scalar projection.”  <strong><em>|A| cos(θ) is the scalar projection of A onto B.</em></strong></p>
<a id="chapter06_figure26" style="display: block;"></a><div class="image-container " >
	
	<img src="imgs/chapter06/ch06_26.png" alt="Nature of Code Image" />
	
	<p class="caption">Figure 6.26</p>
</div>
<p><a id="normal-points-82ad9780-253f-0130-bcb7-7cd1c3f718ad" style="display: block;"></a><a id="path-followingnormal-points-82adb150-253f-0130-bcb8-7cd1c3f718ad" style="display: block;"></a></p>
<p>Once we have the normal point along the path, we have to decide whether the vehicle should steer towards the path and how.  Reynolds’s algorithm states that the vehicle should only steer towards the path if it strays beyond the path (i.e., if the distance between the normal point and the predicted future location is greater than the path radius).</p>
<a id="chapter06_figure27" style="display: block;"></a><div class="image-container " >
	
	<img src="imgs/chapter06/ch06_27.png" alt="Nature of Code Image" />
	
	<p class="caption">Figure 6.27</p>
</div>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>float distance = PVector.dist(predictLoc, normalPoint);

// If the vehicle is outside the path,
// seek the target.
if (distance > path.radius) {
  // We don’t have to work out the desired velocity and
  // steering force; all that is taken care of by seek(),
  // which we already wrote in Example 6.1.
  seek(target);
}</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'><span class="kt">float</span> <span class="n">distance</span> <span class="o">=</span> <span class="n">PVector</span><span class="o">.</span><span class="na">dist</span><span class="o">(</span><span class="n">predictLoc</span><span class="o">,</span> <span class="n">normalPoint</span><span class="o">);</span></span>
<span class='one-line'> </span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>If the vehicle is outside the path,
seek the target.</div><code><pre><span class='one-line'><span class="k">if</span> <span class="o">(</span><span class="n">distance</span> <span class="o">&gt;</span> <span class="n">path</span><span class="o">.</span><span class="na">radius</span><span class="o">)</span> <span class="o">{</span></span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>We don’t have to work out the desired velocity and
steering force; all that is taken care of by seek(),
which we already wrote in Example 6.1.</div><code><pre><span class='one-line'>  <span class="n">seek</span><span class="o">(</span><span class="n">target</span><span class="o">);</span></span>
<span class='one-line'><span class="o">}</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>But what is the target?</p>
<p><a id="path-followingtarget-determining-82ade4d0-253f-0130-bcb9-7cd1c3f718ad" style="display: block;"></a></p>
<p>Reynolds’s algorithm involves picking a point ahead of the normal on the path (see step #3 above).  But for simplicity, we could just say that the target is the normal itself. This will work fairly well:</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>float distance = PVector.dist(predictLoc, normalPoint);
if (distance > path.radius) {
  // Seek the normal point on the path.
  seek(normalPoint);
}</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'><span class="kt">float</span> <span class="n">distance</span> <span class="o">=</span> <span class="n">PVector</span><span class="o">.</span><span class="na">dist</span><span class="o">(</span><span class="n">predictLoc</span><span class="o">,</span> <span class="n">normalPoint</span><span class="o">);</span></span>
<span class='one-line'><span class="k">if</span> <span class="o">(</span><span class="n">distance</span> <span class="o">&gt;</span> <span class="n">path</span><span class="o">.</span><span class="na">radius</span><span class="o">)</span> <span class="o">{</span></span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>Seek the normal point on the path.</div><code><pre><span class='one-line'>  <span class="n">seek</span><span class="o">(</span><span class="n">normalPoint</span><span class="o">);</span></span>
<span class='one-line'><span class="o">}</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>Since we know the vector that defines the path (we’re calling it “B”), we can implement Reynolds’s “point ahead on the path” without too much trouble.</p>
<a id="chapter06_figure28" style="display: block;"></a><div class="image-container " >
	
	<img src="imgs/chapter06/ch06_28.png" alt="Nature of Code Image" />
	
	<p class="caption">Figure 6.28</p>
</div>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>float distance = PVector.dist(predictLoc, normalPoint);
if (distance > path.radius) {
  //[full] Normalize and scale b (pick 25 pixels arbitrarily).
  b.normalize();
  b.mult(25);
  //[end]
  // By adding b to normalPoint, we now move
  // 25 pixels ahead on the path.
  PVector target = PVector.add(normalPoint,b);

  seek(target);
}</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'><span class="kt">float</span> <span class="n">distance</span> <span class="o">=</span> <span class="n">PVector</span><span class="o">.</span><span class="na">dist</span><span class="o">(</span><span class="n">predictLoc</span><span class="o">,</span> <span class="n">normalPoint</span><span class="o">);</span></span>
<span class='one-line'><span class="k">if</span> <span class="o">(</span><span class="n">distance</span> <span class="o">&gt;</span> <span class="n">path</span><span class="o">.</span><span class="na">radius</span><span class="o">)</span> <span class="o">{</span></span></pre></code></div>

  <div class='code-comment-pair stretch'><div class='code-comment stretch'> Normalize and scale b (pick 25 pixels arbitrarily).</div><code><pre><span class='one-line'>  <span class="n">b</span><span class="o">.</span><span class="na">normalize</span><span class="o">();</span></span>
<span class='one-line'>  <span class="n">b</span><span class="o">.</span><span class="na">mult</span><span class="o">(</span><span class="mi">25</span><span class="o">);</span></span></pre></code><div style='position:relative;clear:both;display:block;height:1px;width:100%;'></div></div>

  <div class='code-comment-pair '><div class='code-comment '>
By adding b to normalPoint, we now move
25 pixels ahead on the path.</div><code><pre><span class='one-line'>  <span class="n">PVector</span> <span class="n">target</span> <span class="o">=</span> <span class="n">PVector</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">normalPoint</span><span class="o">,</span><span class="n">b</span><span class="o">);</span></span>
<span class='one-line'> </span>
<span class='one-line'>  <span class="n">seek</span><span class="o">(</span><span class="n">target</span><span class="o">);</span></span>
<span class='one-line'><span class="o">}</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>Putting it all together, we have the following steering function in our <span class="klass">Vehicle</span> class.</p>
<div class="image-container screenshot" >
	
	<canvas data-processing-sources="../NOC%20examples%20-%20processing/chp06/NOC_6_05_PathFollowingSimple/NOC_6_05_PathFollowingSimple.pde ../NOC%20examples%20-%20processing/chp06/NOC_6_05_PathFollowingSimple/Path.pde ../NOC%20examples%20-%20processing/chp06/NOC_6_05_PathFollowingSimple/Vehicle.pde" class="screenshot">
		<p>Your browser does not support the canvas tag.</p>
	</canvas>
  <div class="sketch-controls">
    <button class="reset">RESET</button>
    <button class="pause">PAUSE</button>
  </div>
	
	
</div>
<p><a id="chapter06_example5" style="display: block;"></a><span class="example">Example 6.5: Simple path following</span></p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>  void follow(Path p) {

    //[full] Step 1: Predict the vehicle’s future location.
    PVector predict = vel.get();
    predict.normalize();
    predict.mult(25);
    PVector predictLoc = PVector.add(loc, predict);
    //[end]

    //[full] Step 2: Find the normal point along the path.
    PVector a = p.start;
    PVector b = p.end;
    PVector normalPoint = getNormalPoint(predictLoc, a, b);
    //[end]

    //[full] Step 3: Move a little further along the path and set a target.
    PVector dir = PVector.sub(b, a);
    dir.normalize();
    dir.mult(10);
    PVector target = PVector.add(normalPoint, dir);
    //[end]

    //[full] Step 4: If we are off the path,
    // seek that target in order to stay on the path.
    float distance =
      PVector.dist(normalPoint, predictLoc);
    if (distance > p.radius) {
      seek(target);
    }//[end]
  }</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'>  <span class="kt">void</span> <span class="nf">follow</span><span class="o">(</span><span class="n">Path</span> <span class="n">p</span><span class="o">)</span> <span class="o">{</span></span>
<span class='one-line'> </span></pre></code></div>

  <div class='code-comment-pair stretch'><div class='code-comment stretch'> Step 1: Predict the vehicle’s future location.</div><code><pre><span class='one-line'>    <span class="n">PVector</span> <span class="n">predict</span> <span class="o">=</span> <span class="n">vel</span><span class="o">.</span><span class="na">get</span><span class="o">();</span></span>
<span class='one-line'>    <span class="n">predict</span><span class="o">.</span><span class="na">normalize</span><span class="o">();</span></span>
<span class='one-line'>    <span class="n">predict</span><span class="o">.</span><span class="na">mult</span><span class="o">(</span><span class="mi">25</span><span class="o">);</span></span>
<span class='one-line'>    <span class="n">PVector</span> <span class="n">predictLoc</span> <span class="o">=</span> <span class="n">PVector</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">loc</span><span class="o">,</span> <span class="n">predict</span><span class="o">);</span></span></pre></code><div style='position:relative;clear:both;display:block;height:1px;width:100%;'></div></div>

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'> </span></pre></code></div>

  <div class='code-comment-pair stretch'><div class='code-comment stretch'> Step 2: Find the normal point along the path.</div><code><pre><span class='one-line'>    <span class="n">PVector</span> <span class="n">a</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">start</span><span class="o">;</span></span>
<span class='one-line'>    <span class="n">PVector</span> <span class="n">b</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">end</span><span class="o">;</span></span>
<span class='one-line'>    <span class="n">PVector</span> <span class="n">normalPoint</span> <span class="o">=</span> <span class="n">getNormalPoint</span><span class="o">(</span><span class="n">predictLoc</span><span class="o">,</span> <span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="o">);</span></span></pre></code><div style='position:relative;clear:both;display:block;height:1px;width:100%;'></div></div>

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'> </span></pre></code></div>

  <div class='code-comment-pair stretch'><div class='code-comment stretch'> Step 3: Move a little further along the path and set a target.</div><code><pre><span class='one-line'>    <span class="n">PVector</span> <span class="n">dir</span> <span class="o">=</span> <span class="n">PVector</span><span class="o">.</span><span class="na">sub</span><span class="o">(</span><span class="n">b</span><span class="o">,</span> <span class="n">a</span><span class="o">);</span></span>
<span class='one-line'>    <span class="n">dir</span><span class="o">.</span><span class="na">normalize</span><span class="o">();</span></span>
<span class='one-line'>    <span class="n">dir</span><span class="o">.</span><span class="na">mult</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span></span>
<span class='one-line'>    <span class="n">PVector</span> <span class="n">target</span> <span class="o">=</span> <span class="n">PVector</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">normalPoint</span><span class="o">,</span> <span class="n">dir</span><span class="o">);</span></span></pre></code><div style='position:relative;clear:both;display:block;height:1px;width:100%;'></div></div>

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'> </span></pre></code></div>

  <div class='code-comment-pair stretch'><div class='code-comment stretch'> Step 4: If we are off the path,
seek that target in order to stay on the path.</div><code><pre><span class='one-line'>    <span class="kt">float</span> <span class="n">distance</span> <span class="o">=</span></span>
<span class='one-line'>      <span class="n">PVector</span><span class="o">.</span><span class="na">dist</span><span class="o">(</span><span class="n">normalPoint</span><span class="o">,</span> <span class="n">predictLoc</span><span class="o">);</span></span>
<span class='one-line'>    <span class="k">if</span> <span class="o">(</span><span class="n">distance</span> <span class="o">&gt;</span> <span class="n">p</span><span class="o">.</span><span class="na">radius</span><span class="o">)</span> <span class="o">{</span></span>
<span class='one-line'>      <span class="n">seek</span><span class="o">(</span><span class="n">target</span><span class="o">);</span></span>
<span class='one-line'>    <span class="end"><span class="o">}</span></span></span>
<span class='one-line'>  <span class="o">}</span></span></pre></code><div style='position:relative;clear:both;display:block;height:1px;width:100%;'></div></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>Now, you may notice above that instead of using all that dot product/scalar projection code to find the normal point, we instead call a function: <span class="function">getNormalPoint()</span>.   In cases like this, it’s useful to break out the code that performs a specific task (finding a normal point) into a function that it can be used generically in any case where it is required.  The function takes three <span class="klass">PVector</span>s: the first defines a point in Cartesian space and the second and third arguments define a line segment.</p>
<a id="chapter06_figure29" style="display: block;"></a><div class="image-container " >
	
	<img src="imgs/chapter06/ch06_29.png" alt="Nature of Code Image" />
	
	<p class="caption">Figure 6.29</p>
</div>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>  PVector getNormalPoint(PVector p, PVector a, PVector b) {
    // PVector that points from a to p
    PVector ap = PVector.sub(p, a);
    // PVector that points from a to b
    PVector ab = PVector.sub(b, a);

    //[full] Using the dot product for scalar projection
    ab.normalize();
    ab.mult(ap.dot(ab));
    //[end]
    // Finding the normal point along the line segment
    PVector normalPoint = PVector.add(a, ab);

    return normalPoint;
  }</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'>  <span class="n">PVector</span> <span class="nf">getNormalPoint</span><span class="o">(</span><span class="n">PVector</span> <span class="n">p</span><span class="o">,</span> <span class="n">PVector</span> <span class="n">a</span><span class="o">,</span> <span class="n">PVector</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span></span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>PVector that points from a to p</div><code><pre><span class='one-line'>    <span class="n">PVector</span> <span class="n">ap</span> <span class="o">=</span> <span class="n">PVector</span><span class="o">.</span><span class="na">sub</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">a</span><span class="o">);</span></span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>PVector that points from a to b</div><code><pre><span class='one-line'>    <span class="n">PVector</span> <span class="n">ab</span> <span class="o">=</span> <span class="n">PVector</span><span class="o">.</span><span class="na">sub</span><span class="o">(</span><span class="n">b</span><span class="o">,</span> <span class="n">a</span><span class="o">);</span></span>
<span class='one-line'> </span></pre></code></div>

  <div class='code-comment-pair stretch'><div class='code-comment stretch'> Using the dot product for scalar projection</div><code><pre><span class='one-line'>    <span class="n">ab</span><span class="o">.</span><span class="na">normalize</span><span class="o">();</span></span>
<span class='one-line'>    <span class="n">ab</span><span class="o">.</span><span class="na">mult</span><span class="o">(</span><span class="n">ap</span><span class="o">.</span><span class="na">dot</span><span class="o">(</span><span class="n">ab</span><span class="o">));</span></span></pre></code><div style='position:relative;clear:both;display:block;height:1px;width:100%;'></div></div>

  <div class='code-comment-pair '><div class='code-comment '>
Finding the normal point along the line segment</div><code><pre><span class='one-line'>    <span class="n">PVector</span> <span class="n">normalPoint</span> <span class="o">=</span> <span class="n">PVector</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">ab</span><span class="o">);</span></span>
<span class='one-line'> </span>
<span class='one-line'>    <span class="k">return</span> <span class="n">normalPoint</span><span class="o">;</span></span>
<span class='one-line'>  <span class="o">}</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>What do we have so far?  We have a <span class="klass">Path</span> class that defines a path as a line between two points.  We have a <span class="klass">Vehicle</span> class that defines a vehicle that can follow the path (using a steering behavior to seek a target along the path).  What is missing?</p>
<p>Take a deep breath.  We’re almost there.</p>
</section><section><a id="chapter06_section9" style="display: block;"></a><h3 id="69-path-following-with-multiple-segments">6.9 Path Following with Multiple Segments</h3><p><a id="path-followingmultiple-segments-82ae6e70-253f-0130-bcba-7cd1c3f718ad" style="display: block;"></a></p>
<a id="chapter06_figure30" style="display: block;"></a><div class="image-container A Curvy Path" >
	
	<img src="imgs/chapter06/ch06_30.png" alt="Nature of Code Image" />
	
	<p class="caption">Figure 6.30</p>
</div>
<p>We’ve built a great example so far, yes, but it’s pretty darn limiting.  After all, what if we want our path to be something that looks more like:</p>
<a id="chapter06_figure31" style="display: block;"></a><div class="image-container Path defined as line segments" >
	
	<img src="imgs/chapter06/ch06_31.png" alt="Nature of Code Image" />
	
	<p class="caption">Figure 6.31</p>
</div>
<p>While it’s true that we could make this example work for a curved path, we’re much less likely to end up needing a cool compress on our forehead if we stick with line segments.  In the end, we  can always employ the same technique we discovered with Box2D—we can draw whatever fancy curved path we want and approximate it behind the scenes with simple geometric forms.</p>
<p>So, what’s the problem?  If we made path following work with one line segment, how do we make it work with a series of connected line segments?   Let’s take a look again at our vehicle driving along the screen.    Say we arrive at Step 3.</p>
<p><strong><em>Step 3: Find a target point on the path.</em></strong></p>
<p><a id="normal-pointsseries-of-for-path-following-82aea740-253f-0130-bcbb-7cd1c3f718ad" style="display: block;"></a></p>
<p>To find the target, we need to find the normal to the line segment.  But now that we have a series of line segments, we have a series of normal points (see above)!  Which one do we choose?  The solution we’ll employ is to pick the normal point that is (a) closest and (b) on the path itself.</p>
<a id="chapter06_figure32" style="display: block;"></a><div class="image-container " >
	
	<img src="imgs/chapter06/ch06_32.png" alt="Nature of Code Image" />
	
	<p class="caption">Figure 6.32</p>
</div>
<p>If we have a point and an infinitely long line, we’ll always have a normal.  But, as in the path-following example, if we have a point and a line segment, we won’t necessarily find a normal that is on the line segment itself.  So if this happens for any of the segments, we can disqualify those normals.  Once we are left with normals that are on the path itself (only two in the above diagram), we simply pick the one that is closest to our vehicle’s location.</p>
<p>In order to write the code for this, we’ll have to expand our <span class="klass">Path</span> class to have an <span class="klass">ArrayList</span> of points (rather than just two, a start and an end).</p>
<div class="image-container screenshot" >
	
	<img src="imgs/chapter06/ch06_ex6_a.png" alt="Nature of Code Image" />
	
	
</div>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea> class Path {

  // A Path is now an ArrayList of points (PVector objects).
  ArrayList<PVector> points;
  float radius;

  Path() {
    radius = 20;
    points = new ArrayList<PVector>();
  }

  //[full] This function allows us to add points to the path.
  void addPoint(float x, float y) {   .
    PVector point = new PVector(x,y);
    points.add(point);
  }
  //[end]

  //[full] Display the path as a series of points.
  void display() {
    stroke(0);
    noFill();
    beginShape();
    for (PVector v : points) {
      vertex(v.x,v.y);
    }
    endShape();
  }
  //[end]
}</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'> <span class="kd">class</span> <span class="nc">Path</span> <span class="o">{</span></span>
<span class='one-line'> </span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>A Path is now an ArrayList of points (PVector objects).</div><code><pre><span class='one-line'>  <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">PVector</span><span class="o">&gt;</span> <span class="n">points</span><span class="o">;</span></span>
<span class='one-line'>  <span class="kt">float</span> <span class="n">radius</span><span class="o">;</span></span>
<span class='one-line'> </span>
<span class='one-line'>  <span class="n">Path</span><span class="o">()</span> <span class="o">{</span></span>
<span class='one-line'>    <span class="n">radius</span> <span class="o">=</span> <span class="mi">20</span><span class="o">;</span></span>
<span class='one-line'>    <span class="n">points</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">PVector</span><span class="o">&gt;();</span></span>
<span class='one-line'>  <span class="o">}</span></span>
<span class='one-line'> </span></pre></code></div>

  <div class='code-comment-pair stretch'><div class='code-comment stretch'> This function allows us to add points to the path.</div><code><pre><span class='one-line'>  <span class="kt">void</span> <span class="nf">addPoint</span><span class="o">(</span><span class="kt">float</span> <span class="n">x</span><span class="o">,</span> <span class="kt">float</span> <span class="n">y</span><span class="o">)</span> <span class="o">{</span>   <span class="o">.</span></span>
<span class='one-line'>    <span class="n">PVector</span> <span class="n">point</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PVector</span><span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="n">y</span><span class="o">);</span></span>
<span class='one-line'>    <span class="n">points</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">point</span><span class="o">);</span></span>
<span class='one-line'>  <span class="o">}</span></span></pre></code><div style='position:relative;clear:both;display:block;height:1px;width:100%;'></div></div>

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'> </span></pre></code></div>

  <div class='code-comment-pair stretch'><div class='code-comment stretch'> Display the path as a series of points.</div><code><pre><span class='one-line'>  <span class="kt">void</span> <span class="nf">display</span><span class="o">()</span> <span class="o">{</span></span>
<span class='one-line'>    <span class="n">stroke</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span></span>
<span class='one-line'>    <span class="n">noFill</span><span class="o">();</span></span>
<span class='one-line'>    <span class="n">beginShape</span><span class="o">();</span></span>
<span class='one-line'>    <span class="k">for</span> <span class="o">(</span><span class="n">PVector</span> <span class="n">v</span> <span class="o">:</span> <span class="n">points</span><span class="o">)</span> <span class="o">{</span></span>
<span class='one-line'>      <span class="n">vertex</span><span class="o">(</span><span class="n">v</span><span class="o">.</span><span class="na">x</span><span class="o">,</span><span class="n">v</span><span class="o">.</span><span class="na">y</span><span class="o">);</span></span>
<span class='one-line'>    <span class="o">}</span></span>
<span class='one-line'>    <span class="n">endShape</span><span class="o">();</span></span>
<span class='one-line'>  <span class="o">}</span></span></pre></code><div style='position:relative;clear:both;display:block;height:1px;width:100%;'></div></div>

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'><span class="o">}</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>Now that we have the <span class="klass">Path</span> class defined, it’s the vehicle’s turn to deal with multiple line segments.  All we did before was find the normal for one line segment.  We can now find the normals for all the line segments in a loop.</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>for (int i = 0; i < p.points.size()-1; i++) {
  PVector a = p.points.get(i);
  PVector b = p.points.get(i+1);
  //[offset-down] Finding the normals for each line segment
  PVector normalPoint = getNormalPoint(predictLoc, a, b);</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'><span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">.</span><span class="na">points</span><span class="o">.</span><span class="na">size</span><span class="o">()-</span><span class="mi">1</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span></span>
<span class='one-line'>  <span class="n">PVector</span> <span class="n">a</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">points</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span></span>
<span class='one-line'>  <span class="n">PVector</span> <span class="n">b</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">points</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">);</span></span></pre></code></div>

  <div class='code-comment-pair offset-down'><div class='code-comment '> Finding the normals for each line segment</div><code><pre><span class='one-line'>  <span class="n">PVector</span> <span class="n">normalPoint</span> <span class="o">=</span> <span class="n">getNormalPoint</span><span class="o">(</span><span class="n">predictLoc</span><span class="o">,</span> <span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="o">);</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>Then we should make sure the normal point is actually between points <span class="var">a</span> and <span class="var">b</span>.  Since we know our path goes from left to right in this example, we can test if the <em>x</em> component of <span class="var">normalPoint</span> is outside the <em>x</em> components of <span class="var">a</span> and <span class="var">b</span>.</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>   if (normalPoint.x < a.x || normalPoint.x > b.x) {
      // Use the end point of the segment
      // as our normal point if we can’t find one.
      normalPoint = b.get();
   }</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'>   <span class="k">if</span> <span class="o">(</span><span class="n">normalPoint</span><span class="o">.</span><span class="na">x</span> <span class="o">&lt;</span> <span class="n">a</span><span class="o">.</span><span class="na">x</span> <span class="o">||</span> <span class="n">normalPoint</span><span class="o">.</span><span class="na">x</span> <span class="o">&gt;</span> <span class="n">b</span><span class="o">.</span><span class="na">x</span><span class="o">)</span> <span class="o">{</span></span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>Use the end point of the segment
as our normal point if we can’t find one.</div><code><pre><span class='one-line'>      <span class="n">normalPoint</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="na">get</span><span class="o">();</span></span>
<span class='one-line'>   <span class="o">}</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>As a little trick, we’ll say that if it’s not within the line segment, let’s just pretend the end point of that line segment is the normal.  This will ensure that our vehicle always stays on the path, even if it strays out of the bounds of our line segments.</p>
<p>Finally, we’ll need to make sure we find the normal point that is closest to our vehicle.  To accomplish this, we start with a very high “world record” distance and iterate through each normal point to see if it beats the record (i.e. is less than).  Each time a normal point beats the record, the world record is updated and the winning point is stored in a variable named <span class="var">target</span>.  At the end of the loop, we’ll have the closest normal point in that variable.</p>
<div class="image-container screenshot" >
	
	<canvas data-processing-sources="../NOC%20examples%20-%20processing/chp06/NOC_6_06_PathFollowing/chp06/NOC_6_06_PathFollowing.pde ../NOC%20examples%20-%20processing/chp06/NOC_6_06_PathFollowing/Path.pde ../NOC%20examples%20-%20processing/chp06/NOC_6_06_PathFollowing/Vehicle.pde" class="screenshot">
		<p>Your browser does not support the canvas tag.</p>
	</canvas>
  <div class="sketch-controls">
    <button class="reset">RESET</button>
    <button class="pause">PAUSE</button>
  </div>
	
	
</div>
<p><a id="chapter06_example6" style="display: block;"></a><span class="example">Example 6.6: Path following</span></p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>PVector target = null;
// Start with a very high record
// that can easily be beaten.
float worldRecord = 1000000;

for (int i = 0; i < p.points.size()-1; i++) {
  PVector a = p.points.get(i);
  PVector b = p.points.get(i+1);
  PVector normalPoint = getNormalPoint(predictLoc, a, b);
  if (normalPoint.x < a.x || normalPoint.x > b.x) {
    normalPoint = b.get();
  }

  float distance = PVector.dist(predictLoc, normalPoint);

  //[full] If we beat the record, then
  // this should be our target!
  if (distance < worldRecord) {
    worldRecord = distance;
    target = normalPoint.get();
  }
  //[end]
}</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'><span class="n">PVector</span> <span class="n">target</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span></span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>Start with a very high record
that can easily be beaten.</div><code><pre><span class='one-line'><span class="kt">float</span> <span class="n">worldRecord</span> <span class="o">=</span> <span class="mi">1000000</span><span class="o">;</span></span>
<span class='one-line'> </span>
<span class='one-line'><span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">.</span><span class="na">points</span><span class="o">.</span><span class="na">size</span><span class="o">()-</span><span class="mi">1</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span></span>
<span class='one-line'>  <span class="n">PVector</span> <span class="n">a</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">points</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span></span>
<span class='one-line'>  <span class="n">PVector</span> <span class="n">b</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">points</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">);</span></span>
<span class='one-line'>  <span class="n">PVector</span> <span class="n">normalPoint</span> <span class="o">=</span> <span class="n">getNormalPoint</span><span class="o">(</span><span class="n">predictLoc</span><span class="o">,</span> <span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="o">);</span></span>
<span class='one-line'>  <span class="k">if</span> <span class="o">(</span><span class="n">normalPoint</span><span class="o">.</span><span class="na">x</span> <span class="o">&lt;</span> <span class="n">a</span><span class="o">.</span><span class="na">x</span> <span class="o">||</span> <span class="n">normalPoint</span><span class="o">.</span><span class="na">x</span> <span class="o">&gt;</span> <span class="n">b</span><span class="o">.</span><span class="na">x</span><span class="o">)</span> <span class="o">{</span></span>
<span class='one-line'>    <span class="n">normalPoint</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="na">get</span><span class="o">();</span></span>
<span class='one-line'>  <span class="o">}</span></span>
<span class='one-line'> </span>
<span class='one-line'>  <span class="kt">float</span> <span class="n">distance</span> <span class="o">=</span> <span class="n">PVector</span><span class="o">.</span><span class="na">dist</span><span class="o">(</span><span class="n">predictLoc</span><span class="o">,</span> <span class="n">normalPoint</span><span class="o">);</span></span>
<span class='one-line'> </span></pre></code></div>

  <div class='code-comment-pair stretch'><div class='code-comment stretch'> If we beat the record, then
this should be our target!</div><code><pre><span class='one-line'>  <span class="k">if</span> <span class="o">(</span><span class="n">distance</span> <span class="o">&lt;</span> <span class="n">worldRecord</span><span class="o">)</span> <span class="o">{</span></span>
<span class='one-line'>    <span class="n">worldRecord</span> <span class="o">=</span> <span class="n">distance</span><span class="o">;</span></span>
<span class='one-line'>    <span class="n">target</span> <span class="o">=</span> <span class="n">normalPoint</span><span class="o">.</span><span class="na">get</span><span class="o">();</span></span>
<span class='one-line'>  <span class="o">}</span></span></pre></code><div style='position:relative;clear:both;display:block;height:1px;width:100%;'></div></div>

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'><span class="o">}</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><div class="example">
  <a id="chapter06_exercise10" style="display: block;"></a><h4 id="exercise-610">Exercise 6.10</h4><p>Update the path-following example so that the path can go in any direction.  (Hint: you’ll need to use the <span class="function">min()</span> and <span class="function">max()</span> function when determining if the normal point is inside the line segment.)</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>if (normalPoint.x < ____(____,____) || normalPoint.x > ____(____,____)) {
  normalPoint = b.get();
}</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'><span class="k">if</span> <span class="o">(</span><span class="n">normalPoint</span><span class="o">.</span><span class="na">x</span> <span class="o">&lt;</span> <span class="n">____</span><span class="o">(</span><span class="n">____</span><span class="o">,</span><span class="n">____</span><span class="o">)</span> <span class="o">||</span> <span class="n">normalPoint</span><span class="o">.</span><span class="na">x</span> <span class="o">&gt;</span> <span class="n">____</span><span class="o">(</span><span class="n">____</span><span class="o">,</span><span class="n">____</span><span class="o">))</span> <span class="o">{</span></span>
<span class='one-line'>  <span class="n">normalPoint</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="na">get</span><span class="o">();</span></span>
<span class='one-line'><span class="o">}</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div>
</div><div class="example">
  <a id="chapter06_exercise11" style="display: block;"></a><h4 id="exercise-611">Exercise 6.11</h4><p>Create a path that changes over time.  Can the points that define the path itself have their own steering behaviors?</p>

</div></section><section><a id="chapter06_section10" style="display: block;"></a><h3 id="610-complex-systems">6.10  Complex Systems</h3><p><a id="autonomous-agentscomplex-systems-and-82af70b0-253f-0130-bcbc-7cd1c3f718ad" style="display: block;"></a><a id="complex-systems-82af8550-253f-0130-bcbd-7cd1c3f718ad" style="display: block;"></a></p>
<p>Remember our purpose?  To breathe life into the things that move around our Processing windows?  By learning to write the code for an autonomous agent and building a series of examples of individual behaviors, hopefully our souls feel a little more full.  But this is no place to stop and rest on our laurels.  We’re just getting started.   After all, there is a deeper purpose at work here.  Yes, a vehicle is a simulated being that makes decisions about how to seek and flow and follow.  But what is a life led alone, without the love and support of others?  Our purpose here is not only to build individual behaviors for our vehicles, but to put our vehicles into systems of many vehicles and allow those vehicles to interact with each other.</p>
<p><a id="ants-modeling-for-82af9c70-253f-0130-bcbe-7cd1c3f718ad" style="display: block;"></a><a id="complex-systemssuperorganisms-82afabb0-253f-0130-bcbf-7cd1c3f718ad" style="display: block;"></a><a id="natural-phenomenaants-modeling-82afbe10-253f-0130-bcc0-7cd1c3f718ad" style="display: block;"></a><a id="superorganisms-82afcf50-253f-0130-bcc1-7cd1c3f718ad" style="display: block;"></a></p>
<p>Let’s think about a tiny, crawling ant—one single ant.  An ant is an autonomous agent; it can perceive its environment (using antennae to gather information about the direction and strength of chemical signals) and make decisions about how to move based on those signals.  But can a single ant acting alone build a nest, gather food, defend its queen?   An ant is a simple unit and can only perceive its immediate environment.  A colony of ants, however, is a sophisticated complex system, a “superorganism” in which the components work together to accomplish difficult and complicated goals.</p>
<p>We want to take what we’ve learned during the process of building autonomous agents in Processing into simulations that involve many agents operating in parallel—agents that have an ability to perceive not only their physical environment but also the actions of their fellow agents, and then act accordingly.  We want to create complex systems in Processing.</p>
<p>What is a complex system?  A complex system is typically defined as a system that is “more than the sum of its parts.”  While the individual elements of the system may be incredibly simple and easily understood, the behavior of the system as a whole can be highly complex, intelligent, and difficult to predict.  Here are three key principles of complex systems.</p>
<p><a id="complex-systemskey-principles-of-82afe760-253f-0130-bcc2-7cd1c3f718ad" style="display: block;"></a><a id="short-range-relationshipscomplex-systems-82affbc0-253f-0130-bcc3-7cd1c3f718ad" style="display: block;"></a></p>
<div class="list">
	
	<ul>
		
			<li><p><strong><em>Simple units with short-range relationships.</em></strong>  This is what we’ve been building all along: vehicles that have a limited perception of their environment.
</p>
</li>
		
			<li><p><strong><em>Simple units operate in parallel.</em></strong>   This is what we need to simulate in code.  For every cycle through Processing’s <span class="function">draw()</span> loop, each unit will decide how to move (to create the appearance of them all working in parallel).
</p>
</li>
		
			<li><p><strong><em>System as a whole exhibits emergent phenomena.</em></strong>   Out of the interactions between these simple units emerges complex behavior, patterns, and intelligence.  Here we’re talking about the result we are hoping for in our sketches.  Yes, we know this happens in nature (ant colonies, termites, migration patterns, earthquakes, snowflakes, etc.), but can we achieve the same result in our Processing sketches?
</p>
</li>
		
	</ul>
</div><p>Following are three additional features of complex systems that will help frame the discussion, as well as provide guidelines for features we will want to include in our software simulations.  It’s important to acknowledge that this is a fuzzy set of characteristics and not all complex systems have all of them.</p>
<p><a id="complex-systemsnon-linearity-component-82b04020-253f-0130-bcc4-7cd1c3f718ad" style="display: block;"></a></p>
<div class="list">
	
	<ul>
		
			<li><p><strong><em>Non-linearity.</em></strong>  This aspect of complex systems is often casually referred to as “the butterfly effect,” coined by mathematician and meteorologist Edward Norton Lorenz, a pioneer in the study of chaos theory.  In 1961, Lorenz was running a computer weather simulation for the second time and, perhaps to save a little time, typed in a starting value of 0.506 instead of 0.506127.   The end result was completely different from the first result of the simulation.   In other words, the theory is that a single butterfly flapping its wings on the other side of the world could cause a massive weather shift and ruin our weekend at the beach.  We call it “non-linear” because there isn’t a linear relationship between a change in initial conditions and a change in outcome.   A small change in initial conditions can have a massive effect on the outcome.  Non-linear systems are a superset of chaotic systems.  In the next chapter, we’ll see how even in a system of many zeros and ones, if we change just one bit, the result will be completely different.
</p>
</li>
		
	</ul>
</div><p><a id="complex-systemscompetitioncooperation-component-82b06450-253f-0130-bcc5-7cd1c3f718ad" style="display: block;"></a></p>
<div class="list">
	
	<ul>
		
			<li><p><strong><em>Competition and cooperation.</em></strong>  One of the things that often makes a complex system tick is the presence of both competition and cooperation between the elements.   In our upcoming flocking system, we will have three rules—alignment, cohesion, and separation.  Alignment and cohesion will ask the elements to “cooperate”—i.e. work together to stay together and move together.  Separation, however, will ask the elements to “compete” for space.  As we get to the flocking system, try taking out the cooperation or the competition and you’ll see how you are left without complexity. Competition and cooperation are found in living complex systems, but not in non-living complex systems like the weather.
</p>
</li>
		
	</ul>
</div><p><a id="complex-systemsfeedback-component-82b08ea0-253f-0130-bcc6-7cd1c3f718ad" style="display: block;"></a></p>
<div class="list">
	
	<ul>
		
			<li><p><strong><em>Feedback.</em></strong> Complex systems often include a feedback loop where the the output of the system is fed back into the system to influence its behavior in a positive or negative direction. Let’s say you drive to work each day because the price of gas is low.  In fact, everyone drives to work.  The price of gas goes up as demand begins to exceed supply.  You, and everyone else, decide to take the train to work because driving is too expensive.  And the price of gas declines as the demand declines.  The price of gas is both the input of the system (determining whether you choose to drive or ride the train) and the output (the demand that results from your choice).  I should note that economic models (like supply/demand, the stock market) are one example of a human complex system.  Others include fads and trends, elections, crowds, and traffic flow.
</p>
</li>
		
	</ul>
</div><p>Complexity will serve as a theme for the remaining content in this book. In this chapter, we’ll begin by adding one more feature to our <span class="klass">Vehicle</span> class: an ability to look at neighboring vehicles.</p>
</section><section><a id="chapter06_section11" style="display: block;"></a><h3 id="611-group-behaviors-or-lets-not-run-into-each-other">6.11  Group Behaviors (or: Let’s not run into each other)</h3><p><a id="complex-systemsgroup-behavior-82b0da80-253f-0130-bcc7-7cd1c3f718ad" style="display: block;"></a><a id="group-behavior-82b39f70-253f-0130-bcc8-7cd1c3f718ad" style="display: block;"></a><a id="natural-phenomenagroup-behavior-82b3b2a0-253f-0130-bcc9-7cd1c3f718ad" style="display: block;"></a></p>
<p>A group is certainly not a new concept. We’ve done this before—in Chapter 4, where we developed a framework for managing collections of particles in a <span class="klass">ParticleSystem</span> class.   There, we stored a list of particles in an <span class="klass">ArrayList</span>.  We’ll do the same thing here: store a bunch of <span class="klass">Vehicle</span> objects in an <span class="klass">ArrayList</span>.</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>// Declare an ArrayList of Vehicle objects.
ArrayList<Vehicle> vehicles;

void setup() {
  // Initialize and fill the ArrayList
  // with a bunch of Vehicles.
  vehicles = new ArrayList<Vehicle>;
  for (int i = 0; i < 100; i++) {
    vehicles.add(new Vehicle(random(width),random(height)));
  }
}</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair '><div class='code-comment '>Declare an ArrayList of Vehicle objects.</div><code><pre><span class='one-line'><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Vehicle</span><span class="o">&gt;</span> <span class="n">vehicles</span><span class="o">;</span></span>
<span class='one-line'> </span>
<span class='one-line'><span class="kt">void</span> <span class="nf">setup</span><span class="o">()</span> <span class="o">{</span></span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>Initialize and fill the ArrayList
with a bunch of Vehicles.</div><code><pre><span class='one-line'>  <span class="n">vehicles</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Vehicle</span><span class="o">&gt;;</span></span>
<span class='one-line'>  <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span></span>
<span class='one-line'>    <span class="n">vehicles</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">Vehicle</span><span class="o">(</span><span class="n">random</span><span class="o">(</span><span class="n">width</span><span class="o">),</span><span class="n">random</span><span class="o">(</span><span class="n">height</span><span class="o">)));</span></span>
<span class='one-line'>  <span class="o">}</span></span>
<span class='one-line'><span class="o">}</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>Now when it comes time to deal with all the vehicles in <span class="function">draw()</span>, we simply loop through all of them and call the necessary functions.</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>void draw(){
  for (Vehicle v : vehicles) {
    v.update();
    v.display();
  }
}</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'><span class="kt">void</span> <span class="nf">draw</span><span class="o">(){</span></span>
<span class='one-line'>  <span class="k">for</span> <span class="o">(</span><span class="n">Vehicle</span> <span class="n">v</span> <span class="o">:</span> <span class="n">vehicles</span><span class="o">)</span> <span class="o">{</span></span>
<span class='one-line'>    <span class="n">v</span><span class="o">.</span><span class="na">update</span><span class="o">();</span></span>
<span class='one-line'>    <span class="n">v</span><span class="o">.</span><span class="na">display</span><span class="o">();</span></span>
<span class='one-line'>  <span class="o">}</span></span>
<span class='one-line'><span class="o">}</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>OK, so maybe we want to add a behavior, a force to be applied to all the vehicles.  This could be seeking the mouse.</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>    v.seek(mouseX,mouseY);</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'>    <span class="n">v</span><span class="o">.</span><span class="na">seek</span><span class="o">(</span><span class="n">mouseX</span><span class="o">,</span><span class="n">mouseY</span><span class="o">);</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p><a id="collisionsavoiding-in-group-behavior-82b418e0-253f-0130-bcca-7cd1c3f718ad" style="display: block;"></a><a id="group-behaviorcollisions-avoiding-82b435a0-253f-0130-bccb-7cd1c3f718ad" style="display: block;"></a></p>
<p>But that’s an individual behavior.  We’ve already spent thirty-odd pages worrying about individual behaviors.  We’re here because we want to apply a group behavior.  Let’s begin with separation, a behavior that commands, “Avoid colliding with your neighbors!”</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>    v.separate();</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'>    <span class="n">v</span><span class="o">.</span><span class="na">separate</span><span class="o">();</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>Is that right?  It sounds good, but it’s not.  What’s missing?  In the case of seek, we said, “Seek <span class="var">mouseX</span> and <span class="var">mouseY</span>.”  In the case of separate, we’re saying “separate from <em>everyone else</em>.”  Who is everyone else?  It’s the list of all the other vehicles.</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>    v.separate(vehicles);</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'>    <span class="n">v</span><span class="o">.</span><span class="na">separate</span><span class="o">(</span><span class="n">vehicles</span><span class="o">);</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>This is the big leap beyond what we did before with particle systems.  Instead of having each element (particle or vehicle) operate on its own, we’re now saying, “Hey you, the vehicle! When it comes time for you to operate, you need to operate with an awareness of everyone else. So I’m going to go ahead and pass you the <span class="klass">ArrayList</span> of everyone else.”</p>
<p>This is how we’ve mapped out <span class="function">setup()</span> and <span class="function">draw()</span> to deal with a group behavior.</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>ArrayList<Vehicle> vehicles;

void setup() {
  size(320,240);
  vehicles = new ArrayList<Vehicle>();
  for (int i = 0; i < 100; i++) {
    vehicles.add(new Vehicle(random(width),random(height)));
  }
}

void draw() {
  background(255);

  for (Vehicle v : vehicles) {
    // This is really the only new thing we’re doing in this section.  We’re asking
    // a Vehicle object to examine all the other vehicles in the process of calculating a
    // separation force.
    v.separate(vehicles); //[bold]
    v.update();
    v.display();
  }
}</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Vehicle</span><span class="o">&gt;</span> <span class="n">vehicles</span><span class="o">;</span></span>
<span class='one-line'> </span>
<span class='one-line'><span class="kt">void</span> <span class="nf">setup</span><span class="o">()</span> <span class="o">{</span></span>
<span class='one-line'>  <span class="n">size</span><span class="o">(</span><span class="mi">320</span><span class="o">,</span><span class="mi">240</span><span class="o">);</span></span>
<span class='one-line'>  <span class="n">vehicles</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Vehicle</span><span class="o">&gt;();</span></span>
<span class='one-line'>  <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span></span>
<span class='one-line'>    <span class="n">vehicles</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">Vehicle</span><span class="o">(</span><span class="n">random</span><span class="o">(</span><span class="n">width</span><span class="o">),</span><span class="n">random</span><span class="o">(</span><span class="n">height</span><span class="o">)));</span></span>
<span class='one-line'>  <span class="o">}</span></span>
<span class='one-line'><span class="o">}</span></span>
<span class='one-line'> </span>
<span class='one-line'><span class="kt">void</span> <span class="nf">draw</span><span class="o">()</span> <span class="o">{</span></span>
<span class='one-line'>  <span class="n">background</span><span class="o">(</span><span class="mi">255</span><span class="o">);</span></span>
<span class='one-line'> </span>
<span class='one-line'>  <span class="k">for</span> <span class="o">(</span><span class="n">Vehicle</span> <span class="n">v</span> <span class="o">:</span> <span class="n">vehicles</span><span class="o">)</span> <span class="o">{</span></span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>This is really the only new thing we’re doing in this section.  We’re asking
a Vehicle object to examine all the other vehicles in the process of calculating a
separation force.</div><code><pre><span class='one-line'>    <strong><span class="n">v</span><span class="o">.</span><span class="na">separate</span><span class="o">(</span><span class="n">vehicles</span><span class="o">);</span></strong></span>
<span class='one-line'>    <span class="n">v</span><span class="o">.</span><span class="na">update</span><span class="o">();</span></span>
<span class='one-line'>    <span class="n">v</span><span class="o">.</span><span class="na">display</span><span class="o">();</span></span>
<span class='one-line'>  <span class="o">}</span></span>
<span class='one-line'><span class="o">}</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><a id="chapter06_figure33" style="display: block;"></a><div class="image-container half-width-right" >
	
	<img src="imgs/chapter06/ch06_33.png" alt="Nature of Code Image" />
	
	<p class="caption">Figure 6.33</p>
</div>
<p><a id="repulsiongroup-behavior-and-82b49e70-253f-0130-bccc-7cd1c3f718ad" style="display: block;"></a><a id="steering-behaviorsgroup-behavior-and-82b4b1b0-253f-0130-bccd-7cd1c3f718ad" style="display: block;"></a></p>
<p>Of course, this is just the beginning.  The real work happens inside the <span class="function">separate()</span> function itself.  Let’s figure out how we want to define separation. Reynolds states: “Steer to avoid crowding.” In other words, if a given vehicle is too close to you, steer away from that vehicle.  Sound familiar?  Remember the seek behavior where a vehicle steers towards a target?  Reverse that force and we have the flee behavior.</p>
<a id="chapter06_figure34" style="display: block;"></a><div class="image-container half-width-right" >
	
	<img src="imgs/chapter06/ch06_34.png" alt="Nature of Code Image" />
	
	<p class="caption">Figure 6.34</p>
</div>
<p>But what if more than one vehicle is too close?  In this case, we’ll define separation as the average of all the vectors pointing away from any close vehicles.</p>
<p>Let’s begin to write the code.  As we just worked out, we’re writing a function called <span class="function">separate()</span> that receives an <span class="klass">ArrayList</span> of Vehicle objects as an argument.</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>void separate (ArrayList<Vehicle> vehicles) {

}</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'><span class="kt">void</span> <span class="nf">separate</span> <span class="o">(</span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Vehicle</span><span class="o">&gt;</span> <span class="n">vehicles</span><span class="o">)</span> <span class="o">{</span></span>
<span class='one-line'> </span>
<span class='one-line'><span class="o">}</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>Inside this function, we’re going to loop through all of the vehicles and see if any are too close.</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>  // This variable specifies how close is too close.
  float desiredseparation = 20;

  for (Vehicle other : vehicles) {

    //[offset-down] What is the distance between me and another Vehicle?
    float d = PVector.dist(location, other.location);


    if ((d > 0) && (d < desiredseparation)) {
      // Any code here will be executed if the Vehicle is within 20 pixels.

    }
  }</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair '><div class='code-comment '>This variable specifies how close is too close.</div><code><pre><span class='one-line'>  <span class="kt">float</span> <span class="n">desiredseparation</span> <span class="o">=</span> <span class="mi">20</span><span class="o">;</span></span>
<span class='one-line'> </span>
<span class='one-line'>  <span class="k">for</span> <span class="o">(</span><span class="n">Vehicle</span> <span class="n">other</span> <span class="o">:</span> <span class="n">vehicles</span><span class="o">)</span> <span class="o">{</span></span>
<span class='one-line'> </span></pre></code></div>

  <div class='code-comment-pair offset-down'><div class='code-comment '> What is the distance between me and another Vehicle?</div><code><pre><span class='one-line'>    <span class="kt">float</span> <span class="n">d</span> <span class="o">=</span> <span class="n">PVector</span><span class="o">.</span><span class="na">dist</span><span class="o">(</span><span class="n">location</span><span class="o">,</span> <span class="n">other</span><span class="o">.</span><span class="na">location</span><span class="o">);</span></span>
<span class='one-line'> </span>
<span class='one-line'> </span>
<span class='one-line'>    <span class="k">if</span> <span class="o">((</span><span class="n">d</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">d</span> <span class="o">&lt;</span> <span class="n">desiredseparation</span><span class="o">))</span> <span class="o">{</span></span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>Any code here will be executed if the Vehicle is within 20 pixels.</div><code><pre><span class='one-line'> </span>
<span class='one-line'>    <span class="o">}</span></span>
<span class='one-line'>  <span class="o">}</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>Notice how in the above code, we are not only checking if the distance is less than a desired separation (i.e. too close!), but also if the distance is greater than zero.  This is a little trick that makes sure we don’t ask a vehicle to separate from itself.   Remember, all the vehicles are in the <span class="klass">ArrayList</span>, so if you aren’t careful you’ll be comparing each vehicle to itself!</p>
<p>Once we know that two vehicles are too close, we need to make a vector that points away from the offending vehicle.</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>    if ((d > 0) && (d < desiredseparation)) {
      //[offset-down] A PVector pointing away from the other’s location
      PVector diff = PVector.sub(location, other.location);
      diff.normalize();
    }</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'>    <span class="k">if</span> <span class="o">((</span><span class="n">d</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">d</span> <span class="o">&lt;</span> <span class="n">desiredseparation</span><span class="o">))</span> <span class="o">{</span></span></pre></code></div>

  <div class='code-comment-pair offset-down'><div class='code-comment '> A PVector pointing away from the other’s location</div><code><pre><span class='one-line'>      <span class="n">PVector</span> <span class="n">diff</span> <span class="o">=</span> <span class="n">PVector</span><span class="o">.</span><span class="na">sub</span><span class="o">(</span><span class="n">location</span><span class="o">,</span> <span class="n">other</span><span class="o">.</span><span class="na">location</span><span class="o">);</span></span>
<span class='one-line'>      <span class="n">diff</span><span class="o">.</span><span class="na">normalize</span><span class="o">();</span></span>
<span class='one-line'>    <span class="o">}</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>This is not enough.  We have that vector now, but we need to make sure we calculate the average of all vectors pointing away from close vehicles.   How do we compute average?  We add up all the vectors and divide by the total.</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>  // Start with an empty PVector.
  PVector sum = new PVector();  //[bold]
  int count = 0;  //[bold]
  // We have to keep track of how many Vehicles are too close.
  for (Vehicle other : vehicles) {

    float d = PVector.dist(location, other.location);
    if ((d > 0) && (d < desiredseparation)) {
      PVector diff = PVector.sub(location, other.location); //[bold]
      diff.normalize();
      // Add all the vectors together and increment the count.
      sum.add(diff); //[bold]
      count++;
    }
  }

  // We have to make sure we found at least one close
  // vehicle.  We don’t want to bother doing anything
  // if nothing is too close (not to mention we can’t
  // divide by zero!)
  if (count > 0) { //[bold]
    sum.div(count); //[bold]
  } //[bold]</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair '><div class='code-comment '>Start with an empty PVector.</div><code><pre><span class='one-line'>  <strong><span class="n">PVector</span> <span class="n">sum</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PVector</span><span class="o">();</span></strong></span>
<span class='one-line'>  <strong><span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span></strong></span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>We have to keep track of how many Vehicles are too close.</div><code><pre><span class='one-line'>  <span class="k">for</span> <span class="o">(</span><span class="n">Vehicle</span> <span class="n">other</span> <span class="o">:</span> <span class="n">vehicles</span><span class="o">)</span> <span class="o">{</span></span>
<span class='one-line'> </span>
<span class='one-line'>    <span class="kt">float</span> <span class="n">d</span> <span class="o">=</span> <span class="n">PVector</span><span class="o">.</span><span class="na">dist</span><span class="o">(</span><span class="n">location</span><span class="o">,</span> <span class="n">other</span><span class="o">.</span><span class="na">location</span><span class="o">);</span></span>
<span class='one-line'>    <span class="k">if</span> <span class="o">((</span><span class="n">d</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">d</span> <span class="o">&lt;</span> <span class="n">desiredseparation</span><span class="o">))</span> <span class="o">{</span></span>
<span class='one-line'>      <strong><span class="n">PVector</span> <span class="n">diff</span> <span class="o">=</span> <span class="n">PVector</span><span class="o">.</span><span class="na">sub</span><span class="o">(</span><span class="n">location</span><span class="o">,</span> <span class="n">other</span><span class="o">.</span><span class="na">location</span><span class="o">);</span></strong></span>
<span class='one-line'>      <span class="n">diff</span><span class="o">.</span><span class="na">normalize</span><span class="o">();</span></span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>Add all the vectors together and increment the count.</div><code><pre><span class='one-line'>      <strong><span class="n">sum</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">diff</span><span class="o">);</span></strong></span>
<span class='one-line'>      <span class="n">count</span><span class="o">++;</span></span>
<span class='one-line'>    <span class="o">}</span></span>
<span class='one-line'>  <span class="o">}</span></span>
<span class='one-line'> </span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>We have to make sure we found at least one close
vehicle.  We don’t want to bother doing anything
if nothing is too close (not to mention we can’t
divide by zero!)</div><code><pre><span class='one-line'>  <strong><span class="k">if</span> <span class="o">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span></strong></span>
<span class='one-line'>    <strong><span class="n">sum</span><span class="o">.</span><span class="na">div</span><span class="o">(</span><span class="n">count</span><span class="o">);</span></strong></span>
<span class='one-line'>  <strong><span class="o">}</span></strong></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>Once we have the average vector (stored in the <span class="klass">PVector</span> object “sum”), that <span class="klass">PVector</span> can be scaled to maximum speed and become our desired velocity—we <em>desire</em> to move in that direction at maximum speed!   And once we have the desired velocity, it’s the same old Reynolds story: steering equals desired minus velocity.</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>  if (count > 0) {
    sum.div(count);

    // Scale average to maxspeed
    // (this becomes desired).
    sum.setMag(maxspeed);

    // Reynolds’s steering formula
    PVector steer = PVector.sub(sum,vel);
    steer.limit(maxforce);

    // Apply the force to the Vehicle’s
    // acceleration.
    applyForce(steer);
  }</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'>  <span class="k">if</span> <span class="o">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span></span>
<span class='one-line'>    <span class="n">sum</span><span class="o">.</span><span class="na">div</span><span class="o">(</span><span class="n">count</span><span class="o">);</span></span>
<span class='one-line'> </span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>Scale average to maxspeed
(this becomes desired).</div><code><pre><span class='one-line'>    <span class="n">sum</span><span class="o">.</span><span class="na">setMag</span><span class="o">(</span><span class="n">maxspeed</span><span class="o">);</span></span>
<span class='one-line'> </span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>Reynolds’s steering formula</div><code><pre><span class='one-line'>    <span class="n">PVector</span> <span class="n">steer</span> <span class="o">=</span> <span class="n">PVector</span><span class="o">.</span><span class="na">sub</span><span class="o">(</span><span class="n">sum</span><span class="o">,</span><span class="n">vel</span><span class="o">);</span></span>
<span class='one-line'>    <span class="n">steer</span><span class="o">.</span><span class="na">limit</span><span class="o">(</span><span class="n">maxforce</span><span class="o">);</span></span>
<span class='one-line'> </span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>Apply the force to the Vehicle’s
acceleration.</div><code><pre><span class='one-line'>    <span class="n">applyForce</span><span class="o">(</span><span class="n">steer</span><span class="o">);</span></span>
<span class='one-line'>  <span class="o">}</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>Let’s see the function in its entirety.  There are two additional improvements, noted in the code comments.</p>
<div class="image-container screenshot" >
	
	<canvas data-processing-sources="../NOC%20examples%20-%20processing/chp06/NOC_6_07_Separation/NOC_6_07_Separation.pde ../NOC%20examples%20-%20processing/chp06/NOC_6_07_Separation/Vehicle.pde" class="screenshot">
		<p>Your browser does not support the canvas tag.</p>
	</canvas>
  <div class="sketch-controls">
    <button class="reset">RESET</button>
    <button class="pause">PAUSE</button>
  </div>
	
	
</div>
<p><a id="chapter06_example7" style="display: block;"></a><span class="example">Example 6.7: Group behavior: Separation</span></p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>  void separate (ArrayList<Vehicle> vehicles) {
    // Note how the desired separation is based
    // on the Vehicle’s size.
    float desiredseparation = r*2; //[bold]
    PVector sum = new PVector();
    int count = 0;
    for (Vehicle other : vehicles) {
      float d = PVector.dist(location, other.location);
      if ((d > 0) && (d < desiredseparation)) {
        PVector diff = PVector.sub(location, other.location);
        diff.normalize();
        // What is the magnitude of the PVector
        // pointing away from the other vehicle?
        // The closer it is, the more we should flee.
        // The farther, the less. So we divide
        // by the distance to weight it appropriately.
        diff.div(d);  //[bold]
        sum.add(diff);
        count++;

      }
    }
    if (count > 0) {
      sum.div(count);
      sum.normalize();
      sum.mult(maxspeed);
      PVector steer = PVector.sub(sum, vel);
      steer.limit(maxforce);
      applyForce(steer);
    }

  }</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'>  <span class="kt">void</span> <span class="nf">separate</span> <span class="o">(</span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Vehicle</span><span class="o">&gt;</span> <span class="n">vehicles</span><span class="o">)</span> <span class="o">{</span></span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>Note how the desired separation is based
on the Vehicle’s size.</div><code><pre><span class='one-line'>    <strong><span class="kt">float</span> <span class="n">desiredseparation</span> <span class="o">=</span> <span class="n">r</span><span class="o">*</span><span class="mi">2</span><span class="o">;</span></strong></span>
<span class='one-line'>    <span class="n">PVector</span> <span class="n">sum</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PVector</span><span class="o">();</span></span>
<span class='one-line'>    <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span></span>
<span class='one-line'>    <span class="k">for</span> <span class="o">(</span><span class="n">Vehicle</span> <span class="n">other</span> <span class="o">:</span> <span class="n">vehicles</span><span class="o">)</span> <span class="o">{</span></span>
<span class='one-line'>      <span class="kt">float</span> <span class="n">d</span> <span class="o">=</span> <span class="n">PVector</span><span class="o">.</span><span class="na">dist</span><span class="o">(</span><span class="n">location</span><span class="o">,</span> <span class="n">other</span><span class="o">.</span><span class="na">location</span><span class="o">);</span></span>
<span class='one-line'>      <span class="k">if</span> <span class="o">((</span><span class="n">d</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">d</span> <span class="o">&lt;</span> <span class="n">desiredseparation</span><span class="o">))</span> <span class="o">{</span></span>
<span class='one-line'>        <span class="n">PVector</span> <span class="n">diff</span> <span class="o">=</span> <span class="n">PVector</span><span class="o">.</span><span class="na">sub</span><span class="o">(</span><span class="n">location</span><span class="o">,</span> <span class="n">other</span><span class="o">.</span><span class="na">location</span><span class="o">);</span></span>
<span class='one-line'>        <span class="n">diff</span><span class="o">.</span><span class="na">normalize</span><span class="o">();</span></span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>What is the magnitude of the PVector
pointing away from the other vehicle?
The closer it is, the more we should flee.
The farther, the less. So we divide
by the distance to weight it appropriately.</div><code><pre><span class='one-line'>        <strong><span class="n">diff</span><span class="o">.</span><span class="na">div</span><span class="o">(</span><span class="n">d</span><span class="o">);</span></strong></span>
<span class='one-line'>        <span class="n">sum</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">diff</span><span class="o">);</span></span>
<span class='one-line'>        <span class="n">count</span><span class="o">++;</span></span>
<span class='one-line'> </span>
<span class='one-line'>      <span class="o">}</span></span>
<span class='one-line'>    <span class="o">}</span></span>
<span class='one-line'>    <span class="k">if</span> <span class="o">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span></span>
<span class='one-line'>      <span class="n">sum</span><span class="o">.</span><span class="na">div</span><span class="o">(</span><span class="n">count</span><span class="o">);</span></span>
<span class='one-line'>      <span class="n">sum</span><span class="o">.</span><span class="na">normalize</span><span class="o">();</span></span>
<span class='one-line'>      <span class="n">sum</span><span class="o">.</span><span class="na">mult</span><span class="o">(</span><span class="n">maxspeed</span><span class="o">);</span></span>
<span class='one-line'>      <span class="n">PVector</span> <span class="n">steer</span> <span class="o">=</span> <span class="n">PVector</span><span class="o">.</span><span class="na">sub</span><span class="o">(</span><span class="n">sum</span><span class="o">,</span> <span class="n">vel</span><span class="o">);</span></span>
<span class='one-line'>      <span class="n">steer</span><span class="o">.</span><span class="na">limit</span><span class="o">(</span><span class="n">maxforce</span><span class="o">);</span></span>
<span class='one-line'>      <span class="n">applyForce</span><span class="o">(</span><span class="n">steer</span><span class="o">);</span></span>
<span class='one-line'>    <span class="o">}</span></span>
<span class='one-line'> </span>
<span class='one-line'>  <span class="o">}</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><div class="example">
  <a id="chapter06_exercise12" style="display: block;"></a><h4 id="exercise-612">Exercise 6.12</h4><p>Rewrite <span class="function">separate()</span> to work in the opposite fashion (“cohesion”).  If a vehicle is beyond a certain distance, steer towards that vehicle.  This will keep the group together.  (Note that in a moment, we’re going to look at what happens when we have both cohesion and separation in the same simulation.)</p>

</div><div style="page-break-after:always;"> </div><div class="example">
  <a id="chapter06_exercise13" style="display: block;"></a><h4 id="exercise-613">Exercise 6.13</h4><p>Add the separation force to path following to create a simulation of Reynolds’s “Crowd Path Following.”</p>
<div class="image-container screenshot" >
	
	<canvas data-processing-sources="../NOC%20examples%20-%20processing/chp06/Exercise_6_13_CrowdPathFollowing/chp06/Exercise_6_13_CrowdPathFollowing.pde ../NOC%20examples%20-%20processing/chp06/Exercise_6_13_CrowdPathFollowing/Path.pde ../NOC%20examples%20-%20processing/chp06/Exercise_6_13_CrowdPathFollowing/Vehicle.pde" class="screenshot">
		<p>Your browser does not support the canvas tag.</p>
	</canvas>
  <div class="sketch-controls">
    <button class="reset">RESET</button>
    <button class="pause">PAUSE</button>
  </div>
	
	
</div>

</div></section><section><a id="chapter06_section12" style="display: block;"></a><h3 id="612-combinations">6.12  Combinations</h3><p><a id="autonomous-agentscombinations-82b566f0-253f-0130-bcce-7cd1c3f718ad" style="display: block;"></a><a id="combinations-82b57960-253f-0130-bccf-7cd1c3f718ad" style="display: block;"></a><a id="group-behaviorcombinations-82b58890-253f-0130-bcd0-7cd1c3f718ad" style="display: block;"></a></p>
<p>The previous two exercises hint at what is perhaps the most important aspect of this chapter.  After all, what is a Processing sketch with one steering force compared to one with many?  How could we even begin to simulate emergence in our sketches with only one rule?   The most exciting and intriguing behaviors will come from mixing and matching multiple steering forces, and we’ll need a mechanism for doing so.</p>
<p>You may be thinking, “Duh, this is nothing new.  We do this all the time.”  You would be right.  In fact, we did this as early as Chapter 2.</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>  PVector wind = new PVector(0.001,0);
  PVector gravity = new PVector(0,0.1);
  mover.applyForce(wind);
  mover.applyForce(gravity);</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'>  <span class="n">PVector</span> <span class="n">wind</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PVector</span><span class="o">(</span><span class="mf">0.001</span><span class="o">,</span><span class="mi">0</span><span class="o">);</span></span>
<span class='one-line'>  <span class="n">PVector</span> <span class="n">gravity</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PVector</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="mf">0.1</span><span class="o">);</span></span>
<span class='one-line'>  <span class="n">mover</span><span class="o">.</span><span class="na">applyForce</span><span class="o">(</span><span class="n">wind</span><span class="o">);</span></span>
<span class='one-line'>  <span class="n">mover</span><span class="o">.</span><span class="na">applyForce</span><span class="o">(</span><span class="n">gravity</span><span class="o">);</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>Here we have a mover that responds to two forces.  This all works nicely because of the way we designed the <span class="klass">Mover</span> class to accumulate the force vectors into its acceleration vector.  In this chapter, however, our forces stem from internal desires of the movers (now called vehicles). And those desires can be weighted. Let’s consider a sketch where all vehicles have two desires:</p>
<div class="list">
	
	<ul>
		
			<li><p><strong><em>Seek the mouse location.</em></strong></p>
</li>
		
			<li><p><strong><em>Separate from any vehicles that are too close.</em></strong></p>
</li>
		
	</ul>
</div><p>We might begin by adding a function to the <span class="klass">Vehicle</span> class that manages all of the behaviors.  Let’s call it <span class="function">applyBehaviors()</span>.</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>void applyBehaviors(ArrayList<Vehicle> vehicles) {
  separate(vehicles);
  seek(new PVector(mouseX,mouseY));
}</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'><span class="kt">void</span> <span class="nf">applyBehaviors</span><span class="o">(</span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Vehicle</span><span class="o">&gt;</span> <span class="n">vehicles</span><span class="o">)</span> <span class="o">{</span></span>
<span class='one-line'>  <span class="n">separate</span><span class="o">(</span><span class="n">vehicles</span><span class="o">);</span></span>
<span class='one-line'>  <span class="n">seek</span><span class="o">(</span><span class="k">new</span> <span class="n">PVector</span><span class="o">(</span><span class="n">mouseX</span><span class="o">,</span><span class="n">mouseY</span><span class="o">));</span></span>
<span class='one-line'><span class="o">}</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>Here we see how a single function takes care of calling the other functions that apply the forces—<span class="function">separate()</span> and <span class="function">seek()</span>.    We could start mucking around with those functions and see if we can adjust the strength of the forces they are calculating.  But it would be easier for us to ask those functions to return the forces so that we can adjust their strength before applying them to the vehicle’s acceleration.</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>  void applyBehaviors(ArrayList<Vehicle> vehicles) {
    PVector separate = separate(vehicles);
    PVector seek = seek(new PVector(mouseX,mouseY));
    //[full] We have to apply the force here since seek() and separate() no longer do so.
    applyForce(separate);
    applyForce(seek);
    //[end]
  }</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'>  <span class="kt">void</span> <span class="nf">applyBehaviors</span><span class="o">(</span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Vehicle</span><span class="o">&gt;</span> <span class="n">vehicles</span><span class="o">)</span> <span class="o">{</span></span>
<span class='one-line'>    <span class="n">PVector</span> <span class="n">separate</span> <span class="o">=</span> <span class="n">separate</span><span class="o">(</span><span class="n">vehicles</span><span class="o">);</span></span>
<span class='one-line'>    <span class="n">PVector</span> <span class="n">seek</span> <span class="o">=</span> <span class="n">seek</span><span class="o">(</span><span class="k">new</span> <span class="n">PVector</span><span class="o">(</span><span class="n">mouseX</span><span class="o">,</span><span class="n">mouseY</span><span class="o">));</span></span></pre></code></div>

  <div class='code-comment-pair stretch'><div class='code-comment stretch'> We have to apply the force here since seek() and separate() no longer do so.</div><code><pre><span class='one-line'>    <span class="n">applyForce</span><span class="o">(</span><span class="n">separate</span><span class="o">);</span></span>
<span class='one-line'>    <span class="n">applyForce</span><span class="o">(</span><span class="n">seek</span><span class="o">);</span></span></pre></code><div style='position:relative;clear:both;display:block;height:1px;width:100%;'></div></div>

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'>  <span class="o">}</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>Let’s look at how the seek function changed.</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>  PVector seek(PVector target) {
    PVector desired = PVector.sub(target,loc);
    desired.normalize();
    desired.mult(maxspeed);
    PVector steer = PVector.sub(desired,vel);
    steer.limit(maxforce);

    //[full] Instead of applying the force we return the PVector.
    applyForce(steer); //[line-through]
    return steer;
    //[end]
  }</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'>  <span class="n">PVector</span> <span class="nf">seek</span><span class="o">(</span><span class="n">PVector</span> <span class="n">target</span><span class="o">)</span> <span class="o">{</span></span>
<span class='one-line'>    <span class="n">PVector</span> <span class="n">desired</span> <span class="o">=</span> <span class="n">PVector</span><span class="o">.</span><span class="na">sub</span><span class="o">(</span><span class="n">target</span><span class="o">,</span><span class="n">loc</span><span class="o">);</span></span>
<span class='one-line'>    <span class="n">desired</span><span class="o">.</span><span class="na">normalize</span><span class="o">();</span></span>
<span class='one-line'>    <span class="n">desired</span><span class="o">.</span><span class="na">mult</span><span class="o">(</span><span class="n">maxspeed</span><span class="o">);</span></span>
<span class='one-line'>    <span class="n">PVector</span> <span class="n">steer</span> <span class="o">=</span> <span class="n">PVector</span><span class="o">.</span><span class="na">sub</span><span class="o">(</span><span class="n">desired</span><span class="o">,</span><span class="n">vel</span><span class="o">);</span></span>
<span class='one-line'>    <span class="n">steer</span><span class="o">.</span><span class="na">limit</span><span class="o">(</span><span class="n">maxforce</span><span class="o">);</span></span>
<span class='one-line'> </span></pre></code></div>

  <div class='code-comment-pair stretch'><div class='code-comment stretch'> Instead of applying the force we return the PVector.</div><code><pre><span class='one-line'>    <span class="line-through"><span class="n">applyForce</span><span class="o">(</span><span class="n">steer</span><span class="o">);</span></span></span>
<span class='one-line'>    <span class="k">return</span> <span class="n">steer</span><span class="o">;</span></span></pre></code><div style='position:relative;clear:both;display:block;height:1px;width:100%;'></div></div>

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'>  <span class="o">}</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>This is a subtle change, but incredibly important for us: it allows us to alter the strength of these forces in one place.</p>
<div class="image-container screenshot" >
	
	<canvas data-processing-sources="../NOC%20examples%20-%20processing/chp06/NOC_6_08_SeparationAndSeek/NOC_6_08_SeparationAndSeek.pde ../NOC%20examples%20-%20processing/chp06/NOC_6_08_SeparationAndSeek/Vehicle.pde" class="screenshot">
		<p>Your browser does not support the canvas tag.</p>
	</canvas>
  <div class="sketch-controls">
    <button class="reset">RESET</button>
    <button class="pause">PAUSE</button>
  </div>
	
	
</div>
<p><a id="chapter06_example8" style="display: block;"></a><span class="example">Example 6.8: Combining steering behaviors: Seek and separate</span></p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>void applyBehaviors(ArrayList<Vehicle> vehicles) {
  PVector separate = separate(vehicles);
  PVector seek = seek(new PVector(mouseX,mouseY));

  //[full] These values can be whatever you want them to be!
  // They can be variables that are customized for
  // each vehicle, or they can change over time.
  separate.mult(1.5); //[bold]
  seek.mult(0.5); //[bold]


  //[end]
  applyForce(separate);
  applyForce(seek);
}</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'><span class="kt">void</span> <span class="nf">applyBehaviors</span><span class="o">(</span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Vehicle</span><span class="o">&gt;</span> <span class="n">vehicles</span><span class="o">)</span> <span class="o">{</span></span>
<span class='one-line'>  <span class="n">PVector</span> <span class="n">separate</span> <span class="o">=</span> <span class="n">separate</span><span class="o">(</span><span class="n">vehicles</span><span class="o">);</span></span>
<span class='one-line'>  <span class="n">PVector</span> <span class="n">seek</span> <span class="o">=</span> <span class="n">seek</span><span class="o">(</span><span class="k">new</span> <span class="n">PVector</span><span class="o">(</span><span class="n">mouseX</span><span class="o">,</span><span class="n">mouseY</span><span class="o">));</span></span>
<span class='one-line'> </span></pre></code></div>

  <div class='code-comment-pair stretch'><div class='code-comment stretch'> These values can be whatever you want them to be!
They can be variables that are customized for
each vehicle, or they can change over time.</div><code><pre><span class='one-line'>  <strong><span class="n">separate</span><span class="o">.</span><span class="na">mult</span><span class="o">(</span><span class="mf">1.5</span><span class="o">);</span></strong></span>
<span class='one-line'>  <strong><span class="n">seek</span><span class="o">.</span><span class="na">mult</span><span class="o">(</span><span class="mf">0.5</span><span class="o">);</span></strong></span>
<span class='one-line'> </span>
<span class='one-line'> </span></pre></code><div style='position:relative;clear:both;display:block;height:1px;width:100%;'></div></div>

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'>  <span class="n">applyForce</span><span class="o">(</span><span class="n">separate</span><span class="o">);</span></span>
<span class='one-line'>  <span class="n">applyForce</span><span class="o">(</span><span class="n">seek</span><span class="o">);</span></span>
<span class='one-line'><span class="o">}</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><div class="example">
  <a id="chapter06_exercise14" style="display: block;"></a><h4 id="exercise-614">Exercise 6.14</h4><p>Redo Example 6.8 so that the behavior weights are not constants.  What happens if they change over time (according to a sine wave or Perlin noise)?  Or if some vehicles are more concerned with seeking and others more concerned with separating?  Can you introduce other steering behaviors as well?</p>

</div></section><section><a id="chapter06_section13" style="display: block;"></a><h3 id="613-flocking">6.13  Flocking</h3><p><a id="flocks-herds-and-schools-a-distributed-behavioral-model-reynolds-82b61430-253f-0130-bcd1-7cd1c3f718ad" style="display: block;"></a><a id="autonomous-agentsflocking-82b62420-253f-0130-bcd2-7cd1c3f718ad" style="display: block;"></a><a id="flocking-82b633f0-253f-0130-bcd3-7cd1c3f718ad" style="display: block;"></a><a id="group-behaviorflocking-82b64430-253f-0130-bcd4-7cd1c3f718ad" style="display: block;"></a><a id="natural-phenomenaflocking-82b65620-253f-0130-bcd5-7cd1c3f718ad" style="display: block;"></a></p>
<p>Flocking is an group animal behavior that is characteristic of many living creatures, such as birds, fish, and insects.   In 1986, Craig Reynolds created a computer simulation of flocking behavior and documented the algorithm in his paper, “Flocks, Herds, and Schools: A Distributed Behavioral Model.”    Recreating this simulation in Processing will bring together all the concepts in this chapter.</p>
<div class="list">
	
	<ol class="arabic">
		
			<li><p><em>We will use the steering force formula (steer = desired - velocity) to implement the rules of flocking.</em></p>
</li>
		
			<li><p><em>These steering forces will be group behaviors and require each vehicle to look at all the other vehicles.</em></p>
</li>
		
			<li><p><em>We will combine and weight multiple forces.</em></p>
</li>
		
			<li><p><em>The result will be a complex system—intelligent group behavior will emerge from the simple rules of flocking without the presence of a centralized system or leader.</em></p>
</li>
		
	</ol>
</div><p>The good news is, we’ve already done items 1 through 3 in this chapter, so this section will be about just putting it all together and seeing the result.</p>
<p>Before we begin, I should mention that we’re going to change the name of our <span class="klass">Vehicle</span> class (yet again).  Reynolds uses the term “boid” (a made-up word that refers to a bird-like object) to describe the elements of a flocking system and we will do the same.</p>
<p>Let’s take an overview of the three rules of flocking.</p>
<p><a id="alignment-flocking-82b69860-253f-0130-bcd6-7cd1c3f718ad" style="display: block;"></a><a id="cohesion-flocking-82b6afa0-253f-0130-bcd7-7cd1c3f718ad" style="display: block;"></a><a id="flockingrules-of-82b6c8c0-253f-0130-bcd8-7cd1c3f718ad" style="display: block;"></a><a id="separation-flocking-82b6e3c0-253f-0130-bcd9-7cd1c3f718ad" style="display: block;"></a></p>
<div class="list">
	
	<ol class="arabic">
		
			<li><p><strong><em>Separation</em></strong> (also known as “avoidance”): Steer to avoid colliding with your neighbors.
</p>
</li>
		
			<li><p><strong><em>Alignment</em></strong> (also known as “copy”): Steer in the same direction as your neighbors.
</p>
</li>
		
			<li><p><strong><em>Cohesion</em></strong> (also known as “center”): Steer towards the center of your neighbors (stay with the group).
</p>
</li>
		
	</ol>
</div><a id="chapter06_figure35" style="display: block;"></a><div class="image-container " >
	
	<img src="imgs/chapter06/ch06_35.png" alt="Nature of Code Image" />
	
	<p class="caption">Figure 6.35</p>
</div>
<p>Just as we did with our separate and seek example, we’ll want our <span class="klass">Boid</span> objects to have a single function that manages all the above behaviors.  We’ll call this function <span class="function">flock()</span>.</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>  void flock(ArrayList<Boid> boids) {
    //[full] The three flocking rules
    PVector sep = separate(boids);
    PVector ali = align(boids);
    PVector coh = cohesion(boids);
    //[end]

    //[full] Arbitrary weights for these forces
    // (Try different ones!)
    sep.mult(1.5);
    ali.mult(1.0);
    coh.mult(1.0);
    //[end]

    //[full] Applying all the forces
    applyForce(sep);
    applyForce(ali);
    applyForce(coh);
    //[end]
  }</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'>  <span class="kt">void</span> <span class="nf">flock</span><span class="o">(</span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Boid</span><span class="o">&gt;</span> <span class="n">boids</span><span class="o">)</span> <span class="o">{</span></span></pre></code></div>

  <div class='code-comment-pair stretch'><div class='code-comment stretch'> The three flocking rules</div><code><pre><span class='one-line'>    <span class="n">PVector</span> <span class="n">sep</span> <span class="o">=</span> <span class="n">separate</span><span class="o">(</span><span class="n">boids</span><span class="o">);</span></span>
<span class='one-line'>    <span class="n">PVector</span> <span class="n">ali</span> <span class="o">=</span> <span class="n">align</span><span class="o">(</span><span class="n">boids</span><span class="o">);</span></span>
<span class='one-line'>    <span class="n">PVector</span> <span class="n">coh</span> <span class="o">=</span> <span class="n">cohesion</span><span class="o">(</span><span class="n">boids</span><span class="o">);</span></span></pre></code><div style='position:relative;clear:both;display:block;height:1px;width:100%;'></div></div>

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'> </span></pre></code></div>

  <div class='code-comment-pair stretch'><div class='code-comment stretch'> Arbitrary weights for these forces
(Try different ones!)</div><code><pre><span class='one-line'>    <span class="n">sep</span><span class="o">.</span><span class="na">mult</span><span class="o">(</span><span class="mf">1.5</span><span class="o">);</span></span>
<span class='one-line'>    <span class="n">ali</span><span class="o">.</span><span class="na">mult</span><span class="o">(</span><span class="mf">1.0</span><span class="o">);</span></span>
<span class='one-line'>    <span class="n">coh</span><span class="o">.</span><span class="na">mult</span><span class="o">(</span><span class="mf">1.0</span><span class="o">);</span></span></pre></code><div style='position:relative;clear:both;display:block;height:1px;width:100%;'></div></div>

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'> </span></pre></code></div>

  <div class='code-comment-pair stretch'><div class='code-comment stretch'> Applying all the forces</div><code><pre><span class='one-line'>    <span class="n">applyForce</span><span class="o">(</span><span class="n">sep</span><span class="o">);</span></span>
<span class='one-line'>    <span class="n">applyForce</span><span class="o">(</span><span class="n">ali</span><span class="o">);</span></span>
<span class='one-line'>    <span class="n">applyForce</span><span class="o">(</span><span class="n">coh</span><span class="o">);</span></span></pre></code><div style='position:relative;clear:both;display:block;height:1px;width:100%;'></div></div>

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'>  <span class="o">}</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>Now, it’s just a matter of implementing the three rules.   We did separation before; it’s identical to our previous example.  Let’s take a look at alignment, or steering in the same direction as your neighbors.  As with all of our steering behaviors, we’ve got to boil down this concept into a desire: the boid’s desired velocity is the average velocity of its neighbors.</p>
<p>So our algorithm is to calculate the average velocity of all the other boids and set that to desired.</p>
<p><a id="separation-flockingimplementing-82b758c0-253f-0130-bcda-7cd1c3f718ad" style="display: block;"></a></p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>  PVector align (ArrayList<Boid> boids) {
    //[full] Add up all the velocities
    // and divide by the total
    // to calculate the average velocity.
    PVector sum = new PVector(0,0);
    for (Boid other : boids) {
      sum.add(other.velocity);
    }
    sum.div(boids.size());
    //[end]

    // We desire to go in that
    // direction at maximum speed.
    sum.setMag(maxspeed);

    // Reynolds’s steering
    // force formula
    PVector steer = PVector.sub(sum,velocity);
    steer.limit(maxforce);
    return steer;
  }</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'>  <span class="n">PVector</span> <span class="nf">align</span> <span class="o">(</span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Boid</span><span class="o">&gt;</span> <span class="n">boids</span><span class="o">)</span> <span class="o">{</span></span></pre></code></div>

  <div class='code-comment-pair stretch'><div class='code-comment stretch'> Add up all the velocities
and divide by the total
to calculate the average velocity.</div><code><pre><span class='one-line'>    <span class="n">PVector</span> <span class="n">sum</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PVector</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">);</span></span>
<span class='one-line'>    <span class="k">for</span> <span class="o">(</span><span class="n">Boid</span> <span class="n">other</span> <span class="o">:</span> <span class="n">boids</span><span class="o">)</span> <span class="o">{</span></span>
<span class='one-line'>      <span class="n">sum</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">velocity</span><span class="o">);</span></span>
<span class='one-line'>    <span class="o">}</span></span>
<span class='one-line'>    <span class="n">sum</span><span class="o">.</span><span class="na">div</span><span class="o">(</span><span class="n">boids</span><span class="o">.</span><span class="na">size</span><span class="o">());</span></span></pre></code><div style='position:relative;clear:both;display:block;height:1px;width:100%;'></div></div>

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'> </span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>We desire to go in that
direction at maximum speed.</div><code><pre><span class='one-line'>    <span class="n">sum</span><span class="o">.</span><span class="na">setMag</span><span class="o">(</span><span class="n">maxspeed</span><span class="o">);</span></span>
<span class='one-line'> </span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>Reynolds’s steering
force formula</div><code><pre><span class='one-line'>    <span class="n">PVector</span> <span class="n">steer</span> <span class="o">=</span> <span class="n">PVector</span><span class="o">.</span><span class="na">sub</span><span class="o">(</span><span class="n">sum</span><span class="o">,</span><span class="n">velocity</span><span class="o">);</span></span>
<span class='one-line'>    <span class="n">steer</span><span class="o">.</span><span class="na">limit</span><span class="o">(</span><span class="n">maxforce</span><span class="o">);</span></span>
<span class='one-line'>    <span class="k">return</span> <span class="n">steer</span><span class="o">;</span></span>
<span class='one-line'>  <span class="o">}</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p><a id="short-range-relationshipsflocking-behavior-and-82b76e90-253f-0130-bcdb-7cd1c3f718ad" style="display: block;"></a></p>
<p>The above is pretty good, but it’s missing one rather crucial detail.  One of the key principles behind complex systems like flocking is that the elements (in this case, boids) have short-range relationships.   Thinking about ants again, it’s pretty easy to imagine an ant being able to sense its immediate environment, but less so an ant having an awareness of what another ant is doing hundreds of feet away.  The fact that the ants can perform such complex collective behavior from only these neighboring relationships is what makes them so exciting in the first place.</p>
<p>In our alignment function, we’re taking the average velocity of all the boids, whereas we should really only be looking at the boids within a certain distance.  That distance threshold is up to you, of course.  You could design boids that can see only twenty pixels away or boids that can see a hundred pixels away.</p>
<a id="chapter06_figure36" style="display: block;"></a><div class="image-container " >
	
	<img src="imgs/chapter06/ch06_36.png" alt="Nature of Code Image" />
	
	<p class="caption">Figure 6.36</p>
</div>
<p>Much like we did with separation (only calculating a force for others within a certain distance), we’ll want to do the same with alignment (and cohesion).</p>
<p><a id="alignment-flockingimplementing-82b79330-253f-0130-bcdc-7cd1c3f718ad" style="display: block;"></a></p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>  PVector align (ArrayList<Boid> boids) {
    // This is an arbitrary value and could
    // vary from boid to boid.
    float neighbordist = 50;
    PVector sum = new PVector(0,0);
    int count = 0;
    for (Boid other : boids) {
      float d = PVector.dist(location,other.location);
      if ((d > 0) && (d < neighbordist)) {
        sum.add(other.velocity);
        // For an average, we need to keep track of
        // how many boids are within the distance.
        count++;
      }
    }
    if (count > 0) {
      sum.div(count);
      sum.normalize();
      sum.mult(maxspeed);
      PVector steer = PVector.sub(sum,velocity);
      steer.limit(maxforce);
      return steer;
    //[full] If we don’t find any close boids,
    // the steering force is zero.
    } else {
      return new PVector(0,0);
    }
    //[end]
  }</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'>  <span class="n">PVector</span> <span class="nf">align</span> <span class="o">(</span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Boid</span><span class="o">&gt;</span> <span class="n">boids</span><span class="o">)</span> <span class="o">{</span></span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>This is an arbitrary value and could
vary from boid to boid.</div><code><pre><span class='one-line'>    <span class="kt">float</span> <span class="n">neighbordist</span> <span class="o">=</span> <span class="mi">50</span><span class="o">;</span></span>
<span class='one-line'>    <span class="n">PVector</span> <span class="n">sum</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PVector</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">);</span></span>
<span class='one-line'>    <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span></span>
<span class='one-line'>    <span class="k">for</span> <span class="o">(</span><span class="n">Boid</span> <span class="n">other</span> <span class="o">:</span> <span class="n">boids</span><span class="o">)</span> <span class="o">{</span></span>
<span class='one-line'>      <span class="kt">float</span> <span class="n">d</span> <span class="o">=</span> <span class="n">PVector</span><span class="o">.</span><span class="na">dist</span><span class="o">(</span><span class="n">location</span><span class="o">,</span><span class="n">other</span><span class="o">.</span><span class="na">location</span><span class="o">);</span></span>
<span class='one-line'>      <span class="k">if</span> <span class="o">((</span><span class="n">d</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">d</span> <span class="o">&lt;</span> <span class="n">neighbordist</span><span class="o">))</span> <span class="o">{</span></span>
<span class='one-line'>        <span class="n">sum</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">velocity</span><span class="o">);</span></span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>For an average, we need to keep track of
how many boids are within the distance.</div><code><pre><span class='one-line'>        <span class="n">count</span><span class="o">++;</span></span>
<span class='one-line'>      <span class="o">}</span></span>
<span class='one-line'>    <span class="o">}</span></span>
<span class='one-line'>    <span class="k">if</span> <span class="o">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span></span>
<span class='one-line'>      <span class="n">sum</span><span class="o">.</span><span class="na">div</span><span class="o">(</span><span class="n">count</span><span class="o">);</span></span>
<span class='one-line'>      <span class="n">sum</span><span class="o">.</span><span class="na">normalize</span><span class="o">();</span></span>
<span class='one-line'>      <span class="n">sum</span><span class="o">.</span><span class="na">mult</span><span class="o">(</span><span class="n">maxspeed</span><span class="o">);</span></span>
<span class='one-line'>      <span class="n">PVector</span> <span class="n">steer</span> <span class="o">=</span> <span class="n">PVector</span><span class="o">.</span><span class="na">sub</span><span class="o">(</span><span class="n">sum</span><span class="o">,</span><span class="n">velocity</span><span class="o">);</span></span>
<span class='one-line'>      <span class="n">steer</span><span class="o">.</span><span class="na">limit</span><span class="o">(</span><span class="n">maxforce</span><span class="o">);</span></span>
<span class='one-line'>      <span class="k">return</span> <span class="n">steer</span><span class="o">;</span></span></pre></code></div>

  <div class='code-comment-pair stretch'><div class='code-comment stretch'> If we don’t find any close boids,
the steering force is zero.</div><code><pre><span class='one-line'>    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span></span>
<span class='one-line'>      <span class="k">return</span> <span class="k">new</span> <span class="nf">PVector</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">);</span></span>
<span class='one-line'>    <span class="o">}</span></span></pre></code><div style='position:relative;clear:both;display:block;height:1px;width:100%;'></div></div>

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'>  <span class="o">}</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><div class="example">
  <a id="chapter06_exercise15" style="display: block;"></a><h4 id="exercise-615">Exercise 6.15</h4><div class="image-container half-width-right" >
	
	<img src="imgs/chapter06/ch06_exc15.png" alt="Nature of Code Image" />
	
	
</div>
<p>Can you write the above code so that boids can only see other boids that are actually within their “peripheral” vision (as if they had eyes)?</p>
<div class="image-container " >
	
	<img src="imgs/blank.png" alt="Nature of Code Image" />
	
	
</div>

</div><p><a id="cohesion-flockingimplementing-82b7bfb0-253f-0130-bcdd-7cd1c3f718ad" style="display: block;"></a></p>
<p>Finally, we are ready for cohesion.  Here our code is virtually identical to that for alignment—only instead of calculating the average velocity of the boid’s neighbors, we want to calculate the average location of the boid’s neighbors (and use that as a target to seek).</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>  PVector cohesion (ArrayList<Boid> boids) {
    float neighbordist = 50;
    PVector sum = new PVector(0,0);
    int count = 0;
    for (Boid other : boids) {
      float d = PVector.dist(location,other.location);
      if ((d > 0) && (d < neighbordist)) {
        // Adding up all the others’ locations
        sum.add(other.location);
        count++;
      }
    }
    if (count > 0) {
      sum.div(count);
      // Here we make use of the seek() function we
      // wrote in Example 6.8.  The target
      // we seek is the average location of
      // our neighbors.
      return seek(sum); //[bold]
    } else {
      return new PVector(0,0);
    }
  }</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'>  <span class="n">PVector</span> <span class="nf">cohesion</span> <span class="o">(</span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Boid</span><span class="o">&gt;</span> <span class="n">boids</span><span class="o">)</span> <span class="o">{</span></span>
<span class='one-line'>    <span class="kt">float</span> <span class="n">neighbordist</span> <span class="o">=</span> <span class="mi">50</span><span class="o">;</span></span>
<span class='one-line'>    <span class="n">PVector</span> <span class="n">sum</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PVector</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">);</span></span>
<span class='one-line'>    <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span></span>
<span class='one-line'>    <span class="k">for</span> <span class="o">(</span><span class="n">Boid</span> <span class="n">other</span> <span class="o">:</span> <span class="n">boids</span><span class="o">)</span> <span class="o">{</span></span>
<span class='one-line'>      <span class="kt">float</span> <span class="n">d</span> <span class="o">=</span> <span class="n">PVector</span><span class="o">.</span><span class="na">dist</span><span class="o">(</span><span class="n">location</span><span class="o">,</span><span class="n">other</span><span class="o">.</span><span class="na">location</span><span class="o">);</span></span>
<span class='one-line'>      <span class="k">if</span> <span class="o">((</span><span class="n">d</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">d</span> <span class="o">&lt;</span> <span class="n">neighbordist</span><span class="o">))</span> <span class="o">{</span></span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>Adding up all the others’ locations</div><code><pre><span class='one-line'>        <span class="n">sum</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">other</span><span class="o">.</span><span class="na">location</span><span class="o">);</span></span>
<span class='one-line'>        <span class="n">count</span><span class="o">++;</span></span>
<span class='one-line'>      <span class="o">}</span></span>
<span class='one-line'>    <span class="o">}</span></span>
<span class='one-line'>    <span class="k">if</span> <span class="o">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span></span>
<span class='one-line'>      <span class="n">sum</span><span class="o">.</span><span class="na">div</span><span class="o">(</span><span class="n">count</span><span class="o">);</span></span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>Here we make use of the seek() function we
wrote in Example 6.8.  The target
we seek is the average location of
our neighbors.</div><code><pre><span class='one-line'>      <strong><span class="k">return</span> <span class="nf">seek</span><span class="o">(</span><span class="n">sum</span><span class="o">);</span></strong></span>
<span class='one-line'>    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span></span>
<span class='one-line'>      <span class="k">return</span> <span class="k">new</span> <span class="nf">PVector</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="mi">0</span><span class="o">);</span></span>
<span class='one-line'>    <span class="o">}</span></span>
<span class='one-line'>  <span class="o">}</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>It’s also worth taking the time to write a class called <span class="klass">Flock</span>, which will be virtually identical to the <span class="klass">ParticleSystem</span> class we wrote in Chapter 4 with only one tiny change:  When we call <span class="function">run()</span> on each <span class="klass">Boid</span> object (as we did to each <span class="klass">Particle</span> object), we’ll pass in a reference to the entire <span class="klass">ArrayList</span> of boids.</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>class Flock {
  ArrayList<Boid> boids;

  Flock() {
    boids = new ArrayList<Boid>();
  }

  void run() {
    for (Boid b : boids) {
      // Each Boid object must know about
      // all the other Boids.
      b.run(boids); //[bold]
    }
  }

  void addBoid(Boid b) {
    boids.add(b);
  }
}</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'><span class="kd">class</span> <span class="nc">Flock</span> <span class="o">{</span></span>
<span class='one-line'>  <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Boid</span><span class="o">&gt;</span> <span class="n">boids</span><span class="o">;</span></span>
<span class='one-line'> </span>
<span class='one-line'>  <span class="n">Flock</span><span class="o">()</span> <span class="o">{</span></span>
<span class='one-line'>    <span class="n">boids</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Boid</span><span class="o">&gt;();</span></span>
<span class='one-line'>  <span class="o">}</span></span>
<span class='one-line'> </span>
<span class='one-line'>  <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span></span>
<span class='one-line'>    <span class="k">for</span> <span class="o">(</span><span class="n">Boid</span> <span class="n">b</span> <span class="o">:</span> <span class="n">boids</span><span class="o">)</span> <span class="o">{</span></span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>Each Boid object must know about
all the other Boids.</div><code><pre><span class='one-line'>      <strong><span class="n">b</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">boids</span><span class="o">);</span></strong></span>
<span class='one-line'>    <span class="o">}</span></span>
<span class='one-line'>  <span class="o">}</span></span>
<span class='one-line'> </span>
<span class='one-line'>  <span class="kt">void</span> <span class="nf">addBoid</span><span class="o">(</span><span class="n">Boid</span> <span class="n">b</span><span class="o">)</span> <span class="o">{</span></span>
<span class='one-line'>    <span class="n">boids</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">b</span><span class="o">);</span></span>
<span class='one-line'>  <span class="o">}</span></span>
<span class='one-line'><span class="o">}</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>And our main program will look like:</p>
<div class="image-container screenshot" >
	
	<canvas data-processing-sources="../NOC%20examples%20-%20processing/chp06/NOC_6_09_Flocking/chp06/NOC_6_09_Flocking.pde ../NOC%20examples%20-%20processing/chp06/NOC_6_09_Flocking/Flock.pde ../NOC%20examples%20-%20processing/chp06/NOC_6_09_Flocking/Boid.pde" class="screenshot">
		<p>Your browser does not support the canvas tag.</p>
	</canvas>
  <div class="sketch-controls">
    <button class="reset">RESET</button>
    <button class="pause">PAUSE</button>
  </div>
	
	
</div>
<p><a id="chapter06_example9" style="display: block;"></a><span class="example">Example 6.9: Flocking</span></p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>// A Flock object manages the
// entire group.
Flock flock;
void setup() {
  size(300,200);
  flock = new Flock();
  for (int i = 0; i < 100; i++) {
    Boid b = new Boid(width/2,height/2);
    // The Flock starts out with 100 Boids.
    flock.addBoid(b);
  }
}

void draw() {
  background(255);
  flock.run();
}</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair '><div class='code-comment '>A Flock object manages the
entire group.</div><code><pre><span class='one-line'><span class="n">Flock</span> <span class="n">flock</span><span class="o">;</span></span>
<span class='one-line'><span class="kt">void</span> <span class="nf">setup</span><span class="o">()</span> <span class="o">{</span></span>
<span class='one-line'>  <span class="n">size</span><span class="o">(</span><span class="mi">300</span><span class="o">,</span><span class="mi">200</span><span class="o">);</span></span>
<span class='one-line'>  <span class="n">flock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Flock</span><span class="o">();</span></span>
<span class='one-line'>  <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span></span>
<span class='one-line'>    <span class="n">Boid</span> <span class="n">b</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Boid</span><span class="o">(</span><span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="o">,</span><span class="n">height</span><span class="o">/</span><span class="mi">2</span><span class="o">);</span></span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>The Flock starts out with 100 Boids.</div><code><pre><span class='one-line'>    <span class="n">flock</span><span class="o">.</span><span class="na">addBoid</span><span class="o">(</span><span class="n">b</span><span class="o">);</span></span>
<span class='one-line'>  <span class="o">}</span></span>
<span class='one-line'><span class="o">}</span></span>
<span class='one-line'> </span>
<span class='one-line'><span class="kt">void</span> <span class="nf">draw</span><span class="o">()</span> <span class="o">{</span></span>
<span class='one-line'>  <span class="n">background</span><span class="o">(</span><span class="mi">255</span><span class="o">);</span></span>
<span class='one-line'>  <span class="n">flock</span><span class="o">.</span><span class="na">run</span><span class="o">();</span></span>
<span class='one-line'><span class="o">}</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><div class="example">
  <a id="chapter06_exercise16" style="display: block;"></a><h4 id="exercise-616">Exercise 6.16</h4><p>Combine flocking with some other steering behaviors.</p>

</div><div class="example">
  <a id="chapter06_exercise17" style="display: block;"></a><h4 id="exercise-617">Exercise 6.17</h4><div class="image-container half-width-right" >
	
	<img src="imgs/chapter06/ch06_exc17.png" alt="Nature of Code Image" />
	
	
</div>
<p><a id="computational-beauty-of-nature-flake-82b83d20-253f-0130-bcde-7cd1c3f718ad" style="display: block;"></a><a id="flake-gary-82b855b0-253f-0130-bcdf-7cd1c3f718ad" style="display: block;"></a></p>
<p>In his book The <em>Computational Beauty of Nature</em> (MIT Press, 2000), Gary Flake describes a fourth rule for flocking: “View: move laterally away from any boid that blocks the view.” Have your boids follow this rule.</p>
<div class="image-container " >
	
	<img src="imgs/blank.png" alt="Nature of Code Image" />
	
	
</div>

</div><div class="example">
  <a id="chapter06_exercise18" style="display: block;"></a><h4 id="exercise-618">Exercise 6.18</h4><p>Create a flocking simulation where all of the parameters (<em>separation weight</em>, <em>cohesion weight</em>, <em>alignment weight</em>, <em>maximum force</em>, <em>maximum speed</em>) change over time.  They could be controlled by Perlin noise or by user interaction. (For example, you could use a library such as <a href="http://www.sojamo.de/libraries/controlP5/">controlp5</a> to tie the values to slider positions.)</p>

</div><div class="example">
  <a id="chapter06_exercise19" style="display: block;"></a><h4 id="exercise-619">Exercise 6.19</h4><p>Visualize the flock in an entirely different way.</p>

</div></section><section><a id="chapter06_section14" style="display: block;"></a><h3 id="614-algorithmic-efficiency-or-why-does-my-run-so-slowly">6.14  Algorithmic Efficiency (or: Why does my $@(*%! run so slowly?)</h3><p><a id="efficiency-82bb3e40-253f-0130-bce0-7cd1c3f718ad" style="display: block;"></a><a id="performance-82bb4dc0-253f-0130-bce1-7cd1c3f718ad" style="display: block;"></a></p>
<p>I would like to hide the dark truth behind we’ve just done, because I would like you to be happy and live a fulfilling and meaningful life.  But I also would like to be able to sleep at night without worrying about you so much.  So it is with a heavy heart that I must bring up this topic.  Group behaviors are wonderful.  But they can be slow, and the more elements in the group, the slower they can be.  Usually, when we talk about Processing sketches running slowly, it’s because drawing to the screen can be slow—the more you draw, the slower your sketch runs.  This is actually a case, however, where the slowness derives from the algorithm itself.  Let’s discuss.</p>
<p><a id="big-o-notation-82bb6200-253f-0130-bce2-7cd1c3f718ad" style="display: block;"></a><a id="efficiencybig-o-notation-82bb71f0-253f-0130-bce3-7cd1c3f718ad" style="display: block;"></a><a id="flockingperformance-and-82bb8460-253f-0130-bce4-7cd1c3f718ad" style="display: block;"></a><a id="performancebig-o-notation-82bb9650-253f-0130-bce5-7cd1c3f718ad" style="display: block;"></a></p>
<p>Computer scientists classify algorithms with something called “Big O notation,” which describes the efficiency of an algorithm: how many computational cycles does it require to complete?  Let’s consider a simple analog search problem.  You have a basket containing one hundred chocolate treats, only one of which is pure dark chocolate. That’s the one you want to eat.  To find it, you pick the chocolates out of the basket one by one.  Sure, you might be lucky and find it on the first try, but in the worst-case scenario you have to check all one hundred before you find the dark chocolate.   To find one thing in one hundred, you have to check one hundred things (or to find one thing in N things, you have to check N times.)  Your Big O Notation is N.  This, incidentally, is the Big O Notation that describes our simple particle system.  If we have N particles, we have to run and display those particles N times.</p>
<p>Now, let’s think about a group behavior (such as flocking).   For every <span class="klass">Boid</span> object, we have to check every other <span class="klass">Boid</span> object (for its velocity and location).  Let’s say we have one hundred boids.  For boid #1, we need to check one hundred boids; for boid #2, we need to check one hundred boids, and so on and so forth.   For one hundred boids, we need to perform one hundred times one hundred checks, or ten thousand.   No problem: computers are fast and can do things ten thousand times pretty easily.  Let’s try one thousand.</p>
<p>1,000 x 1,000 = 1,000,000 cycles.</p>
<p>OK, this is rather slow, but still somewhat manageable.   Let’s try 10,000 elements:</p>
<p>10,000 x 10,000 elements = 100,000,000 cycles.</p>
<p>Now, we’re really getting slow. Really, really, really slow.</p>
<p><a id="big-o-notation-n-squared-82bbcb80-253f-0130-bce6-7cd1c3f718ad" style="display: block;"></a><a id="efficiencybig-o-notation-n-squared-82bbdad0-253f-0130-bce7-7cd1c3f718ad" style="display: block;"></a><a id="performancebig-o-notation-n-squared-82bbf030-253f-0130-bce8-7cd1c3f718ad" style="display: block;"></a></p>
<p>Notice something odd?  As the number of elements increases by a factor of 10, the number of required cycles increases by a factor of 100.  Or as the number of elements increases by a factor of N, the cycles increase by a factor of N times N.  This is known as Big O Notation N-Squared.</p>
<p>I know what you are thinking.  You are thinking: “No problem; with flocking, we only need to consider the boids that are close to other boids.  So even if we have 1,000 boids, we can just look at, say, the 5 closest boids and then we only have 5,000 cycles.”   You pause for a moment, and then start thinking: “So for each boid I just need to check all the boids and find the five closest ones and I’m good!”  See the catch-22?  Even if we only want to look at the close ones, the only way to know what the close ones are would be to check all of them.</p>
<p>Or is there another way?</p>
<p>Let’s take a number that we might actually want to use, but would still run too slowly: 2,000 (4,000,000 cycles required).</p>
<p><a id="bin-lattice-spatial-subdivision-82bc2210-253f-0130-bce9-7cd1c3f718ad" style="display: block;"></a><a id="efficiencybin-lattice-spatial-subdivision-82bc3470-253f-0130-bcea-7cd1c3f718ad" style="display: block;"></a><a id="flockingbin-lattice-spatial-subdivision-82bc46c0-253f-0130-bceb-7cd1c3f718ad" style="display: block;"></a><a id="performancebin-lattice-spatial-subdivision-82bc58a0-253f-0130-bcec-7cd1c3f718ad" style="display: block;"></a></p>
<p>What if we could divide the screen into a grid?  We would take all 2,000 boids and assign each boid to a cell within that grid.   We would then be able to look at each boid and compare it to its neighbors within that cell at any given moment. Imagine a 10 x 10 grid. In a system of 2,000 elements, on average, approximately 20 elements would be found in each cell (20 x 10 x 10 = 2,000).  Each cell would then require 20 x 20 = 400 cycles. With 100 cells, we’d have 100 x 400 = 40,000 cycles, a massive savings over 4,000,000.</p>
<a id="chapter06_figure37" style="display: block;"></a><div class="image-container " >
	
	<img src="imgs/chapter06/ch06_37.png" alt="Nature of Code Image" />
	
	<p class="caption">Figure 6.37</p>
</div>
<p><a id="interaction-with-groups-of-autonomous-characters-reynolds-82bc7880-253f-0130-bced-7cd1c3f718ad" style="display: block;"></a></p>
<p>This technique is known as “bin-lattice spatial subdivision” and is outlined in more detail in (surprise, surprise) Reynolds’s 2000 paper, <a href="http://www.red3d.com/cwr/papers/2000/pip.pdf">“Interaction with Groups of Autonomous Characters”</a>.   How do we implement such an algorithm in Processing?  One way is to keep multiple <span class="klass">ArrayList</span>s.  One <span class="klass">ArrayList</span> would keep track of all the boids, just like in our flocking example.</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>ArrayList<Boid> boids;</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Boid</span><span class="o">&gt;</span> <span class="n">boids</span><span class="o">;</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>In addition to that <span class="klass">ArrayList</span>, we store an additional reference to each <span class="klass">Boid</span> object in a two-dimensional <span class="klass">ArrayList</span>.  For each cell in the grid, there is an <span class="klass">ArrayList</span> that tracks the objects in that cell.</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>ArrayList<Boid>[][] grid;</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Boid</span><span class="o">&gt;[][]</span> <span class="n">grid</span><span class="o">;</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>In the main <span class="function">draw()</span> loop, each <span class="klass">Boid</span> object then registers itself in the appropriate cell according to its location.</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>int column = int(boid.x) / resolution;
int row    = int(boid.y) /resolution;
grid[column][row].add(boid);</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'><span class="kt">int</span> <span class="n">column</span> <span class="o">=</span> <span class="kt">int</span><span class="o">(</span><span class="n">boid</span><span class="o">.</span><span class="na">x</span><span class="o">)</span> <span class="o">/</span> <span class="n">resolution</span><span class="o">;</span></span>
<span class='one-line'><span class="kt">int</span> <span class="n">row</span>    <span class="o">=</span> <span class="kt">int</span><span class="o">(</span><span class="n">boid</span><span class="o">.</span><span class="na">y</span><span class="o">)</span> <span class="o">/</span><span class="n">resolution</span><span class="o">;</span></span>
<span class='one-line'><span class="n">grid</span><span class="o">[</span><span class="n">column</span><span class="o">][</span><span class="n">row</span><span class="o">].</span><span class="na">add</span><span class="o">(</span><span class="n">boid</span><span class="o">);</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>Then when it comes time to have the boids check for neighbors, they can look at only those in their particular cell (in truth, we also need to check neighboring cells to deal with border cases).</p>
<p><a id="chapter06_example10" style="display: block;"></a><span class="example">Example 6.10: Bin-lattice spatial subdivision</span></p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>int column = int(boid.x) / resolution;
int row    = int(boid.y) /resolution;
boid.flock(boids);
// Instead of looking at all
// the boids, just this cell
boid.flock(grid[column][row]);</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'><span class="kt">int</span> <span class="n">column</span> <span class="o">=</span> <span class="kt">int</span><span class="o">(</span><span class="n">boid</span><span class="o">.</span><span class="na">x</span><span class="o">)</span> <span class="o">/</span> <span class="n">resolution</span><span class="o">;</span></span>
<span class='one-line'><span class="kt">int</span> <span class="n">row</span>    <span class="o">=</span> <span class="kt">int</span><span class="o">(</span><span class="n">boid</span><span class="o">.</span><span class="na">y</span><span class="o">)</span> <span class="o">/</span><span class="n">resolution</span><span class="o">;</span></span>
<span class='one-line'><span class="n">boid</span><span class="o">.</span><span class="na">flock</span><span class="o">(</span><span class="n">boids</span><span class="o">);</span></span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>Instead of looking at all
the boids, just this cell</div><code><pre><span class='one-line'><span class="n">boid</span><span class="o">.</span><span class="na">flock</span><span class="o">(</span><span class="n">grid</span><span class="o">[</span><span class="n">column</span><span class="o">][</span><span class="n">row</span><span class="o">]);</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>We’re only covering the basics here; for the full code, check the book’s website.</p>
<p>Now, there are certainly flaws with this system.  What if all the boids congregate in the corner and live in the same cell? Then don’t we have to check all 2,000 against all 2,000?</p>
<p>The good news is that this need for optimization is a common one and there are a wide variety of similar techniques out there.   For us, it’s likely that a basic approach will be good enough (in most cases, you won’t need one at all.)  For another, more sophisticated approach, check out <a href="http://toxiclibs.org/2010/02/new-package-simutils/">toxiclibs' Octree examples</a>.</p>
</section><section><a id="chapter06_section15" style="display: block;"></a><h3 id="615-a-few-last-notes-optimization-tricks">6.15  A Few Last Notes: Optimization Tricks</h3><p><a id="autonomous-agentsefficiency-82bd1a30-253f-0130-bcee-7cd1c3f718ad" style="display: block;"></a><a id="efficiency-82bd3340-253f-0130-bcef-7cd1c3f718ad" style="display: block;"></a><a id="performance-82bd4140-253f-0130-bcf0-7cd1c3f718ad" style="display: block;"></a></p>
<p>This is something of a momentous occasion.  The end of Chapter 6 marks the end of our story of motion (in the context of this book, that is).  We started with the concept of a vector, moved on to forces, designed systems of many elements, examined physics libraries, built entities with hopes and dreams and fears, and simulated emergence.  The story doesn’t end here, but it does take a bit of a turn.  The next two chapters won’t focus on moving bodies, but rather on systems of rules.   Before we get there, I have a few quick items I’d like to mention that are important when working with the examples in Chapters 1 through 6.  They also relate to optimizing your code, which fits in with the previous section.</p>
<section><a id="_1_magnitude_squared_or_sometimes_distance_squared" style="display: block;"></a><h4 id="1-magnitude-squared-or-sometimes-distance-squared">1) Magnitude squared (or sometimes distance squared)</h4><p>What is magnitude squared and when should you use it?  Let’s revisit how the magnitude of a vector is calculated.</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>float mag() {
  return sqrt(x*x + y*y);
}</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'><span class="kt">float</span> <span class="nf">mag</span><span class="o">()</span> <span class="o">{</span></span>
<span class='one-line'>  <span class="k">return</span> <span class="nf">sqrt</span><span class="o">(</span><span class="n">x</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="o">*</span><span class="n">y</span><span class="o">);</span></span>
<span class='one-line'><span class="o">}</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>Magnitude requires the square root operation.  And it should.  After all, if you want the magnitude of a vector, then you’ve got to look up the Pythagorean theorem and compute it (we did this in Chapter 1).  However, if you could somehow skip using the square root, your code would run faster.   Let’s consider a situation where you just want to know the relative magnitude of a vector.  For example, is the magnitude greater than ten?  (Assume a <span class="klass">PVector</span> <span class="var">v</span>.)</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>if (v.mag() > 10) {
  // Do Something!
}</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'><span class="k">if</span> <span class="o">(</span><span class="n">v</span><span class="o">.</span><span class="na">mag</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="o">)</span> <span class="o">{</span></span>
<span class='one-line'>  <span class="c1">// Do Something!</span></span>
<span class='one-line'><span class="o">}</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>Well, this is equivalent to saying:</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>if (v.magSq() > 100) {
  // Do Something!
}</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'><span class="k">if</span> <span class="o">(</span><span class="n">v</span><span class="o">.</span><span class="na">magSq</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="o">)</span> <span class="o">{</span></span>
<span class='one-line'>  <span class="c1">// Do Something!</span></span>
<span class='one-line'><span class="o">}</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>And how is magnitude squared calculated?</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>float magSq() {
  return x*x + y*y;
}</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'><span class="kt">float</span> <span class="nf">magSq</span><span class="o">()</span> <span class="o">{</span></span>
<span class='one-line'>  <span class="k">return</span> <span class="n">x</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="o">*</span><span class="n">y</span><span class="o">;</span></span>
<span class='one-line'><span class="o">}</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p><a id="efficiencymagsq-function-pvector-class-82bd8960-253f-0130-bcf1-7cd1c3f718ad" style="display: block;"></a><a id="mag-function-pvector-classmagsq-function-vs-82bd9e30-253f-0130-bcf2-7cd1c3f718ad" style="display: block;"></a><a id="magsq-function-pvector-class-82bdb0b0-253f-0130-bcf3-7cd1c3f718ad" style="display: block;"></a><a id="optimizationmagsq-function-pvector-class-82bdc2f0-253f-0130-bcf4-7cd1c3f718ad" style="display: block;"></a><a id="performancemagsq-function-pvector-class-82bde500-253f-0130-bcf5-7cd1c3f718ad" style="display: block;"></a></p>
<p>Same as magnitude, but without the square root.  In the case of a single <span class="klass">PVector</span> object, this will never make a significant difference on a Processing sketch.  However, if you are computing the magnitude of thousands of <span class="klass">PVector</span> objects each time through <span class="function">draw()</span>, using <span class="function">magSq()</span> instead of <span class="function">mag()</span> could help your code run a wee bit faster.  (Note: <span class="function">magSq()</span> is only available in Processing 2.0a1 or later.)</p>
</section><section><a id="_2_sine_and_cosine_lookup_tables" style="display: block;"></a><h4 id="2-sine-and-cosine-lookup-tables">2) Sine and cosine lookup tables</h4><p><a id="cosine-lookup-tables-82be3f10-253f-0130-bcf6-7cd1c3f718ad" style="display: block;"></a><a id="efficiencysinecosine-lookup-tables-82be4e40-253f-0130-bcf7-7cd1c3f718ad" style="display: block;"></a><a id="optimizationsinecosine-lookup-tables-82be6100-253f-0130-bcf8-7cd1c3f718ad" style="display: block;"></a><a id="performancesinecosine-lookup-tables-82be74c0-253f-0130-bcf9-7cd1c3f718ad" style="display: block;"></a><a id="sine-lookup-tables-82be86e0-253f-0130-bcfa-7cd1c3f718ad" style="display: block;"></a></p>
<p>There’s a pattern here.  What kinds of functions are slow to compute? Square root. Sine. Cosine.  Tangent.  Again, if you just need a sine or cosine value here or there in your code, you are never going to run into a problem.  But what if you had something like this?</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>void draw() {
  for (int i = 0; i < 10000; i++) {
     println(sin(PI));
  }
}</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'><span class="kt">void</span> <span class="nf">draw</span><span class="o">()</span> <span class="o">{</span></span>
<span class='one-line'>  <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span></span>
<span class='one-line'>     <span class="n">println</span><span class="o">(</span><span class="n">sin</span><span class="o">(</span><span class="n">PI</span><span class="o">));</span></span>
<span class='one-line'>  <span class="o">}</span></span>
<span class='one-line'><span class="o">}</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>Sure, this is a totally ridiculous code snippet that you would never write.  But it illustrates a certain point.  If you are calculating the sine of pi ten thousand times, why not just calculate it once, save that value, and refer to it whenever necessary?  This is the principle behind sine and cosine lookup tables.   Instead of calling the sine and cosine functions in your code whenever you need them, you can build an array that stores the results of sine and cosine at angles between 0 and <span class="var">TWO_PI</span> and just look up the values when you need them. For example, here are two arrays that store the sine and cosine values for every angle, 0 to 359 degrees.</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>float sinvalues[] = new float[360];
float cosvalues[] = new float[360];
for (int i = 0; i < 360; i++) {
  sinvalues[i] = sin(radians(i));
  cosvalues[i] = cos(radians(i));
}</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'><span class="kt">float</span> <span class="n">sinvalues</span><span class="o">[]</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">float</span><span class="o">[</span><span class="mi">360</span><span class="o">];</span></span>
<span class='one-line'><span class="kt">float</span> <span class="n">cosvalues</span><span class="o">[]</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">float</span><span class="o">[</span><span class="mi">360</span><span class="o">];</span></span>
<span class='one-line'><span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">360</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span></span>
<span class='one-line'>  <span class="n">sinvalues</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">sin</span><span class="o">(</span><span class="n">radians</span><span class="o">(</span><span class="n">i</span><span class="o">));</span></span>
<span class='one-line'>  <span class="n">cosvalues</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">cos</span><span class="o">(</span><span class="n">radians</span><span class="o">(</span><span class="n">i</span><span class="o">));</span></span>
<span class='one-line'><span class="o">}</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>Now, what if you need the value of sine of pi?</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>int angle = int(degrees(PI));
float answer = sinvalues[angle];</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'><span class="kt">int</span> <span class="n">angle</span> <span class="o">=</span> <span class="kt">int</span><span class="o">(</span><span class="n">degrees</span><span class="o">(</span><span class="n">PI</span><span class="o">));</span></span>
<span class='one-line'><span class="kt">float</span> <span class="n">answer</span> <span class="o">=</span> <span class="n">sinvalues</span><span class="o">[</span><span class="n">angle</span><span class="o">];</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>A more sophisticated example of this technique is available on the <a href="http://wiki.processing.org/w/Sin/Cos_look-up_table">Processing wiki</a>.</p>
</section><section><a id="_3_making_gajillions_of_unnecessary_pvector_objects" style="display: block;"></a><h4 id="3-making-gajillions-of-unnecessary-pvector-objects">3) Making gajillions of unnecessary PVector objects</h4><p><a id="efficiencytemporary-objects-and-82bebd80-253f-0130-bcfb-7cd1c3f718ad" style="display: block;"></a><a id="optimizationtemporary-objects-and-82bed860-253f-0130-bcfc-7cd1c3f718ad" style="display: block;"></a><a id="performancetemporary-objects-and-82beeca0-253f-0130-bcfd-7cd1c3f718ad" style="display: block;"></a></p>
<p>I have to admit, I am perhaps the biggest culprit of this last note.  In fact, in the interest of writing clear and understandable examples, I often choose to make extra <span class="klass">PVector</span> objects when I absolutely do not need to.  For the most part, this is not a problem at all.   But sometimes, it can be.  Let’s take a look at an example.</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>void draw() {
  for (Vehicle v : vehicles) {
   PVector mouse = new PVector(mouseX,mouseY);
   v.seek(mouse);
  }
}</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'><span class="kt">void</span> <span class="nf">draw</span><span class="o">()</span> <span class="o">{</span></span>
<span class='one-line'>  <span class="k">for</span> <span class="o">(</span><span class="n">Vehicle</span> <span class="n">v</span> <span class="o">:</span> <span class="n">vehicles</span><span class="o">)</span> <span class="o">{</span></span>
<span class='one-line'>   <span class="n">PVector</span> <span class="n">mouse</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PVector</span><span class="o">(</span><span class="n">mouseX</span><span class="o">,</span><span class="n">mouseY</span><span class="o">);</span></span>
<span class='one-line'>   <span class="n">v</span><span class="o">.</span><span class="na">seek</span><span class="o">(</span><span class="n">mouse</span><span class="o">);</span></span>
<span class='one-line'>  <span class="o">}</span></span>
<span class='one-line'><span class="o">}</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>Let’s say our <span class="klass">ArrayList</span> of vehicles has one thousand vehicles in it.  We just made one thousand new <span class="klass">PVector</span> objects every single time through <span class="function">draw()</span>.  Now, on any ol’ laptop or desktop computer you’ve purchased in recent times, your sketch will likely not register a complaint, run slowly, or have any problems.  After all, you’ve got tons of RAM, and Java will be able to handle making a thousand or so temporary objects and dispose of them without much of a problem.</p>
<p>If your numbers grow larger (and they easily could) or perhaps more likely, if you are working with Processing on Android, you will almost certainly run into a problem.  In cases like this you want to look for ways to reduce the number of <span class="klass">PVector</span> objects you make.  An obvious fix for the above code is:</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>void draw() {
  PVector mouse = new PVector(mouseX,mouseY);
  for (Vehicle v : vehicles) {
   v.seek(mouse);
  }
}</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'><span class="kt">void</span> <span class="nf">draw</span><span class="o">()</span> <span class="o">{</span></span>
<span class='one-line'>  <span class="n">PVector</span> <span class="n">mouse</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PVector</span><span class="o">(</span><span class="n">mouseX</span><span class="o">,</span><span class="n">mouseY</span><span class="o">);</span></span>
<span class='one-line'>  <span class="k">for</span> <span class="o">(</span><span class="n">Vehicle</span> <span class="n">v</span> <span class="o">:</span> <span class="n">vehicles</span><span class="o">)</span> <span class="o">{</span></span>
<span class='one-line'>   <span class="n">v</span><span class="o">.</span><span class="na">seek</span><span class="o">(</span><span class="n">mouse</span><span class="o">);</span></span>
<span class='one-line'>  <span class="o">}</span></span>
<span class='one-line'><span class="o">}</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>Now you’ve made just one <span class="klass">PVector</span> instead of one thousand.  Even better, you could turn the <span class="klass">PVector</span> into a global variable and just assign the <span class="var">x</span> and <span class="var">y</span> value:</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>PVector mouse = new PVector();

void draw() {
  mouse.x = mouseX;
  mouse.y = mouseY;
  for (Vehicle v : vehicles) {
   v.seek(mouse);
  }
}</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'><span class="n">PVector</span> <span class="n">mouse</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PVector</span><span class="o">();</span></span>
<span class='one-line'> </span>
<span class='one-line'><span class="kt">void</span> <span class="nf">draw</span><span class="o">()</span> <span class="o">{</span></span>
<span class='one-line'>  <span class="n">mouse</span><span class="o">.</span><span class="na">x</span> <span class="o">=</span> <span class="n">mouseX</span><span class="o">;</span></span>
<span class='one-line'>  <span class="n">mouse</span><span class="o">.</span><span class="na">y</span> <span class="o">=</span> <span class="n">mouseY</span><span class="o">;</span></span>
<span class='one-line'>  <span class="k">for</span> <span class="o">(</span><span class="n">Vehicle</span> <span class="n">v</span> <span class="o">:</span> <span class="n">vehicles</span><span class="o">)</span> <span class="o">{</span></span>
<span class='one-line'>   <span class="n">v</span><span class="o">.</span><span class="na">seek</span><span class="o">(</span><span class="n">mouse</span><span class="o">);</span></span>
<span class='one-line'>  <span class="o">}</span></span>
<span class='one-line'><span class="o">}</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>Now you never make a new <span class="klass">PVector</span>; you use just one over the length of your sketch!</p>
<p>Throughout the book’s examples, you can find lots of opportunities to reduce the number of temporary objects.  Let’s look at one more.  Here is a snippet from our <span class="function">seek()</span> function.</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>    PVector desired = PVector.sub(target,location);
    desired.normalize();
    desired.mult(maxspeed);

    // Create a new PVector to store the steering force.
    PVector steer = PVector.sub(desired,velocity); //[bold]
    steer.limit(maxforce);
    return steer;</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'>    <span class="n">PVector</span> <span class="n">desired</span> <span class="o">=</span> <span class="n">PVector</span><span class="o">.</span><span class="na">sub</span><span class="o">(</span><span class="n">target</span><span class="o">,</span><span class="n">location</span><span class="o">);</span></span>
<span class='one-line'>    <span class="n">desired</span><span class="o">.</span><span class="na">normalize</span><span class="o">();</span></span>
<span class='one-line'>    <span class="n">desired</span><span class="o">.</span><span class="na">mult</span><span class="o">(</span><span class="n">maxspeed</span><span class="o">);</span></span>
<span class='one-line'> </span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>Create a new PVector to store the steering force.</div><code><pre><span class='one-line'>    <strong><span class="n">PVector</span> <span class="n">steer</span> <span class="o">=</span> <span class="n">PVector</span><span class="o">.</span><span class="na">sub</span><span class="o">(</span><span class="n">desired</span><span class="o">,</span><span class="n">velocity</span><span class="o">);</span></strong></span>
<span class='one-line'>    <span class="n">steer</span><span class="o">.</span><span class="na">limit</span><span class="o">(</span><span class="n">maxforce</span><span class="o">);</span></span>
<span class='one-line'>    <span class="k">return</span> <span class="n">steer</span><span class="o">;</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>See how we’ve made two <span class="klass">PVector</span> objects?  First, we figure out the desired vector, then we calculate the steering force.  Notice how we could rewrite this to create only one <span class="klass">PVector</span>.</p>
<div class="source-code">
  <a class="toggle" href="chapter-6-autonomous-agents.html#" data-to-raw='Show Raw' data-to-formatted='Show Formatted'>Show Raw</a>
  <textarea>    PVector desired = PVector.sub(target, location);
    desired.normalize();
    desired.mult(maxspeed);

    // Calculate the steering force in the desired PVector.
    desired.sub(velocity); //[bold]
    desired.limit(maxforce);
    return desired;</textarea>
  
  
  
  <div class="code-block">

  <div class='code-comment-pair no-comment'><code><pre><span class='one-line'>    <span class="n">PVector</span> <span class="n">desired</span> <span class="o">=</span> <span class="n">PVector</span><span class="o">.</span><span class="na">sub</span><span class="o">(</span><span class="n">target</span><span class="o">,</span> <span class="n">location</span><span class="o">);</span></span>
<span class='one-line'>    <span class="n">desired</span><span class="o">.</span><span class="na">normalize</span><span class="o">();</span></span>
<span class='one-line'>    <span class="n">desired</span><span class="o">.</span><span class="na">mult</span><span class="o">(</span><span class="n">maxspeed</span><span class="o">);</span></span>
<span class='one-line'> </span></pre></code></div>

  <div class='code-comment-pair '><div class='code-comment '>Calculate the steering force in the desired PVector.</div><code><pre><span class='one-line'>    <strong><span class="n">desired</span><span class="o">.</span><span class="na">sub</span><span class="o">(</span><span class="n">velocity</span><span class="o">);</span></strong></span>
<span class='one-line'>    <span class="n">desired</span><span class="o">.</span><span class="na">limit</span><span class="o">(</span><span class="n">maxforce</span><span class="o">);</span></span>
<span class='one-line'>    <span class="k">return</span> <span class="n">desired</span><span class="o">;</span></span></pre></code></div>

</div>
  <div style="position: relative;clear:both;display:block;height:1px;width:100%;"></div>
</div><p>We don’t actually need a second <span class="klass">PVector</span> called <span class="var">steer</span>.  We could just use the desired <span class="klass">PVector</span> object and turn it into the steering force by subtracting velocity.  I didn’t do this in my example because it is more confusing to read.  But in some cases, it may be greatly more efficient.</p>
<div class="example">
  <a id="chapter06_exercise20" style="display: block;"></a><h5 id="exercise-620">Exercise 6.20</h5><p>Eliminate as many temporary <span class="klass">PVector</span> objects from the flocking example as possible.  Also use <span class="function">magSq()</span> where possible.</p>

</div><div class="example">
  <a id="chapter06_exercise21" style="display: block;"></a><h5 id="exercise-621">Exercise 6.21</h5><p>Use steering behaviors with Box2D or toxiclibs.</p>

</div><div style="page-break-after:always;"> </div><div class="tip">
  <h5 id="the-ecosystem-project">The Ecosystem Project</h5><p>Step 6 Exercise:</p>
<p>Use the concept of steering forces to drive the behavior of the creatures in your ecosystem.  Some possibilities:</p>
<div class="list">
	
	<ul>
		
			<li><p>
Create “schools” or “flocks” of creatures.
</p>
</li>
		
			<li><p>
Use a seeking behavior for creatures to search for food (for chasing moving prey, consider “pursuit”).
</p>
</li>
		
			<li><p>
Use a flow field for the ecosystem environment.  For example, how does your system behave if the creatures live in a flowing river?
</p>
</li>
		
			<li><p>
Build a creature with countless steering behaviors (as many as you can reasonably add).  Think about ways to vary the weights of these behaviors so that you can dial those behaviors up and down, mixing and matching on the fly.    How are creatures’ initial weights set?  What rules drive how the weights change over time?
</p>
</li>
		
			<li><p>
Complex systems can be nested.  Can you design a single creature out of a flock of boids?  And can you then make a flock of those creatures?
</p>
</li>
		
			<li><p>
Complex systems can have memory (and be adaptive).  Can the history of your ecosystem affect the behavior in its current state? (This could be the driving force behind how the creatures adjust their steering force weights.)
</p>
</li>
		
	</ul>
</div>
</div><div style="page-break-after:always;"> </div></section></section>
  	</div>
  </div>

	<div id="bottom">
		<div id="footer">
			<div class="one-third" id="licenses">
        <h4>Licenses</h4>
        <p>
          <a class="license-badge" rel="license" href="http://creativecommons.org/licenses/by-nc/3.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc/3.0/88x31.png" /></a>
          <a class="license-badge" rel="license" href="http://creativecommons.org/licenses/LGPL/2.1/"><img alt="LGPL License" style="border-width:0" src="http://www.gnu.org/graphics/lgplv3-88x31.png" /></a>
        </p>

        <p>
          The book's text and illustrations are licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc/3.0/">Creative Commons Attribution-NonCommercial 3.0 Unported License</a>.
        </p>

        <p>
          All of the book's source code is licensed under the <a rel="license" href="http://creativecommons.org/licenses/LGPL/2.1/">GNU Lesser General Public License</a> as published by the Free Software Foundation; either version 2.1 of the License, or (at your option) any later version.
        </p>

      </div>

      <div class="one-third">
        <h4>Colophon</h4>

        <p>This book was generated with <a href="https://github.com/runemadsen/Magic-Book-Project">The Magic Book Project</a>.

        <p>This book would not have been possible without the generous support of <a href="http://www.kickstarter.com/projects/shiffman/the-nature-of-code-book-project">Kickstarter</a> backers.</p> 

        <p>This book is typeset on the web in Georgia with headers in Proxima Nova.</p>

        <p>Please report any mistakes in the book or bugs in the source with a <a href="https://github.com/shiffman/The-Nature-of-Code/issues?sort=created&state=open">GitHub issue</a> or contact me at <span class="eml">daniel at shiffman dot net</span>.</p>
      </div>

      <div class="one-third">
        <h4>Author</h4>
        <p>Daniel Shiffman is a professor of the <a href="http://itp.nyu.edu/">Interactive Telecommunications Program</a> at New York University.</p>

        <p>He is the author of <a href="http://www.learningprocessing.com/">Learning Processing</a>.</p>

        <p><a href="https://twitter.com/shiffman">Twitter</a> <a href="http://github.com/shiffman">GitHub</a></p>
      </div>
		</div>
	</div>
</body>
</html>