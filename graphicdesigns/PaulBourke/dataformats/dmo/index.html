<html>
<head>
<link rel=StyleSheet href="../../pdbstyle.css" type="text/css" media=all>
<title>DMO file format</title>
</head>
<body>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<script language="JavaScript">
<!--
   if (self.location.href != top.location.href) {
      top.location.href = self.location.href;
   }
-->
</script>


<center><table width=800><tr><td>

<center>
<h1>DMO format</h1>
Duke Nukem 3D or Redneck Rampage.<br>
Original by Uwe Girlich
</center>
<p><br><p>

<H2><A NAME="s1">1. Introduction</A></H2>

<P>To create a DMO file start the game with the command line switch
<CODE>/r</CODE> (and <CODE>/l</CODE> (level), <CODE>/s</CODE> (skill) etc.) and play as
usual. If you press <CODE>F10</CODE> the record (and the game) stops. 
You will find a file <CODE>demo1.dmo</CODE> in the current directory. To play it 
back just start the game and hide the menu by pressing <CODE>ESC</CODE>.
<P>In Duke Nukem 3D 1.0 and 1.1 the skill value is a bit strange:
To record a skill <EM>n</EM> (1&lt;=<EM>n</EM>&lt;=4) game note to use 
<CODE>/s<EM>n+1</EM></CODE>.
So <CODE>/s2</CODE> is ``Peace of Cake'' and <CODE>/s5</CODE> is 
``Damn I'm Good''. The <CODE>dn3dhelp.exe</CODE> hint 
(<CODE>/s<EM>n</EM></CODE> with 0&lt;=<EM>n</EM>&lt;=3) is totally wrong.
<P>Multiplayer recordings have always the skill 0. Cooperative
recordings won't play back properly.   
<P>It is impossible to record with version 1.0 more than one level. You can't 
even record the summary screen at the end of each level.
<P>In version 1.1 it <EM>seems</EM> to be possible (I got it some times). 
Some other times I got only the recording of the last level.
<P>A DMO file records all player actions. The monster movements, re-spawn
positions etc. are totally deterministic. The messages during a multiplayer 
game (macros and RemoteRedicule (tm)) do not appear in the DMO.
<P>A DMO file consists of a header with some organizational information
and the data area with all the (compressed) game tics. 
<P>The term ``game tic'' comes originally from DOOM and denotes the smallest unit
of time during the game. The duration of a game tic is
1/30s. To store a game tic in a file means to store all actions, like
movement, open doors, fire weapons and so on, happened during this time. 
<p>

<H2><A NAME="s2">2. Header</A></H2>

<P>
<H2><A NAME="ss2.1">2.1 old Duke Nukem 3D Header</A>
</H2>

<P>Duke Nukem 3D 1.0 and 1.1 use a 9 byte main header:
<BR>
<table><tr><td>
address </TD><TD>type </TD><TD>contents</TD></TR><TR><TD>
<CODE>0x0000</CODE> </TD><TD><CODE>long</CODE> </TD><TD>number of game tics times number of players</TD></TR><TR><TD>
<CODE>0x0004</CODE> </TD><TD><CODE>byte</CODE> </TD><TD>episode (0-3)</TD></TR><TR><TD>
<CODE>0x0005</CODE> </TD><TD><CODE>byte</CODE> </TD><TD>map (0-8)</TD></TR><TR><TD>
<CODE>0x0006</CODE> </TD><TD><CODE>byte</CODE> </TD><TD>skill (0-4)</TD></TR><TR><TD>
<CODE>0x0007</CODE> </TD><TD><CODE>word</CODE> </TD><TD>player number
</td></tr></table>

<P>The first entry in the header (number of game tics) may be zero in version 1.1
recordings. This should mean, that there is more than one level recorded.
<P>All <CODE>word</CODE> or <CODE>long</CODE> values in DMO files are Intel ordered
(lowest byte first, little endian).
<P>
<H2><A NAME="ss2.2">2.2 new Duke Nukem 3D Header</A>
</H2>

<P>Duke Nukem 3D 1.3D uses a 24 byte main header:
<BR>
<table><tr><td>
address </TD><TD>type </TD><TD>contents</TD></TR><TR><TD>
<CODE>0x0000</CODE> </TD><TD><CODE>long</CODE> </TD><TD>number of game tics times number of players</TD></TR><TR><TD>
<CODE>0x0004</CODE> </TD><TD><CODE>byte</CODE> </TD><TD>volume - 1 (/v parameter - 1)</TD></TR><TR><TD>
<CODE>0x0005</CODE> </TD><TD><CODE>byte</CODE> </TD><TD>level - 1 (/l paramerer - 1)</TD></TR><TR><TD>
<CODE>0x0006</CODE> </TD><TD><CODE>byte</CODE> </TD><TD>skill (0 .. 4) (/s parameter)</TD></TR><TR><TD>
<CODE>0x0007</CODE> </TD><TD><CODE>byte</CODE> </TD><TD>MP mode (/c 1 = DukeMatch(spawn), 2 = Coop, 3 = Dukematch(no spawn))</TD></TR><TR><TD>
<CODE>0x0008</CODE> </TD><TD><CODE>short</CODE> </TD><TD>player number (1..8)</TD></TR><TR><TD>
<CODE>0x000A</CODE> </TD><TD><CODE>short</CODE> </TD><TD><CODE>0x01</CODE> with /m (nomonsters), <CODE>0x00</CODE> else</TD></TR><TR><TD>
<CODE>0x000C</CODE> </TD><TD><CODE>long</CODE> </TD><TD><CODE>0x01</CODE> with /t1 (respawn monsters), <CODE>0x00</CODE> else</TD></TR><TR><TD>
<CODE>0x0010</CODE> </TD><TD><CODE>long</CODE> </TD><TD><CODE>0x01</CODE> with /t2 (respawn items), <CODE>0x00</CODE> else</TD></TR><TR><TD>
<CODE>0x0014</CODE> </TD><TD><CODE>long</CODE> </TD><TD><CODE>0x01</CODE> with /t3 (respawn inventory), <CODE>0x00</CODE> else
</td></tr></table>

<P>
<P>
<H2><A NAME="ss2.3">2.3 Redneck Rampage Header</A>
</H2>

<P>Redneck Rampage uses a 543 byte main header:
<BR>
<table><tr><td>
address </TD><TD>type </TD><TD>contents</TD></TR><TR><TD>
<CODE>0x0000</CODE> </TD><TD><CODE>long</CODE> </TD><TD>number of game tics times number of players</TD></TR><TR><TD>
<CODE>0x0004</CODE> </TD><TD><CODE>byte</CODE> </TD><TD><CODE>0x6C</CODE>, it may be a version</TD></TR><TR><TD>
<CODE>0x0005</CODE> </TD><TD><CODE>byte</CODE> </TD><TD><CODE>0x00</CODE>, unknown</TD></TR><TR><TD>
<CODE>0x0006</CODE> </TD><TD><CODE>byte</CODE> </TD><TD><CODE>0x00</CODE>, unknown</TD></TR><TR><TD>
<CODE>0x0007</CODE> </TD><TD><CODE>byte</CODE> </TD><TD>skill (0...4)</TD></TR><TR><TD>
<CODE>0x0008</CODE> </TD><TD><CODE>byte</CODE> </TD><TD>MP mode (/c parameter - 1)</TD></TR><TR><TD>
<CODE>0x0009</CODE> </TD><TD><CODE>byte</CODE> </TD><TD>level (1..11)</TD></TR><TR><TD>
<CODE>0x000A</CODE> </TD><TD><CODE>byte</CODE> </TD><TD>player number (1..8)</TD></TR><TR><TD>
<CODE>0x000B</CODE> </TD><TD><CODE>byte</CODE> </TD><TD><CODE>0x00</CODE>, unknown</TD></TR><TR><TD>
<CODE>0x000C</CODE> </TD><TD><CODE>byte</CODE> </TD><TD><CODE>0x01</CODE> with /m (nomonsters), <CODE>0x00</CODE> else</TD></TR><TR><TD>
<CODE>0x000D</CODE> </TD><TD><CODE>byte</CODE> </TD><TD><CODE>0x00</CODE>, unknown</TD></TR><TR><TD>
<CODE>0x000E</CODE> </TD><TD><CODE>long</CODE> </TD><TD><CODE>0x01</CODE> with /t1 (respawn monsters), <CODE>0x00</CODE> else</TD></TR><TR><TD>
<CODE>0x0012</CODE> </TD><TD><CODE>long</CODE> </TD><TD><CODE>0x01</CODE> with /t2 (respawn items), <CODE>0x00</CODE> else</TD></TR><TR><TD>
<CODE>0x0016</CODE> </TD><TD><CODE>long</CODE> </TD><TD><CODE>0x01</CODE> with /t3 (respawn inventory), <CODE>0x00</CODE> else</TD></TR><TR><TD>
<CODE>0x001A</CODE> </TD><TD><CODE>long</CODE> </TD><TD><CODE>0x01</CODE> with /a (player AI for fake players), <CODE>0x00</CODE> else</TD></TR><TR><TD>
<CODE>0x001E</CODE> </TD><TD><CODE>char[0x201]</CODE> </TD><TD>-name parameter</TD></TR></table>

<P>The episode (better: volume) number is one of the <CODE>0x00</CODE> bytes in the
header.
<P>The players name is a `\0' terminated string. The maximum number of 
characters for the name is 512.
<p>

<H2><A NAME="s3">3. Data</A></H2>

<P> 
The data starts in byte <CODE>0x0009</CODE> (old Duke Nukem 3D),
<CODE>0x0018</CODE> (new Duke Nukem 3D) or 
<CODE>0x021F</CODE> (Redneck Rampage) of the DMO file and is organized in
several blocks.
<P>
<H2><A NAME="ss3.1">3.1 Block</A>
</H2>

<P>Each block consists of a header with some organizational information
and the compressed data.
<P>A block header is:
<BR>
<table><tr><td>  
address </TD><TD>type </TD><TD>contents</TD></TR><TR><TD>
<CODE>0x0000</CODE> </TD><TD><CODE>word</CODE> </TD><TD>size of the following blockin bytes</TD></TR><TR><TD>
<CODE>0x0002</CODE> </TD><TD><CODE>word</CODE> </TD><TD>size of the uncompresseddata block in bytes</TD></TR><TR><TD>
<CODE>0x0004</CODE> </TD><TD><CODE>word</CODE> </TD><TD>biggest code for Lempel-Zivdecompression</TD></TR></table>

<P>The compressed data starts in byte <CODE>0x0006</CODE> of the block.
The block size (0x0000/0x0001) includes the rest of the header. This means
there are only block size - 4 data bytes.
<P>
<H2><A NAME="ss3.2">3.2 Compression technique</A>
</H2>

<P>Duke Nukem 3D uses a modified Lempel-Ziv algorithm (similar to the
UNIX command <CODE>compress(1)</CODE>) to compress the game tics. To reach an 
even better compression ratio not the game tic itself but the difference
to the last one of the same player (difference per byte, without carry bits)
will be compressed. This increases the number of 0 bytes enormously and allows
long recording in short files. 
<P>In fact Steffen Winterfeldt changed the original
<CODE>compress.c</CODE> until we could decompress a DMO file. 
<P>The compression algorithm used in Redneck Rampage seems to be similar but I
did not get <CODE>lzw.c</CODE> and <CODE>unlzw.c</CODE> to work with Redneck Rampage
recordings.
<P>
<H2><A NAME="ss3.3">3.3 Macro block</A>
</H2>

<P>Some blocks of data form a macro block. This has to do with both decompression
and game tic difference storing. The first game tic in a macro block is the
original game tic. All the following game tics are only the byte-per-byte
difference game tics to its specific predecessors. There is no special code to
signalize the end of a macro block. It is simply the number 
2520/(player number) game tics, which makes a macro block. 
Note that 2520 is divisible by 1,2, ... ,8 without remainder. 
Only the last macro block may contain less game tics if the file ends 
before.
<P>
<H2><A NAME="Data"></A> <A NAME="ss3.4">3.4 Data description</A>
</H2>

<P>One game tic corresponds to 10 times player number bytes:
<BR>
<table><tr><td>  
address </TD><TD>type </TD><TD>player </TD><TD>contents</TD></TR><TR><TD>
<CODE>0x0000</CODE> </TD><TD><CODE>word</CODE> </TD><TD>1 </TD><TD>go in <EM>x</EM>-direction</TD></TR><TR><TD>
<CODE>0x0002</CODE> </TD><TD><CODE>word</CODE> </TD><TD>1 </TD><TD>go in <EM>y</EM>-direction</TD></TR><TR><TD>
<CODE>0x0004</CODE> </TD><TD><CODE>word</CODE> </TD><TD>1 </TD><TD>turn</TD></TR><TR><TD>
<CODE>0x0006</CODE> </TD><TD><CODE>long</CODE> </TD><TD>1 </TD><TD>use/open etc.</TD></TR><TR><TD>
<CODE>0x000a</CODE> </TD><TD><CODE>word</CODE> </TD><TD>2 </TD><TD>go in <EM>x</EM>-direction</TD></TR><TR><TD>
<CODE>0x000c</CODE> </TD><TD><CODE>word</CODE> </TD><TD>2 </TD><TD>go in <EM>y</EM>-direction</TD></TR><TR><TD>
. </TD></TR><TR><TD>
. </TD></TR><TR><TD>
. </TD></TR></table>

<P>
<H3>Go <EM>x</EM> and <EM>y</EM></H3>

<P>The 2 words (<CODE>signed short</CODE>) are duke's speed or the displacement
vector in length units per game tic.
<P>To calculate the absolute value of his speed just calculate 
sqrt(x<SUP>2</SUP>+y<SUP>2</SUP>).
<P>A standard speed is 1280 (with running 2560). The coordinate system used is like
this:
<BLOCKQUOTE><CODE>
<PRE>
            |
            |
            |
------------+-----------> x
            |
            |
            |
           \|/
            y
</PRE>
</CODE></BLOCKQUOTE>
<P>
<H3>Turn</H3>

<P>The turn word contains 2 bytes (<CODE>signed short</CODE>) which are the
current turning speed or the angle difference per game tic.
A positive turning speed means right and a negative
means left.
<P>
<H3>Use</H3>

<P>There are many ``use'' actions in Duke Nukem 3D. You can do all at once,
because there is a single bit for each action. The appropriate bit is 1 as long
as you press the corresponding key.
<BR>
<table><tr><td>
bit </TD><TD>purpose</TD></TR><TR><TD>
31 </TD><TD>??</TD></TR><TR><TD>
30 </TD><TD>Inventory</TD></TR><TR><TD>
29 </TD><TD>Open</TD></TR><TR><TD>
28 </TD><TD>TurnAround</TD></TR><TR><TD>
27 </TD><TD>Inventory_Right</TD></TR><TR><TD>
26 </TD><TD>??</TD></TR><TR><TD>
25 </TD><TD>Jetpack</TD></TR><TR><TD>
24 </TD><TD>Holo_Duke</TD></TR><TR><TD>
23 </TD><TD>Mouse_Aiming</TD><TD>new in 1.1</TD></TR><TR><TD>
22 </TD><TD>??</TD></TR><TR><TD>
21 </TD><TD>Pause</TD></TR><TR><TD>
20 </TD><TD>Inventory_Left</TD></TR><TR><TD>
19 </TD><TD>Holster_Weapon</TD></TR><TR><TD>
18 </TD><TD>Center_View</TD></TR><TR><TD>
17 </TD><TD>AutoRun</TD></TR><TR><TD>
16 </TD><TD>MedKit</TD></TR><TR><TD>
15 </TD><TD>NightVision</TD></TR><TR><TD>
14 </TD><TD>Look_Down</TD></TR><TR><TD>
13 </TD><TD>Look_Up</TD></TR><TR><TD>
12 </TD><TD>Steroids</TD><TD>new in 1.1</TD></TR><TR><TD>
8-11 </TD><TD>Weapon number</TD></TR><TR><TD>
7 </TD><TD>??</TD></TR><TR><TD>
6 </TD><TD>??</TD></TR><TR><TD>
5 </TD><TD>Run</TD></TR><TR><TD>
4 </TD><TD>Aim_Down</TD></TR><TR><TD>
3 </TD><TD>Aim_Up</TD></TR><TR><TD>
2 </TD><TD>Fire</TD></TR><TR><TD>
1 </TD><TD>Crouch</TD></TR><TR><TD>
0 </TD><TD>Jump</TD></TR></table>

</td></tr></table></center>
</body>
</html>

