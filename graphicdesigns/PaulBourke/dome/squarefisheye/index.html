<html>
<head>
<link rel=StyleSheet href="../../pdbstyle.css" type="text/css" media=all>
<title>Square fisheye</title>
</head>
<body>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<script language="JavaScript">
<!--
   if (self.location.href != top.location.href) {
      top.location.href = self.location.href;
   }
-->
</script>


<center><table width=800><tr><td>

<center>
<h1>Square Fisheye</h1>
Written by <a href="../index.html">Paul Bourke</a><br>
Special tanks to Nan Ma for solving the inverse mapping equations<br>
January 2020
</center>
<p><br><p>

<p align="justify">
The following introduces the concept of a 180 degree fisheye (although other angles are
possible) that fills a square image, rather than being limited to an inscribed circle
as per the usual fisheye projection.
The method presented here is just one of a large number of ways a circle can be expanded
to fill a square.
</p>

<p align="justify">
In the transformation here
the field angle p(x,y,z) for every point (u,v) in a square image plane is given below.
This mapping is conformal except for the 4 corner points of the square, 
that is, angles between features in the input image are
preserved in the output image. The mapping is not equal area.
</p>

<center>
	<img src="http://paulbourke.net/dome/squarefisheye/equation.png" width=300 height= border=0>
</center><p>

<p align="justify">
A 180 degree fisheye is represented in the traditional way in the first image below,
the equivalent square fisheye is shown in the second image.
For reasons that are not at all obvious, the MandelBulb3D software offers this
as one of the rendering options, specifically, the "common" camera with 180 field of view.
</p>

<center>
	<a href="http://paulbourke.net/dome/squarefisheye/photo.jpg"><img src="http://paulbourke.net/dome/squarefisheye/photo_s.jpg" width=800 height=1608 border=1></a>
</center><p>

<p align="justify">
This projection has been discussed in papers by Chamberlain Fong under the somewhat
more complex formulation called Schwarz-Christoffel mapping, credited to
Hermann Schwarz and Elwin Christoffel. Unfortunately it uses complex analysis and
the formulation uses rather complicated complex valued incomplete Legendre elliptic 
integrals of the 1st kind as well as complex valued Jacobi elliptic functions.
</p>

<p align="justify">
The forward mapping can be expressed as a transformation from a 2D point on the image 
plane (u,v) to a unit vector p(x,y,z).
Conversions between a circular fisheye image and square fisheye image is implemented
as follows.
</p>
<center>
	<img src="http://paulbourke.net/dome/squarefisheye/equation2.png" width=300 height=79 border=0>
</center><p>

<p align="justify">
Where p(x,y,z) is the field angle for a particular pixel (u,v).
The inverse mapping, solved by Nan Ma, is given below. 
Specifically, given a unit vector (x,y,z) what is the corresponding (u,v).
</p>

<p align="justify">
Define the following
</p>

<center>
	<img src="http://paulbourke.net/dome/squarefisheye/equation3.png" width=300 height=100 border=0>
</center><p>

<p align="justify">
then
</p>

<center>
	<img src="http://paulbourke.net/dome/squarefisheye/equation4.png" width=300 height=57 border=0>
</center><p>

<p align="justify">
The forward and reverse mappings have been implemented in a command line style utility
that can convert to and from standard circular fisheyes and square fisheyes.
Please note that in this case the solution assumes the mappings are between vectors
p(x,y,z) encoded as fisheye projections on the image plane.
</p>

<pre>
Usage: square2fish [options] squareimage
Options
   -w n       width and height of the fisheye image, default = 1024
   -t n       fisheye FOV (degrees), default = 180
   -a n       antialiasing level, default = 2
   -o s       output file name, default: name derived from input filename
   -d n       direction, 1 or -1, default: 1
   -v         debug mode, default: off
</pre>

<b>References</b><p>
<ul>
<li><p align="justify">
Analytical Methods for Squaring the Disc.
Chamberlain Fong.
Seoul ICM 2014.
</p>

<li><p align="justify">
Elliptification of Rectangular Imagery.
Chamberlain Fong.
Joint Mathematics Meetings 2019, SIGMAA-ARTS
</p>

<li><p align="justify">
Normal vector method for convergence improvement using the RCWA for crossed gratings.
Thomas Schuster, Johannes Ruoff, Norbert Kerwien, Stephan Rafler, and Wolfgang Osten1.
J. Opt. Soc. Am. A/Vol. 24, No. 9/September 2007.
</p>

<li><p align="justify">
A Low Distortion Map Between Disk and Square.
Shirley, P., Chiu, K.
Journal of Graphics Tools, volume 2 number 3, 1977.
</p>

<li><p align="justify">
Mappings between Sphere, Disc, and Square.
Martin Lambers.
Journal of Computer Graphics Techniques Vol. 5, No. 2, 2016.
</p>

<li><p align="justify">
Fast and Stable Conformal Mapping Between a Disc and a Square.
Michael M. Stark.
Journal of Graphics, GPU, and Game Tools, Volume 14, Issue 2, 2009.
</p>
</ul>

</td></tr></table></center><p>
</body>
</html>

