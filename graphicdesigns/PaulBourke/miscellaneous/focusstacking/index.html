<html>
<head><link rel=StyleSheet href="../../pdbstyle.css" type="text/css" media=all>
<title>Focus Stacking and Image Mosaicking </title>
</head>
<body>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<script language="JavaScript">
<!--
   if (self.location.href != top.location.href) {
      top.location.href = self.location.href;
   }
-->
</script>


<center><table width=800><tr><td>

<center>
<h1>Focus Stacking with the Phase One</h1>
Written by <a href="../index.html">Paul Bourke</a><br>
April 2016
<p><br><p>
</center>

<p align="justify">
Focus stacking is the process by which multiple photographs, each with a different focal plane,
are combined into a single image with an overall deeper depth of focus. The most common application
is in macro photography where the object is close to the lens and the depth of focus does
not extend across the depth of the object. While using limited depth of focus is often an
artistic/composition choice, there are other applications such as digital recording for archive purposes
where having all depths in focus is desirable.
</p>

<p align="justify">
There are a number of ways the multiple focal levels can be arranged. They may be set manually, simply
focusing on a different part of the object for each photograph. 
Or one can use a mechanical slider, focus on the
camera set and the camera is moved closer or further from the object. This later approach has
the benefit of not introducing focus breathing, the process by which the zoom changes slightly
with focus. However current focus stacking algorithms are able to correct for 
slight zoom changes. There are
also motorised and various levels of automation that can be applied to each of the above two techniques.
It goes without saying that this process is only suited to tripod mounted camera and stationary
subject matter.
</p>

<p align="justify">
This document presents focus stacking in the context of the Sony Phase One camera, one of
a number of tests conducted with the camera. The Phase One is the most recent medium format
camera from Sony with a 100MPixel back.
The latest revision (at the time of writing) of the Capture One Pro software includes an automated 
focus scan controller.
These focus stacking controls consist of setting the near and far focus points and the number
of focus points within that range. For optimal results for accurate focus on the Phase
One the computer controlled focus controls through Live View on the Capture One
Pro software is a necessity.
</p>
<center>
   <img src="http://paulbourke.net/miscellaneous/focusstacking/fig1.jpg" width=800 height=600 border=1><br>
   <font size=-1>Automatic focus stacking controls</font>
</center><p>

<b>Example 1</b><p>
<p align="justify">
Two examples are presented here, fairly traditional applications of focus stacking.
The lens used on the Phase One is their 120mm macro lens.
In this first example only 12 photographs were taken, as it happens this was insufficient
(see zones of slight lack of focus in the final stacked image). The number of photographs
to take is not always a simple matter to determine, it depends on the aperture and the
range of depth one is trying to capture. 
The algorithms require an overlap in the focused zones in order to align and deal
with scaling from focus breathing. Typically a 30% overlap of the in-focus layer is the
rule of thumb, if you have a camera that shows in-focus regions then that can be used to
check suitable overlap.
</p>
<center>
   <img src="http://paulbourke.net/miscellaneous/focusstacking/ex1_fig2.jpg" width=800 height=600 border=1><br>
   <font size=-1>Closest part of object</font>
</center><p>

<p align="justify">
Note that one does not necessarily choose ever smaller apertures (higher f-numbers).
At some point blurring will start to occur due to diffraction effects. While the lens
employed was determined to be safe up to f16, for the image here f7 was chosen.
</p>
<center>
   <img src="http://paulbourke.net/miscellaneous/focusstacking/ex1_fig1.jpg" width=800 height=600 border=1><br>
   <font size=-1>Furthest part of object</font>
</center><p>

<p align="justify">
The following is the final focus stacked image.
</p>
<center>
   <a href="http://paulbourke.net/miscellaneous/focusstacking/ex1_fig3.jpg">
   <img src="http://paulbourke.net/miscellaneous/focusstacking/ex1_fig3s.jpg" width=800 height=600 border=1><br>
   <font size=-1>Download or click to explore full resolution</font></a>
</center><p>

<p align="justify">
Fundamental to the algorithm is determining the various in-focus zones. These are shown
below shaded by depth (white most distant, black closest to the lens), the black surround
arises from lack of any focus on the grey background.
</p>
<center>
   <a href="http://paulbourke.net/miscellaneous/focusstacking/ex1_fig4.jpg">
   <img src="http://paulbourke.net/miscellaneous/focusstacking/ex1_fig4s.jpg" width=800 height=600 border=1></a><br>
   <font size=-1>Greyscale depth map</font>
</center><p>

<p align="justify">
One could then also interpret these layers as depths of a 3D surface, this is shown below.
In this case it is a rather poor 3D model with clear discrete steps in depth, 
not unexpected from only 12 photographs.
While one may consider this an alternative approach to 3D reconstruction, it performs much
poorer for a number of reasons. Mainly, it is just a height field perpendicular to the 
camera position so obviously cannot resolve concave features. Also the focus zones are
generally quite coarse compared to the structures once could readily derive from a
3D reconstruction approach.
</p>
<center>
   <a href="http://paulbourke.net/miscellaneous/focusstacking/ex1_fig5.png">
   <img src="http://paulbourke.net/miscellaneous/focusstacking/ex1_fig5s.png" width=800 height=374 border=1></a><br>
   <font size=-1>3D model</font>
</center><p>
<p><br><p>

<b>Example 2</b><p>

<p align="justify">
In this example 30 photographs were taken across the chosen depth range. One can imagine that
now that the process is automated then one might choose to err on the side of too many
photographs knowing that only every 2nd or 3rd might be used for the focus stacking process.
</p>
<center>
	<img src="http://paulbourke.net/miscellaneous/focusstacking/ex2_fig1.png" width=800 height=600 border=1><br>
	<font size=-1>Closest part of object</font>
</center><p>

<p align="justify">
</p>
<center>
   <img src="http://paulbourke.net/miscellaneous/focusstacking/ex2_fig2.png" width=800 height=600 border=1><br>
   <font size=-1>Furthest part of object</font>
</center><p>

<p align="justify">
Focus stacked image.
</p>
<center>
	<a href="http://paulbourke.net/miscellaneous/focusstacking/ex2_fig3.jpg">
   <img src="http://paulbourke.net/miscellaneous/focusstacking/ex2_fig3s.jpg" width=800 height=600 border=1><br>
   <font size=-1>Download or click to explore full resolution</font></a>
</center><p>

<b>Software</b><p>
<ul>
<li>Capture One Pro 9 from Sony was used to control, capture and export photographs.
No processing was performed on the photographs.
Care should be taken to disable the export filters, in particular the sharpen filter
on export is enabled by default.<p>
<li>HeliconFocus 6.6.1 from Helicon Software Ltd was used to perform the focus stacking.
Strangely it doesn't support PNG files, TIFF should be used in the export from Capture One Pro
rather than lossy JPG.
</ul>

<p align="justify">
</p>
<center>
   <a href="http://paulbourke.net/miscellaneous/focusstacking/ex2_fig4.jpg">
   <img src="http://paulbourke.net/miscellaneous/focusstacking/ex2_fig4s.jpg" width=800 height=600 border=1></a><br>
   <font size=-1>Greyscale depth map</font>
</center><p>

<p align="justify">
While the increased number of layers has improved from the first example, they are still discrete
layers capturing global curvature but not surface structure.
Quality of reconstructed surface is clearly inferior to other techniques, such as 3D reconstruction. Additionally it is only from one view position. However it may provide better results for surfaces not suited to 3D reconstruction such as highly reflective/specular surfaces.
</p>
<p align="justify">
One might ask if focus stacking can be used to create photographs that are then used for
3D reconstruction. The answer is definitely yes but the automated approach used here
would not be suitable due the focus breathing and the resulting variation in the focus
stacked images.
</p>
<center>
   <a href="http://paulbourke.net/miscellaneous/focusstacking/ex2_fig5.png">
   <img src="http://paulbourke.net/miscellaneous/focusstacking/ex2_fig5s.png" width=800 height=352 border=1></a><br>
   <font size=-1>3D model</font>
</center><p>
<p><br><br><p>

<center>
<h1>Image mosaicking with the Phase One</h1>
Written by <a href="../index.html">Paul Bourke</a><br>
April 2016
<p><br><p>
</center>

<p align="justify">
The following documents some experiments aimed at evaluating the high
fidelity capture of artworks using, at the time, the newly released Phase One camera. 
The Phase One is the most recent medium format camera from Sony with a 100MPixel back.
There are a number of
reasons why the Phase One was chosen for these tests, these include the high resolution sensor
so fewer images need to be acquired for the same final
stitched resolution, high dynamic range, availability of a high quality macro lens (in this
case a 120mm macro lens). There are some other unique characteristics
of the camera such as the seismometer
to ensure photographs are only taken when the camera is steady.
</p>

<p><br><p>

<b>Example 1</b>

<p align="justify">
Two artworks 
works were chosen, the first is a relatively flat painting (700mm across) but one with strong
repeating patterns. This was chosen to test for any stitching issues. The aim in this
case was to achieve a scan resolution of 1200DPI (approximately 50dots per mm).
The final mosaic consisted of 4 photographs wide and 3 photographs high, each
photograph from the Phase One is 11600x8700 pixels and an approximate 30% overlap was 
aimed for.
</p>

<center>
	<img src="http://paulbourke.net/miscellaneous/focusstacking/figure1.png" width=800 height=1422 border=0><br>
	<font size=-1>Global and zoomed in detail of dot painting</font>
</center><p>

<p><br><p>

<b>Example 2</b>
<p align="justify">
The second example is a smaller piece, 300mm on each side, but it consisted of some
degree of roughness in the form of up to 5mm raised oil paint strokes. The aim in this
example was to scan at 2400DPI (approximately 100 dots per mm), 15 photographs in a 3x5
grid were acquired.
</p>

<center>
   <img src="http://paulbourke.net/miscellaneous/focusstacking/figure2.png" width=800 height=608 border=0><br>
	<font size=-1>Phase One and two area lights (turned off here)</font>
</center><p>

<p align="justify">
A discussion of the lighting is out of the scope of this document and indeed was not optimised
for the tests conducted here.
</p>

<center>
   <img src="http://paulbourke.net/miscellaneous/focusstacking/figure3.png" width=800 height=1781 border=0><br>
	<font size=-1>Global photograph and zoomed in view of second example</font>
</center><p>

<p align="justify">
There are a number of ways to deal with the narrow depth of focus of these macro
lenses, noting that these photographs were already taken at f16 which is considered
the limit 
for the lens in question before one strikes diffraction issues. One approach is focus stacking, for
notes on evaluating this with the same camera see <a href="index.html">here</a>.
</p>

<p align="justify">
As the surface depth increases a tiled mosaic style capture becomes a less complete
means for capturing the artwork. One is essentially recording a planar projection of
a 2.5D surface.
Not only does increased depth have implications for focus but also on lighting. 
One approach to address this is to capture the geometry of the surface through photogrammetric
methods.
The following is a surface representation acquired using the same camera, during the
same shooting process. 15 photographs were taken, all from different positions and angles
to the artwork. 
</p>

<center>
   <img src="http://paulbourke.net/miscellaneous/focusstacking/figure4.png" width=800 height=1876 border=0><br>
	<font size=-1>Surface representation with side lighting to illustrate the surface features</font>
</center><p>

<p align="justify">
The pipeline is to mosaic the high resolution image with highly diffuse lighting.
This high resolution image is then co-registered with the surface model from the 3D 
reconstruction.
Lighting of the artwork by different lighting scenarios
can then be simulated by standard computer graphics lighting models and rendering methods.
</p>

<center>
	<a href="http://paulbourke.net/miscellaneous/focusstacking/figure5.png">
   <img src="http://paulbourke.net/miscellaneous/focusstacking/figure5.png" width=800 height=390 border=0></a><p>
	<a href="http://paulbourke.net/miscellaneous/focusstacking/figure6.png">
   <img src="http://paulbourke.net/miscellaneous/focusstacking/figure6.png" width=800 height=390 border=0></a>
   <font size=-1>Artificial lighting scenarios</font>
</center><p>

<p align="justify">
An outstanding missing acquisition are material properties, for example, diffuse and reflective
components that in general are also angle dependent.
Capturing BDRF (Bidirectional reflectance distribution functions)
at the scale of a large art work is highly problematic.
</p>

<br><br>

<center>
<h1>Focus Stacking with the Lumix GH5</h1>
Written by <a href="../index.html">Paul Bourke</a><br>
June 2017
<p><br><p>
</center>

<p align="justify">
Focus stacking is the process by which multiple photographs, each with a different focal plane,
are combined into a single image with an overall deeper depth of focus. The most common application
is in macro photography where the object is close to the lens and the depth of focus does
not extend across the depth of the object. While using limited depth of focus is often an
artistic/composition choice, there are other applications such as digital recording for archive purposes
where having all depths in focus is desirable.
The interest for the author is the photography of small small objects for the purpose
of 3D reconstruction.
</p>

<p align="justify">
The Lumix GH5 has two built-in focus stacking modes they both automatically scan across the focus range.
In one mode (focus stacking) one can save individual frames by choosing focus depth, or merge the images in the camera
to achieve a wide focus range.
In addition to the individual images one might save, the result in the form of a mp4 movie 
is saved on the SD card. This makes one suspect the image quality 
may not be as good (probably using the 4:2:2 or 4:2:0 compression the other video modes
use).
</p>

<b>Examples</b><p>

<p align="justify">
</p>
<center><table width=100%><tr><Td align="center">
	<a href="http://paulbourke.net/miscellaneous/focusstacking/1frontfocus.jpg">
	<img src="http://paulbourke.net/miscellaneous/focusstacking/1frontfocuss.jpg" width=200 height=709 border=1></a><br>
	<font size=-1>Near focus</font>
</td><td align="center">
	<a href="http://paulbourke.net/miscellaneous/focusstacking/2backfocus.jpg">
   <img src="http://paulbourke.net/miscellaneous/focusstacking/2backfocuss.jpg" width=200 height=709 border=1></a><br>
   <font size=-1>Distant focus</font>
</td><td align="center">
	<a href="http://paulbourke.net/miscellaneous/focusstacking/3combined.jpg">
   <img src="http://paulbourke.net/miscellaneous/focusstacking/3combineds.jpg" width=200 height=709 border=1></a><br>
   <font size=-1>In camera focused image</font>
</td></tr></table></center><p>

<center><table width=100%><tr><Td align="center">
   <a href="http://paulbourke.net/miscellaneous/focusstacking/remote1.jpg">
   <img src="http://paulbourke.net/miscellaneous/focusstacking/remote1s.jpg" width=250 height=417 border=1></a><br>
   <font size=-1>Near focus</font>
</td><td align="center">
   <a href="http://paulbourke.net/miscellaneous/focusstacking/remote2.jpg">
   <img src="http://paulbourke.net/miscellaneous/focusstacking/remote2s.jpg" width=250 height=417 border=1></a><br>
   <font size=-1>Distant focus</font>
</td><td align="center">
   <a href="http://paulbourke.net/miscellaneous/focusstacking/remote3.jpg">
   <img src="http://paulbourke.net/miscellaneous/focusstacking/remote3s.jpg" width=250 height=417 border=1></a><br>
   <font size=-1>In camera focused image</font>
</td></tr></table></center><p>

<p align="justify">
In the other mode one can choose the number of focus steps and the separation between each step,
this is accessed through the focus bracketing mode.
Unfortunately this separation is in some undocumented step so some trial and error is required.
In this mode one just gets N images, one at each focus setting, and use a third party focus
stacking software to combine the images.
</p>

<b>Examples</b><p>
<p align="justify">
In the following examples, two lenses are used, a 100mm macro attached to the camera and a 50mm prime
attached in reverse to the 100mm lens.
</p>
<center>
   <a href="http://paulbourke.net/miscellaneous/focusstacking/beetle50.jpg">
   <img src="http://paulbourke.net/miscellaneous/focusstacking/beetle50s.jpg" width=800 height=533 border=1></a><br>
</center><p><br>
<center>
   <a href="http://paulbourke.net/miscellaneous/focusstacking/curl1.jpg">
   <img src="http://paulbourke.net/miscellaneous/focusstacking/curl1s.jpg" width=800 height=533 border=1></a><br>
</center><p><br>
<center>
   <a href="http://paulbourke.net/miscellaneous/focusstacking/gh5.jpg">
   <img src="http://paulbourke.net/miscellaneous/focusstacking/gh5s.jpg" width=800 height=600 border=1></a><br>
</center><p><br>

<center>
   <a href="http://paulbourke.net/miscellaneous/focusstacking/spider6.jpg">
   <img src="http://paulbourke.net/miscellaneous/focusstacking/spider6_s.jpg" width=800 height=533 border=1></a><br>
</center><p><br>

<center>
   <a href="http://paulbourke.net/miscellaneous/focusstacking/spider13.jpg">
   <img src="http://paulbourke.net/miscellaneous/focusstacking/spider13_s.jpg" width=800 height=600 border=1></a><br>
</center><p><br>

<br><br>

<center>
<h1>Experiments with the GoPro cameras</h1>
Written by <a href="../index.html">Paul Bourke</a><br>
June 2011<p>
<p align="justify">
Please note the following applies to the GoPro HD Hero released early in 2011.
The specifications for the GoPro HD Hero2 are different.
</p>
</center>
<p><br><p>

<p align="justify">
The small GoPro cameras gained rapidly in popularity during 2011, and found uses in
areas other than for what they were originally intended, namely an action sports camera.
For example,
being light and self contained they were used on kites and remote miniature helicopters
for aerial photography. Having relatively wide angle lens they also caught the interest
of those capturing panoramic video, the following briefly notes some activities 
by the author in that area during 2011.
</p>

<p align="justify">
The camera is both a still, time lapse, and full 1080 HD video camera. In video mode
it uses a portion of the sensor as shown below, and a correspondingly narrower field of view.
</p>
<img src="http://paulbourke.net/miscellaneous/focusstacking/optical.jpg" width=800 height=611 border=0>
<p>

<p align="justify">
Example of three shots with the cameras aligned horizontally. (Click for higher resolution).
The pipeline here generally involves an image rectification (turning the lens distorted image
into a pure pinhole camera), followed by colour histogram matching, and finally a stitching/blending
of the images together. This last stage can be performed purely on a geometric basis or by
doing an initial feature point extraction between pairs of images and using that to perform
the stitching.
</p>
<a href="http://paulbourke.net/miscellaneous/focusstacking/horizontal.jpg"><img src="http://paulbourke.net/miscellaneous/focusstacking/horizontal_s.jpg" width=800 height=425 border=0></a><br>

<p align="justify">
Example of seven shots with the cameras aligned vertically. (Click for higher resolution)
</p>
<a href="http://paulbourke.net/miscellaneous/focusstacking/vertical.jpg"><img src="http://paulbourke.net/miscellaneous/focusstacking/vertical_s.jpg" width=800 height=560 border=0></a><br>

<p align="justify">
Mount for multiple camera rig designed for 360 degree video panorama
(Click for higher resolution).
Six cameras gave 360 degrees with easily enough overlap for blending/stitching.
</p>
<a href="http://paulbourke.net/miscellaneous/focusstacking/mount.jpg"><img src="http://paulbourke.net/miscellaneous/focusstacking/mount_s.jpg" width=800 height=802 border=0></a><br>

<p align="justify">
Sample QuickTime movie (scaled down to 1024 pixels wide).
Vertical field of view approximately 50 degrees, note cameras are mounted horizontally.
The black portion masked out on the left and right hides the cyclist, performed in
post production.
The biggest impediment to a high quality result are artefacts arising from the rolling
shutter of the camera. This essentially means that time at the top of the frame is not
the same as time at the bottom of the frame. This places an upper limit in stitching
quality when the camera or objects in the scene move rapidly.
This is in addition to the stitching errors that inevitably arise from the cameras not
all having the same nodal point, this is only solved by mounting the cameras pointing upwards
say and having mirrors to reflect the FOV onto the horizontal. Such a system can align the
nodal points of the cameras to a single point.
</p>
<a href="http://paulbourke.net/miscellaneous/focusstacking/quadbike_1024_15fps.mov"><img src="http://paulbourke.net/miscellaneous/focusstacking/sampleframe.jpg" width=800 height=124 border=1></a>
<p>

Instructions (full): <a href="http://paulbourke.net/miscellaneous/focusstacking/instructionsfull.pdf">instructionsfull.pdf</a><br>
Instructions (summary): <a href="http://paulbourke.net/miscellaneous/focusstacking/instructionsummary.pdf">instructionsummary.pdf</a><br>
Cable: <a href="http://paulbourke.net/miscellaneous/focusstacking/cable.png">cable.png</a><br>
<p>

</td></tr></table></center><p>

</body>
</html>

