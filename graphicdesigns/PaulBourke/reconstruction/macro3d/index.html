<html>
<head>
<link rel=StyleSheet href="../../pdbstyle.css" type="text/css" media=all>
<title>Extreme Macro 3D Reconstruction</title>
</head>
<body>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<script language="JavaScript">
<!--
   if (self.location.href != top.location.href) {
      top.location.href = self.location.href;
   }
-->
</script>


<center><table width=800><tr><td>

<center>
<h1>Extreme Macro 3D Reconstruction</h1>
<b>Software: MetashapePro</b><br>
Written by <a href="../index.html">Paul Bourke</a><br>
June 2019<p>
<a href="http://paulbourke.net/reconstruction/macro3d/index_bu.html">Bulgarian translation</a> by Zlatan Dimitrov.
</center><p><br><p>

<b>Introduction</b><p>

<p align="justify">
The following documents an exercise to 3D reconstruct 22 small shell beads that were
used to form a necklace, the paper describing the objects can be found
<a href="http://paulbourke.net/reconstruction/macro3d/paper.pdf">here</a>. The approach taken is a photographic one, often referred
to as photogrammetry, the MetaShape software was employed.
The beads ranged in size from 4mm to 20mm.
</p>

<p align="justify">
A highly desirable aim for photographic reconstruction is sharp in focus images and good
depth of focus, but depth of focus is exactly what one does not have with macro
photography. 
One solution to this is to <a href="../../miscellaneous/macrophotography/index.html">focus stack</a>, 
combining multiple photographs
each with a different in focus depth range. For this project this approach was ruled
out due to the extreme capture times it would require as well as increased post
production times. For example, the single photograph per position approach used took
on average 1 hour per object, focus stacking would have extended this by at least a factor
of 4. Post production would require an additional step although it could be largely
automated.
</p>

<b>Camera rig</b><p>

<p align="justify">
The initial camera rig consisted of the subject mounted on a plastic block, a 100mm
Canon macro lens, and linear macro slider. 
</p>

<center>
	<a href="http://paulbourke.net/reconstruction/macro3d/macro1.jpg"><img src="http://paulbourke.net/reconstruction/macro3d/macro1s.jpg" width=600 height=800 border=1></a><br>
	<smalltext>Initial test camera set up</smalltext>
</center><p>

<p align="justify">
While this was functional for larger objects (15mm to 20mm on the full frame sensor) it suffered
from a number of issues: the linear macro rail involved coarse and time consuming
left/right alignment using the tripod head controls, and the 100mm macro lens is still
at best a 1:1 lens so not ideal for the smaller objects of or under
10mm where typically less than 1/4 of the sensor would be utilised.
</p>
<p align="justify">
The final solution involved a 2 axis macro rail, left and right for alignment and 
forward-back 
for focus. The final lens was a Canon 65mm macro with between 1:1 and 5:1 magnification,
although for these objects no more than 3:1 magnification was actually used. 
</p>

<center>
   <img src="http://paulbourke.net/reconstruction/macro3d/canon.jpg" width=300 height=400 border=0><br>
	<smalltext>Canon MP-E 65mm lens</smalltext>
</center><p>

<p align="justify">
There are
alternatives to purchasing a relatively unusual 5:1 magnification lenses, for example
the <a href="../../miscellaneous/macrophotography/index.html">reverse lens approach</a>.
</p>

<center>
   <a href="http://paulbourke.net/reconstruction/macro3d/macro2.jpg"><img src="http://paulbourke.net/reconstruction/macro3d/macro2s.jpg" width=800 height=676 border=1></a><br>
	<smalltext>Final camera set up</smalltext>
</center><p>

<p align="justify">
Since a full 3D model is required, the objects were each photographed in two orientations
with typically 
at least 30% overlap. The shape of each object varies and different mounting arrangements
were employed for each shape type. Critical of course is for the object not to move
during a scan, although small vibration induced movement can be tolerated as it 
corresponds to a camera shift or tilt.
</p>

<p align="justify">
A light box was used to both give higher levels of light so that a small aperture
(increased depth of focus) can be achieved. It also removes lighting effects on the
objects themselves allowing maximum opportunity to relight in the presentation renderings.
</p>

<center>
   <a href="http://paulbourke.net/reconstruction/macro3d/shell1.jpg"><img src="http://paulbourke.net/reconstruction/macro3d/shell1s.jpg" width=800 height=676 border=1></a><br>
	<smalltext>Typical image and size on sensor</smalltext>
</center><p>

<b>Capture</b><p>

<p align="justify">
For 1:1 and 2:1 magnification, there was sufficient overlap of in focus regions and
therefore sufficient feature point overlap by taking 20 degree steps in longitude and performing
four 360 rings in latitude. Since the latitude range was typically 0 (equator) to 80
degrees this is also a 20 degree step size in latitude.
In many case for the highest latitude only 30 degree steps were needed for
sufficient overlap. Therefore each half scan required either 66 or 72 photographs.
The camera was the Canon 5D Mk III (full frame).
</p>

<p align="justify">
The automatic rotation was achieved with the Edelkrone Head One rotator unit. 
</p>

<center>
   <img src="http://paulbourke.net/reconstruction/macro3d/edelkrone1.jpg" width=400 height=258 border=0></a><br>
   <smalltext>Edelkrone Head One rotator</smalltext>
</center><p>

<center>
	<table><tr><td>
   	<img src="http://paulbourke.net/reconstruction/macro3d/edelkrone3.jpg" width=300 height=616 border=0></a>
	</td><td>
   	<img src="http://paulbourke.net/reconstruction/macro3d/edelkrone2.jpg" width=300 height=616 border=0></a><br>
	</td></tr></table>
   <smalltext>Edelkrone Head One software interface</smalltext>
</center><p>

<p align="justify">
There was sufficient light in the light box for the maximum f16 aperture, while still
maintaining a reasonable ISO 200 and 1/20 shutter speed. On each shot a decision was
made as to the region to focus on, generally due to the shape of the object this was
the closest surface to the camera. The macro rail was used to focus since this lens
has no automatic focus capability. Even with automatic focus, macro lenses generally
have significant focus breathing which is varying the focal length for each shot,
not a good idea for 3D reconstruction algorithms.
</p>

<p align="justify">
Finally, after focussing using a zoomed view on the LCD display, the shot was taken
after any vibration had settled down. On average this whole process for a single shot
took 15 seconds.
</p>

<p align="justify">
In summary the process involves first setting the tripod height for the upcoming
latitude scan, then for each longitude position:
</p>
<ul>
<li>Press button on mobile phone to advance the rotator by 20 degrees<p>
<li>Press the zoom in button on the camera LCD display<p>
<li>Align the object on the sensor using the horizontal slider of the macro rail<p>
<li>Focus using the in/out slider on the macro rail<p>
<li>Wait for the system vibrations to settle<p>
<li>Take the photograph with the cabled remote<p>
</ul><p>

<b>Processing</b><p>

<p align="justify">
The upper and lower halves after the camera alignment process are shown below.
Due to the shallow depth of focus, in general anything not on the object was well
out of focus and no feature points were found. As such in most cases masking
was not required saving a significant amount of human time.
</p>
<center>
	<a href="http://paulbourke.net/reconstruction/macro3d/macro3.jpg"><img src="http://paulbourke.net/reconstruction/macro3d/macro3s.jpg" width=800 height=552 border=1></a><br>
	<smalltext>First side</smalltext>
</center><p>
<center>
   <a href="http://paulbourke.net/reconstruction/macro3d/macro4.jpg"><img src="http://paulbourke.net/reconstruction/macro3d/macro4s.jpg" width=800 height=552 border=1></a><br>
	<smalltext>Second side</smalltext>
</center><p>

<p align="justify">
In general there was not sufficient overlap between the two halves for an automatic
point based alignment and merge. Instead a number of matching markers were identified on
each half and an alignment and merge by marker performed. Example shown below.
</p>

<center>
   <a href="http://paulbourke.net/reconstruction/macro3d/macro6.jpg"><img src="http://paulbourke.net/reconstruction/macro3d/macro6s.jpg" width=800 height=361 border=1></a><br>
	<smalltext>Markers shown on untextured mesh</smalltext>
</center><p>

<p align="justify">
The following shows the merged camera sets.
In general better results were obtained by recomputing the dense point cloud after
the merging process.
</p>

<center>
   <a href="http://paulbourke.net/reconstruction/macro3d/macro5.jpg"><img src="http://paulbourke.net/reconstruction/macro3d/macro5s.jpg" width=800 height=552 border=1></a><br>
	<smalltext>Merged camera sets</smalltext>
</center><p>

<p align="justify">
Finally the merged model.
</p>

<center>
   <a href="http://paulbourke.net/reconstruction/macro3d/macro7.jpg"><img src="http://paulbourke.net/reconstruction/macro3d/macro7s.jpg" width=800 height=518 border=1></a><br>
	<smalltext>Untextured and textured final model</smalltext>
</center><p>

<p align="justify">
Typical project summary might be as follows.
</p>
<center>
   <img src="http://paulbourke.net/reconstruction/macro3d/macro8.jpg" width=500 height=388 border=0></a>
</center><p>


<br><b>Notes</b><p>

<ul>

<li><p align="justify">
The reconstruction software had a high chance of failing
if two photographs were taken from very similar
positions. It was imagined for some objects that one could focus on the front surface
and then take another photograph from a slightly different position focussing on the 
back surface. This would generally fail. If a front and back focus photograph set
was necessary then better to change the camera position, for example, raise or
lower slightly.
</p>

<li><p align="justify">
While the choice of MetaShape has been successful, there is some frustration at the
seemingly non-deterministic nature at times during the photograph alignment phase. Alignment
would fail sometimes and changing very little (if anything) and it would then succeed.
The choice of whether to select all parameters as "photo-invariant" seemed to be required
for some image sets and yet would fail on others, despite the same camera, lens and
technique being used.
</p>

<li><p align="justify">
A lens calibration did not seem to make any difference to the results, indeed the results
were often inferior.
</p>

<li><p align="justify">
While the Edelkrone Head One performed flawlessly, there were some annoying limitations
to their software. The software "philosophy" seems to be to present fewer features, the
sense was it was created for novice users only. The author on the other hands suggests
that very few customer for this device are novice.
</p>

</ul>

<!--
<p align="justify">
The final 22 beads can be found on
<a href="https://vimeo.com/341921689">Vimeo</a>. The background Mandu cave courtesy
Peter Morse.
</p>
-->

</td></tr></table></center>
<p><br><br><p>
</body>
</html>

